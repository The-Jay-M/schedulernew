<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISOD Staff Scheduling System</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- XLSX for Excel import/export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <!-- HTML2Canvas and html2pdf for capturing and generating PDFs -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Shepherd for onboarding tutorial -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@9.1.1/dist/css/shepherd.css" />
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@9.1.1/dist/js/shepherd.min.js"></script>
    <!-- DataTables for enhanced table functionality -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <!-- SortableJS for drag-and-drop functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
:root {
        --dark-blue: #1a2a3a;
        --yellow: #329208;
        --text-color: #ffffff;
        --border-color: rgba(255, 255, 255, 0.2);
        --highlight-color: rgba(255, 215, 0, 0.2);
        --supervisor-color: #ff4500;
        --morning-color: #87CEEB;
        --midmorning-color: #00CED1;
        --afternoon-color: #FFA500;
        --night-color: #4B0082;
        --overlay-bg: rgba(26, 42, 58, 0.95);
        --button-hover: #e6c200;
        --table-header: rgba(255, 255, 255, 0.1);
        --week-separator-bg: var(--yellow);
        --week-separator-text: var(--dark-blue);
    }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--dark-blue);
            color: var(--text-color);
            font-size: 14px;
            background-image: url('https://pfst.cf2.poecdn.net/base/image/2ee0c5b959e51b25b9c8df43d2b4498a32304a9f173f78b251faf1850dc9e2cf?w=1024&h=576&pmaid=160532020');
            background-size: cover;
            background-attachment: fixed;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--overlay-bg);
            z-index: -1;
        }
        .container {
            max-width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }
        h1, h2 {
            color: var(--yellow);
            margin: 10px 0;
            text-align: center;
        }
        input, select, button, textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: none;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-size: 14px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--yellow);
        }
        button {
            background-color: var(--yellow);
            color: var(--dark-blue);
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: var(--button-hover);
        }
        .scroll-container {
            display: flex;
            overflow-x: auto;
            padding: 5px 0;
            gap: 5px;
        }
        .scroll-item {
            flex: 0 0 auto;
            padding: 5px 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        .scroll-item.active {
            background-color: var(--yellow);
            color: var(--dark-blue);
        }
        .staff-card {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 8px;
            margin-right: 5px;
            min-width: 150px;
            font-size: 12px;
        }
        .staff-card h3 {
            margin: 0 0 5px 0;
            font-size: 14px;
        }
        .supervisor {
            color: var(--supervisor-color);
            font-weight: bold;
        }
        .schedule-container {
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-top: 10px;
            max-height: 600px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            background-color: var(--dark-blue);
            color: var(--text-color);
            font-size: 12px;
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 5px;
            text-align: center;
            vertical-align: middle;
        }
        th {
            background-color: var(--table-header);
            position: sticky;
            top: 0;
            z-index: 2;
        }
        .editable:focus {
            background-color: rgba(255, 255, 255, 0.2);
            outline: none;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        .overlay-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--dark-blue);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            font-size: 24px;
            color: var(--text-color);
        }
        .preference-container {
            margin-bottom: 10px;
        }
        .preference-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        .preference-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--yellow);
            cursor: pointer;
            box-shadow: 0 0 0 3px var(--dark-blue), 0 0 0 6px var(--yellow);
        }
        .preference-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--yellow);
            cursor: pointer;
            box-shadow: 0 0 0 3px var(--dark-blue), 0 0 0 6px var(--yellow);
        }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .add-icon {
            cursor: pointer;
            font-size: 16px;
            color: var(--yellow);
        }
        .warninga {
            background-color: rgba(255, 215, 0, 0.2);
            border: 1px solid var(--yellow);
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .warning {
            background-color: rgba(255, 215, 0, 0.2);
            border: 1px solid var(--yellow);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .supervisor-select {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .supervisor-option {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        .supervisor-option.selected {
            background-color: var(--yellow);
            color: var(--dark-blue);
        }
        .calendar-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .calendar-bar input[type="date"] {
            background-color: transparent;
            border: none;
            color: var(--text-color);
            font-size: 12px;
        }
        /* Updated search container styles */
        .search-container {
            position: relative;
            margin-bottom: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .search-container input {
            padding-left: 25px;
        }
        .search-icon {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color);
            font-size: 12px;
        }
        /* Add these styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }


        .chat-toggle, .chat-close {
            background: none;
            border: none;
            color: var(--yellow);
            font-size: 24px;
            cursor: pointer;
        }
        .hamburger {
            font-size: 24px;
            cursor: pointer;
            color: var(--yellow);
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--dark-blue);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            right: 0;
        }
        .dropdown-content a {
            color: var(--text-color);
            padding: 10px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .dropdown-content a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
        .cycle-setter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .cycle-setter i {
            font-size: 20px;
            color: var(--yellow);
        }
        .department-shift-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .department-shift-section {
            margin-bottom: 10px;
        }
        .highlighted {
            background-color: var(--highlight-color);
        }
        .week-separator {
            background-color: var(--week-separator-bg);
            color: var(--week-separator-text);
            font-weight: bold;
            text-align: center;
            padding: 8px;
            font-size: 16px;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        .preference-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .preference-input input[type="number"] {
            width: 60px;
        }
        .previous-generations {
            display: flex;
            overflow-x: auto;
            padding: 10px 0;
            gap: 10px;
        }
        .generation-item {
            flex: 0 0 auto;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            position: relative;
            transition: background-color 0.3s;
        }
        .generation-item:hover {
            background-color: rgba(255, 215, 0, 0.3);
        }
        .generation-item .trash-icon {
            color: var(--yellow);
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
        }
        .staff-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            background-color: var(--supervisor-color);
            color: var(--text-color);
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            margin: 2px;
            cursor: pointer;
        }
        .progress-bar {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            height: 5px;
            margin-top: 5px;
        }

        .progress {
            height: 100%;
            background-color: green;
            transition: width 0.3s ease;
        }
        .active-users {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .active-user {
            display: inline-block;
            margin-right: 10px;
            padding: 5px 10px;
            background-color: var(--yellow);
            color: var(--dark-blue);
            border-radius: 15px;
            font-size: 12px;
        }
        .feedback-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--dark-blue);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            display: none;
        }
        .feedback-container textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
        }
        .feedback-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--yellow);
            color: var(--dark-blue);
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        .batch-update-container {
            margin-bottom: 20px;
        }
        .batch-update-container select, .batch-update-container input {
            margin-right: 10px;
            width: auto;
        }
        .error-message {
            color: #ff6b6b;
            margin-top: 5px;
            font-size: 12px;
        }
        .success-message {
            color: #51cf66;
            margin-top: 5px;
            font-size: 12px;
        }
        .sortable {
            cursor: pointer;
        }

        .sortable:hover {
            background-color: var(--highlight-color);
        }

        .selected {
            background-color: var(--highlight-color);
        }

        .totals-row {
            font-weight: bold;
            background-color: var(--table-header);
        }
        .staff-name {
            display: inline-block;
            margin-right: 5px;
            font-size: 12px;
        }
        .supervisor {
            font-weight: bold;
            color: #ff4500;
        }

        .schedule-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            cursor: pointer;
        }

        .tab-button.active {
            border-bottom: 2px solid var(--yellow);
        }

        .tab-content {
            padding: 20px;
        }

        body.dark-mode {
            background-color: #201e22;
            color: #fff;
        }

        body.dark-mode .card,
        body.dark-mode .overlay-content {
            background-color: #1c1c1c;
        }

        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode button {
            background-color: #0f0f0f;
            color: #fff;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: var(--dark-blue);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            width: 80%;
            max-width: 900px;
            border-radius: 10px;
        }

        .close {
            color: var(--text-color);
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: var(--yellow);
            text-decoration: none;
            cursor: pointer;
        }

        .search-replace-container {
            margin-bottom: 10px;
        }

        .search-replace-container input {
            margin-right: 10px;
        }

        .expand-icon {
            cursor: pointer;
            font-size: 20px;
            color: var(--yellow);
        }

        /* Settings Modal Styles */
        /* Updated settings modal styles */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
            display: none;
        }

        .settings-content {
            background-color: var(--dark-blue);
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
        }


        .settings-header {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Highlight style for search results */
        .highlight-cell {
            background-color: rgba(91,0,255,0.3) !important;
        }

        /* Find All results container */
        .find-all-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .back-arrow {
            font-size: 24px;
            margin-right: 20px;
            cursor: pointer;
            color: var(--yellow);
        }

        .settings-content {
            padding: 20px;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h2 {
            margin-bottom: 15px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .setting-icon {
            font-size: 20px;
            margin-right: 15px;
            color: var(--yellow);
        }

        /* Update the about overlay styles */
        .about-overlay {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background-color: var(--dark-blue);
            transition: right 0.3s ease-in-out;
            z-index: 1001;
            overflow-y: auto;
        }

        .about-content {
            padding: 20px;
            color: var(--text-color);
        }

        .about-overlay.active {
            right: 0;
        }

        /* Tooltip Styles */
        .tooltip {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: var(--dark-blue);
            color: var(--text-color);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            font-size: 14px;
            max-width: 250px;
        }
        
        /* Login Modal */
                /* Login Modal Styles */
        .login-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }
             .login-modal-content {
            background-color: var(--dark-blue);
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            color: var(--text-color);
        }
                /* Chat System Styles */
        .chat-system {
	          display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 400px;
            background-color: var(--dark-blue);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
    
.chat-content {
    display: none;
}


        #scheduleTable {
            width: 100%;
            border-collapse: collapse;
        }
        #scheduleTable th, #scheduleTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #scheduleTable th {
            background-color: #f2f2f2;
        }
        #scheduleTable th {
            background-color: #480e83;
            color: #333;
        }
        .week-separator {
            background-color: #e6f2ff;
            font-weight: bold;
            text-align: center;
        }
        .shift-cell {
            max-width: none;
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
        }
        mark {
            background-color: #00ff90;
            color: #9d38fc;
        }

        .group {
            background-color: var(--week-separator-bg);
            font-weight: bold;
        }
        .tutorial-highlight {
            box-shadow: 0 0 0 2px var(--yellow);
        }
        
        /* new header styles */
        
        
        .header-icon {
            font-size: 24px;
            color: var(--yellow);
            cursor: pointer;
        }

        
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }
        
                .greeting-ad-carousel {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .carousel-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .carousel-item.active {
            opacity: 1;
        }

        .carousel-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }


        /* New styles for the chat bar */
        .chat-bar {
            width: 300px;
            height: 100%;
            position: fixed;
            top: 0;
            left: -300px;
            background-color: var(--dark-blue);
            transition: left 0.3s ease-in-out;
            z-index: 1000;
        }

        .chat-bar.open {
            left: 0;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--yellow);
            color: var(--dark-blue);
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-input {
            display: flex;
            padding: 10px;
        }
        .chat-input input {
            flex-grow: 1;
            margin-right: 10px;
        }
        
                /* Fancy Alert Box Styles */
        .fancy-alert {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--dark-blue);
            color: var(--text-color);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Centaur Badge */
        .centaur-badge {
            background-color: var(--yellow);
            color: var(--dark-blue);
            padding: 2px 5px;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 5px;
        }

        .chat-input button {
            background-color: transparent;
            border: none;
            color: var(--yellow);
            font-size: 20px;
            cursor: pointer;
        }

        .ad-carousel {
            position: relative;
            width: 100%;
            height: 200px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .ad-container {
            width: 100%;
            height: 100%;
        }

        .ad-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ad-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: var(--yellow);
            color: var(--dark-blue);
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }

        /* Styles for the stats table */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .stats-table th, .stats-table td {
            border: 1px solid var(--border-color);
            padding: 5px;
            text-align: center;
        }

        .stats-table tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .stats-iframe {
            width: 100%;
            height: 400px;
            border: none;
        }

        .refix-button {
            background-color: var(--yellow);
            color: var(--dark-blue);
            border: none;
            padding: 2px 5px;
            cursor: pointer;
            font-size: 10px;
        }

        .greeting-carousel {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .greeting-content {
            display: flex;
            flex-direction: column;
        }

        .greeting-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .greeting-date {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .greeting-message {
            font-size: 32px;
            font-style: italic;
        }

        .greeting-toggle {
            background: none;
            border: none;
            color: var(--yellow);
            font-size: 18px;
            cursor: pointer;
        }

.carousel-dots {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.5);
            margin: 0 5px;
            cursor: pointer;
        }

        .dot.active {
            background-color: white;
        }

        .forums-panel {
            position: fixed;
            left: -300px;
            top: 0;
            width: 300px;
            height: 100%;
            background-color: var(--dark-blue);
            transition: left 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }

        .forums-panel.open {
            left: 0;
        }

        .forums-header {
            padding: 10px;
            background-color: var(--yellow);
            color: var(--dark-blue);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .forums-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background-image: url('path/to/your/chat-background-image.jpg');
            background-size: cover;
        }

        .forums-input {
            display: flex;
            padding: 10px;
            background-color: rgba(255,255,255,0.1);
        }

        .forums-input input {
            flex-grow: 1;
            margin-right: 10px;
        }

        .forums-input button {
            background: none;
            border: none;
            color: var(--yellow);
            font-size: 20px;
            cursor: pointer;
        }

        .settings-panel {
            position: fixed;
            right: -300px;
            top: 0;
            width: 300px;
            height: 100%;
            background-color: var(--dark-blue);
            transition: right 0.3s ease-in-out;
        }

        .settings-panel.open {
            right: 0;
        }

@media (max-width: 1024px) {
            .schedule-container {
                max-height: 400px;
            }
        }
@media (max-width: 768px) {
            .cycle-setter {
                flex-direction: column;
                align-items: flex-start;
            }
            .calendar-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            .schedule-container {
                max-height: 300px;
            }
        }
@media (max-width: 600px) {
            .schedule-container {
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="main-header">
						
						<h1 class="header-icon">        🌵ISOD Staff Scheduler</h1>
            
            <button class="chat-toggle"
            onclick="toggleChatBar()"><i
            class="fas fa-paper-plane
            header-icon"></i></button>
            
            <div class="dropdown">
                <span class="hamburger header-icon">&#9776;</span>
                <div class="dropdown-content">
                    <a href="#" onclick="showImportOverlay()"><i class="fas fa-file-import"></i> Import Excel</a>
                    <a href="#" onclick="exportExcel()"><i class="fas fa-file-export"></i> Export Excel</a>
                    <a href="#" onclick="saveToFirebase()"><i class="fas fa-save"></i> Save Schedule</a>
                    <a href="#" onclick="loadFromFirebase()"><i class="fas fa-folder-open"></i> Load Schedule</a>
                    <a href="#" onclick="captureTableImage()"><i class="fas fa-camera"></i> Capture Table</a>
                    <a href="#" onclick="generatePDF()"><i class="fas fa-file-pdf"></i> Generate PDF</a>
                    <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    <a href="#" onclick="skipLogin()"><i class="fas fa-forward"></i> Skip Login</a>
                    <a href="#" onclick="startTutorial()"><i class="fas fa-question-circle"></i> Start Tutorial</a>
                </div>
            </div>
            
            
        </div>
    </header>
    
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-modal-content">
            <h2>Login</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()">Login</button>
            <button onclick="showSignUpForm()">Sign Up</button>
            <button onclick="skipLogin()">Skip Login</button>
        </div>
    </div>



    <!-- Fancy Alert Box -->
    <div id="fancyAlert"
    class="fancy-alert"></div>
    

    <div id="loginForm" style="display: none;">
        <h2>Login</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <button onclick="showSignUpForm()">Sign Up</button>
        <button onclick="skipLogin()">Skip Login</button>
    </div>

    <div id="signUpForm" style="display: none;">
        <h2>Sign Up</h2>
        <input type="email" id="signUpEmail" placeholder="Email">
        <input type="password" id="signUpPassword" placeholder="Password">
        <button onclick="signUp()">Sign Up</button>
        <button onclick="showLoginForm()">Back to Login</button>
    </div>

    <div id="onboardingScreens" style="display: none;">
        <div id="onboardingContent">
            <!-- Onboarding content will be populated here -->
        </div>
        <div style="text-align: center;">
            <button onclick="prevOnboarding()">Previous</button>
            <button onclick="nextOnboarding()">Next</button>
            <button onclick="skipOnboarding()">Skip</button>
        </div>
    </div>

    <div id="mainContent" style="display: none;">
        <div class="active-users" id="activeUsers">
            <!-- Active users will be populated here -->
        </div>

        <div class="chat-bar" id="chatBar">
            <div class="chat-header">
                <span>Chat</span>
                <button class="chat-close" onclick="toggleChatBar()"><i class="fas fa-times"></i></button>
            </div>
            <!-- Rest of your chat bar content -->
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Type a message...">
                <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        <!--
            <div class="greeting-ad-carousel" id="greetingAdCarousel">
        <!-- Carousel items will be dynamically added here 
    </div> -->
    
    <div class="forums-panel" id="forumsPanel">
        <div class="forums-header">
            <span>Forums</span>
            <i class="fas fa-times" onclick="toggleForums()"></i>
        </div>
        <div class="forums-messages" id="forumsMessages"></div>
        <div class="forums-input">
            <input type="text" id="forumsInput" placeholder="Type a message...">
            <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            <button onclick="startVoiceInput()"><i class="fas fa-microphone"></i></button>
        </div>
    </div>
    
<div class="settings-panel" id="settingsPanel">
        <!-- Settings content -->
    </div>
    
				<!--
        <div class="ad-carousel">
            <div class="ad-container">
                <!-- Ad images will be inserted here dynamically 
            </div>
            <button class="ad-button">View Ad</button>
        </div> -->


        <!-- Add this before the
            department-shift-container -->
        <div class="greeting-carousel">
            <div class="greeting-content">
                <div class="greeting-date">
                    <i class="fas fa-calendar-alt"></i> <span id="currentDate"></span>
                </div>
                <div class="greeting-message" id="greetingMessage"></div>
            </div>
            <!--
            <div class="carousel-dots">
                <span class="dot active"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div> -->
        </div>

        <div class="card">
            <div class="department-shift-container">
                <div class="department-shift-section">
                    <div class="section-header">
                        <h2><i class="fas fa-building"></i> Departments</h2>
                        <i class="fas fa-plus-circle add-icon" onclick="showAddDepartmentOverlay()" title="Add Department"></i>
                    </div>
                    <div class="scroll-container" id="departmentScroll">
                        <!-- Department buttons will be populated here -->
                    </div>
                </div>
                <div class="department-shift-section">
                    <div class="section-header">
                        <h2><i class="fas fa-clock"></i> Shifts</h2>
                        <i class="fas fa-plus-circle add-icon" onclick="showAddShiftOverlay()" title="Add Shift"></i>
                    </div>
                    <div class="scroll-container" id="shiftScroll">
                        <!-- Shift buttons will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Add Staff</h2>
            <select id="departmentSelect">
                <option value="">Select Department</option>
                <!-- Department options will be populated here -->
            </select>
            <textarea id="quickAddStaff" placeholder="Enter comma-separated staff names (e.g., Tosin, Leke, Juwon, Isaac)" rows="3"></textarea>
            <button onclick="quickAddStaff()">Add Staff <i class="fas fa-user-plus"></i></button>
            <button onclick="showAddStaffOverlay()">Add Individual Staff</button>
            <button onclick="useDefaultStaff()">Use Default Staff Data</button>
        </div>

        <div class="card">
            <h2>Set Supervisors</h2>
            <div class="supervisor-select" id="supervisorSelect">
                <!-- Supervisor options will be populated here -->
            </div>
            <button onclick="setSupervisors()">Update Supervisors <i class="fas fa-user-shield"></i></button>
        </div>

        <div class="card">
            <h2>Staff List</h2>
            <div class="scroll-container" id="staffList">
                <!-- Staff cards will be populated here -->
            </div>
        </div>

        <div class="card">
            <div class="cycle-setter">
                <i class="fas fa-calendar-alt"></i>
                <select id="cycleDuration">
                    <option value="4">4 Weeks</option>
                    <option value="5">5 Weeks</option>
                </select>
                <span>Cycle</span>
                <button onclick="setCycleDuration()">Set Cycle</button>
            </div>

            <div class="calendar-bar">
                <input type="date" id="cycleStartDate">
                <span>to</span>
                <input type="date" id="cycleEndDate">
            </div>
        </div>

        <!-- Updated search container -->
        <div class="card">
            <h2>Current Schedule</h2>
            <div class="search-container">
                <!-- <i class="fas fa-search
                                               search-icon"></i>-->
                <input type="text" id="searchInput"
                placeholder="🔍    Search staff...">
                <button onclick="findNext()">Find Next</button>
                <button onclick="findAll()">Find All</button>
                <span id="searchResults"></span>
            </div>
            <div id="findAllResults" class="find-all-results" style="display: none;"></div>
        </div>
        <div id="warningContainer"></div>
        <div class="batch-update-container">
            <h3>Batch Update</h3>
            <select id="batchUpdateField">
                <option value="shift">Shift</option>
                <option value="department">Department</option>
            </select>
            <input type="text" id="batchUpdateValue" placeholder="New value">
            <button
                onclick="batchUpdate()">Update</button>
            <div
                id="batchUpdateMessage"></div>
        </div>
        <!-- Add this div for warnings -->
        <div id="warningContainer"></div>
        <div class="schedule-tabs">
            <button class="tab-button active" onclick="showTab('timetable')">Timetable</button>
            <button class="tab-button" onclick="showTab('stats')">Stats</button>
        </div>
        <div id="timetableTab" class="tab-content">

            <div class="schedule-container">
                <table id="scheduleTable">
                    <!-- Schedule table will be generated here -->
                </table>
            </div>
        </div>

        <div id="statsTab" class="tab-content" style="display: none;">
            <!-- Stats content will be dynamically generated here -->
        </div>
    </div>

    <button onclick="generateSchedule()">Generate Schedule <i class="fas fa-calendar-check"></i></button>
    <button onclick="resetAllStaff()">Reset All Staff</button>

    <div class="card">
        <h2>Previous Generations</h2>
        <div class="previous-generations" id="previousGenerations">
            <!-- Previous generations will be listed here -->
        </div>
    </div>
</div>
</div>

<!-- Overlays and Modals -->
<div class="overlay" id="preferencesOverlay">
<div class="overlay-content">
<span class="close-btn" onclick="closeOverlay('preferencesOverlay')">&times;</span>
<h2>Edit Preferences</h2>
<div id="preferencesContent"></div>
<button onclick="savePreferences()">Save Preferences</button>
</div>
</div>

<div class="overlay" id="addDepartmentOverlay">
<div class="overlay-content">
<span class="close-btn" onclick="closeOverlay('addDepartmentOverlay')">&times;</span>
<h2>Add Department</h2>
<input type="text" id="newDepartment" placeholder="Department Name">
<input type="text" id="newDepartmentAbbr" placeholder="Abbreviation">
<button onclick="addDepartment()">Add Department</button>
</div>
</div>

<div class="overlay" id="addShiftOverlay">
<div class="overlay-content">
<span class="close-btn" onclick="closeOverlay('addShiftOverlay')">&times;</span>
<h2>Add Shift</h2>
<input type="text" id="newShiftName" placeholder="Shift Name">
<input type="time" id="newShiftStart" placeholder="Start Time">
<input type="time" id="newShiftEnd" placeholder="End Time">
<input type="number" id="newShiftMinStaff" placeholder="Minimum Staff" min="1">
<button onclick="addShift()">Add Shift</button>
</div>
</div>

<div class="overlay" id="importOverlay">
<div class="overlay-content">
<span class="close-btn" onclick="closeOverlay('importOverlay')">&times;</span>
<h2>Import Excel</h2>
<input type="file" id="excelFile" accept=".xlsx, .xls">
<button onclick="importExcel()">Import</button>
</div>
</div>

<div class="overlay" id="addStaffOverlay">
<div class="overlay-content">
<span class="close-btn" onclick="closeOverlay('addStaffOverlay')">&times;</span>
<h2>Add New Staff</h2>
<input type="text" id="staffName" placeholder="Staff Name">
<select id="staffGender">
<option value="">Select Gender</option>
<option value="F">Female</option>
<option value="M">Male</option>
</select>
<select id="staffRole">
<option value="n">Normal</option>
<option value="s">Supervisor</option>
</select>
<input type="text" id="staffLanguage" placeholder="Language(s) Spoken">
<input type="date" id="staffPregnantUntil" placeholder="Pregnant Until (optional)">
<input type="date" id="staffLeaveStart" placeholder="Leave Start Date">
<input type="date" id="staffLeaveEnd" placeholder="Leave End Date">
<button onclick="addIndividualStaff()">Add Staff</button>
</div>
</div>

<div class="feedback-button" onclick="showFeedbackForm()">
Feedback
</div>
<div class="feedback-container" id="feedbackContainer">
<h3>Provide Feedback</h3>
<textarea id="feedbackText" placeholder="Enter your feedback here..."></textarea>
<button onclick="submitFeedback()">Submit Feedback</button>
<button onclick="closeFeedbackForm()">Close</button>
</div>

<div id="scheduleModal" class="modal">
<div class="modal-content">
<span class="close">&times;</span>
<div class="search-replace-container">
<input type="text" id="searchInput" placeholder="Search">
<input type="text" id="replaceInput" placeholder="Replace">
<button onclick="searchAndReplace()">Replace</button>
<div class="search-container">
<!-- <i class="fas fa-search
                           search-icon"></i>-->
<input type="text" id="searchInput"
placeholder="🔍    Search staff...">
<button onclick="findNext()">Find Next</button>
<button onclick="findAll()">Find All</button>
<span id="searchResults"></span>
</div>
<input type="range" id="zoomSlider"
min="50" max="150" value="100"
oninput="zoomTable(this.value)">
<span id="zoomValue">100%</span>
</div>
<div id="modalScheduleContainer"></div>
</div>
</div>

<!-- Updated settings modal -->
<div id="settingsModal" class="settings-modal">
<div class="settings-content">
<div class="settings-header">
<i class="fas fa-arrow-left back-arrow" onclick="closeSettingsModal()"></i>
<h2>Settings</h2>
</div>
<div class="settings-section">
<h2>General</h2>
<div class="setting-item">
<i class="fas fa-moon setting-icon"></i>
<span>Dark Mode</span>
<input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
</div>
<div class="setting-item">
<i class="fas fa-info-circle setting-icon"></i>
<span>About</span>
<button onclick="showAboutInfo()">View</button>
</div>
<div id="aboutOverlay" class="about-overlay">
<div class="about-content">
<h2>About ISOD Staff Scheduling System</h2>
<p>
Version: 1.0
</p>
<p>
Developed by: Your Company
</p>
<p>
Description: A comprehensive staff scheduling system for efficient workforce management.
</p>
<button onclick="closeAboutOverlay()">Back to Settings</button>
</div>
</div>

<div class="setting-item">
<i class="fas fa-share-alt setting-icon"></i>
<span>Share</span>
<button onclick="shareSchedule()">Share</button>
</div>
</div>
<div class="settings-section">
<h2>Notifications</h2>
<div class="setting-item">
<i class="fas fa-bell setting-icon"></i>
<span>Enable Notifications</span>
<input type="checkbox" id="notificationsToggle">
</div>
</div>
<div class="settings-section">
<h2>Data Management</h2>
<div class="setting-item">
<i class="fas fa-database setting-icon"></i>
<button onclick="exportData()">Export Data</button>
</div>
<div class="setting-item">
<i class="fas fa-file-import setting-icon"></i>
<button onclick="importData()">Import Data</button>
</div>
</div>
</div>
</div>

<div id="tooltip" class="tooltip"></div>

<!-- Your JavaScript code -->
<script>
// Firebase configuration
const firebaseConfig = {
apiKey: "AIzaSyA8jrkF9TpIINymdXBDDI1yl4NuU_lsu7A",
authDomain: "isod-scheduler.firebaseapp.com",
projectId: "isod-scheduler",
storageBucket: "isod-scheduler.appspot.com",
messagingSenderId: "433265398148",
appId: "1:433265398148:web:d3fd3fe91692bd46c40dd1"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);

// Define global variables
let departments = [{
name: 'Transaction Monitoring',
abbr: 'TM'
},
{
name: 'Security Operation Center',
abbr: 'SOC2'
},
{
name: 'Fraud Desk',
abbr: 'FD'
}];
let shifts = [{
name: 'Morning',
start: '07:00',
end: '14:00',
minStaff: 15
},
{
name: 'Mid-Morning',
start: '10:00',
end: '17:00',
minStaff: 5
},
{
name: 'Afternoon',
start: '12:00',
end: '19:00',
minStaff: 14
},
{
name: 'Night',
start: '19:00',
end: '07:00',
minStaff: 8
}];
let staff = {};
let schedule = [];
let supervisors = new Set();
let weekdaySupervisors = new Set();
let weekendSupervisors = new Set();
let staffNotOnNightShift = new Set();
let staffOnLeave = {};
let staffLanguages = {};
let genderDistribution = {};
let staffPairRestrictions = [];
let pregnantStaff = {};
let currentEditingStaff = null;
let cycleStartDate = new Date();
let cycleEndDate = new Date(cycleStartDate);
cycleEndDate.setDate(cycleEndDate.getDate() + 28); // Default to 4 weeks
let previousGenerations = [];
let currentUser = null;
let activeUsers = new Set();
let onboardingPages = [
"Welcome to the ISOD Staff Scheduling System!",
"You can manage departments and shifts here.",
"Add staff members and set their preferences.",
"Generate schedules based on complex rules.",
"Thank you for using our system!"
];
let currentOnboardingPage = 0;

// Check if user is logged in
firebase.auth().onAuthStateChanged((user) => {
if (user) {
currentUser = user;
document.getElementById('loginForm').style.display = 'none';
document.getElementById('signUpForm').style.display = 'none';
document.getElementById('onboardingScreens').style.display = 'block';
document.getElementById('mainContent').style.display = 'none';
showOnboardingPage();
initializeApp();
updateActiveUsers(user.email, true);
} else {
document.getElementById('loginForm').style.display = 'block';
document.getElementById('signUpForm').style.display = 'none';
document.getElementById('mainContent').style.display = 'none';
}
});

// Skip login function
function skipLogin() {
currentUser = {
uid: 'guest'
}; // Use a guest UID
document.getElementById('loginForm').style.display = 'none';
document.getElementById('signUpForm').style.display = 'none';
document.getElementById('onboardingScreens').style.display = 'block';
document.getElementById('mainContent').style.display = 'block';
showOnboardingPage();
initializeApp();
}

// Onboarding functions
function showOnboardingPage() {
const content = document.getElementById('onboardingContent');
content.innerHTML = `<h2>${onboardingPages[currentOnboardingPage]}</h2>`;
}

function nextOnboarding() {
currentOnboardingPage++;
if (currentOnboardingPage >= onboardingPages.length) {
closeOnboarding();
} else {
showOnboardingPage();
}
}

function prevOnboarding() {
if (currentOnboardingPage > 0) {
currentOnboardingPage--;
showOnboardingPage();
}
}

function skipOnboarding() {
closeOnboarding();
}

function closeOnboarding() {
document.getElementById('onboardingScreens').style.display = 'none';
document.getElementById('mainContent').style.display = 'block';
}

// Login function
function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    checkIfCentaur(user);
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    initializeApp();
                })
                .catch((error) => {
                    showFancyAlert('Login failed: ' + error.message);
                });
        }

// Sign up function
function signUp() {
const email = document.getElementById('signUpEmail').value;
const password = document.getElementById('signUpPassword').value;
firebase.auth().createUserWithEmailAndPassword(email, password)
.catch((error) => {
showFancyAlert('Sign up failed: ' + error.message);
});
}

// Logout function
function logout() {
updateActiveUsers(currentUser.email, false);
firebase.auth().signOut().then(() => {
location.reload();
}).catch((error) => {
console.error('Logout failed:', error);
});
}

// Show sign up form
function showSignUpForm() {
document.getElementById('loginForm').style.display = 'none';
document.getElementById('signUpForm').style.display = 'block';
}

// Show login form
function showLoginForm() {
document.getElementById('loginForm').style.display = 'block';
document.getElementById('signUpForm').style.display = 'none';
}

// Update active users
function updateActiveUsers(userEmail, isActive) {
const usersRef = firebase.database().ref('activeUsers');
if (isActive) {
usersRef.child(btoa(userEmail)).set(true);
} else {
usersRef.child(btoa(userEmail)).remove();
}
}

// Listen for active users changes
function listenForActiveUsers() {
const usersRef = firebase.database().ref('activeUsers');
usersRef.on('value', (snapshot) => {
activeUsers.clear();
snapshot.forEach((childSnapshot) => {
activeUsers.add(atob(childSnapshot.key));
});
updateActiveUsersDisplay();
});
}

// Update active users display
function updateActiveUsersDisplay() {
const container = document.getElementById('activeUsers');
container.innerHTML = '<strong>Active Users:</strong> ';
activeUsers.forEach(user => {
const userSpan = document.createElement('span');
userSpan.className = 'active-user';
userSpan.textContent = user;
container.appendChild(userSpan);
});
}

// Initialize the application
function initializeApp() {
initializeDepartments();
initializeShifts();
populateDepartmentSelect();
updateSupervisorSelect();
listenForActiveUsers();

// Set initial dates for the cycle
document.getElementById('cycleStartDate').value = formatDateForInput(cycleStartDate);
document.getElementById('cycleEndDate').value = formatDateForInput(cycleEndDate);

// Add event listener for cycle date changes
document.getElementById('cycleStartDate').addEventListener('change', function() {
cycleStartDate = new Date(this.value);
if (cycleStartDate > cycleEndDate) {
cycleEndDate = new Date(cycleStartDate);
cycleEndDate.setDate(cycleEndDate.getDate() + (parseInt(document.getElementById('cycleDuration').value) * 7));
document.getElementById('cycleEndDate').value = formatDateForInput(cycleEndDate);
}
});

document.getElementById('cycleEndDate').addEventListener('change',
function() {
cycleEndDate = new Date(this.value);
if (cycleEndDate < cycleStartDate) {
cycleStartDate = new Date(cycleEndDate);
cycleStartDate.setDate(cycleStartDate.getDate() - (parseInt(document.getElementById('cycleDuration').value) * 7));
document.getElementById('cycleStartDate').value = formatDateForInput(cycleStartDate);
}
});

// Initialize dark mode toggle
document.getElementById('darkModeToggle').checked = document.body.classList.contains('dark-mode');

// Add settings option to hamburger menu
const settingsLink = document.createElement('a');
settingsLink.href = '#';
settingsLink.innerHTML = '<i class="fas fa-cog"></i> Settings';
settingsLink.onclick = showSettingsModal;
document.querySelector('.dropdown-content').appendChild(settingsLink);

// Initialize chat system
            document.getElementById('chatSystem').style.display = 'flex';

            // Add chat toggle button to the header
            const header = document.querySelector('.header');
            const chatToggle = document.createElement('button');
            chatToggle.innerHTML = '<i class="fas fa-comments"></i>';
            chatToggle.onclick = toggleChatSystem;
            header.appendChild(chatToggle);
}

// Function to format date for input fields
function formatDateForInput(date) {
return date.toISOString().split('T')[0];
}

// Initialize departments
function initializeDepartments() {
const departmentScroll = document.getElementById('departmentScroll');
departmentScroll.innerHTML = '';
departments.forEach(dept => {
const btn = document.createElement('span');
btn.className = 'scroll-item';
btn.textContent = dept.name;
btn.onclick = () => selectDepartment(dept.name);
departmentScroll.appendChild(btn);
});
}

// Populate department select dropdown
function populateDepartmentSelect() {
const departmentSelect = document.getElementById('departmentSelect');
departmentSelect.innerHTML = '<option value="">Select Department</option>';
departments.forEach(dept => {
const option = document.createElement('option');
option.value = dept.name;
option.textContent = dept.name;
departmentSelect.appendChild(option);
});
}

// Initialize shifts
function initializeShifts() {
const shiftScroll = document.getElementById('shiftScroll');
shiftScroll.innerHTML = '';
shifts.forEach(shift => {
const btn = document.createElement('span');
btn.className = 'scroll-item';
btn.textContent = `${shift.name} (${shift.start}-${shift.end})`;
btn.title = `Min Staff: ${shift.minStaff}`;
btn.onclick = () => editShift(shift);
shiftScroll.appendChild(btn);
});
}

// Add department
function addDepartment() {
const newDept = document.getElementById('newDepartment').value.trim();
const newAbbr = document.getElementById('newDepartmentAbbr').value.trim();
if (newDept && newAbbr && !departments.some(d => d.name.toLowerCase() === newDept.toLowerCase())) {
departments.push({
name: newDept, abbr: newAbbr
});
initializeDepartments();
populateDepartmentSelect();
document.getElementById('newDepartment').value = '';
document.getElementById('newDepartmentAbbr').value = '';
closeOverlay('addDepartmentOverlay');
saveToFirebase();
} else {
showFancyAlert("Invalid department details or department already exists.");
}
showTooltip('Department added successfully');
}

// Fix Close Overlay
function closeOverlay(overlayId) {
document.getElementById(overlayId).style.display = 'none';
}

// Add shift
function addShift() {
const name = document.getElementById('newShiftName').value.trim();
const start = document.getElementById('newShiftStart').value;
const end = document.getElementById('newShiftEnd').value;
const minStaff = parseInt(document.getElementById('newShiftMinStaff').value);
if (name && start && end && minStaff && !shifts.some(s => s.name.toLowerCase() === name.toLowerCase())) {
shifts.push({
name, start, end, minStaff
});
initializeShifts();
document.getElementById('newShiftName').value = '';
document.getElementById('newShiftStart').value = '';
document.getElementById('newShiftEnd').value = '';
document.getElementById('newShiftMinStaff').value = '';
closeOverlay('addShiftOverlay');
saveToFirebase();
} else {
showFancyAlert("Invalid shift details or shift already exists.");
}
showTooltip('Shift added successfully');
}

// Select department
function selectDepartment(dept) {
document.querySelectorAll('.scroll-item').forEach(btn => {
btn.classList.toggle('active', btn.textContent === dept);
});
updateStaffList();
}

// Edit shift
function editShift(shift) {
const newName = prompt('Enter new shift name:', shift.name);
const newStart = prompt('Enter new start time (HH:MM):', shift.start);
const newEnd = prompt('Enter new end time (HH:MM):', shift.end);
const newMinStaff = prompt('Enter new minimum staff:', shift.minStaff);
if (newName && newStart && newEnd && newMinStaff && !isNaN(newMinStaff)) {
shift.name = newName.trim();
shift.start = newStart;
shift.end = newEnd;
shift.minStaff = parseInt(newMinStaff);
initializeShifts();
updateScheduleTable();
saveToFirebase();
} else {
showFancyAlert("Invalid shift details.");
}
}

// Quick add staff
function quickAddStaff() {
const staffNames = document.getElementById('quickAddStaff').value.split(',').map(name => name.trim()).filter(name => name);
const department = document.getElementById('departmentSelect').value;
if (department && staffNames.length > 0) {
if (!staff[department]) staff[department] = [];
staffNames.forEach(name => {
if (name && !staff[department].some(s => s.name.toLowerCase() === name.toLowerCase())) {
staff[department].push({
name,
preferences: shifts.map(shift => ({
name: shift.name, days: 0
})),
gender: '',
role: 'n',
leaveDays: [],
weekendsOff: 0,
nightShifts: 0,
pregnantUntil: null,
languages: [],
maxConsecutiveNightShifts: 3
});
}
});
document.getElementById('quickAddStaff').value = '';
updateStaffList();
updateSupervisorSelect();
saveToFirebase();
} else {
showFancyAlert("Please select a department and enter valid staff names.");
}
showTooltip('Staff added successfully');
}

// Add individual staff via overlay
function addIndividualStaff() {
const name = document.getElementById('staffName').value.trim();
const gender = document.getElementById('staffGender').value;
const role = document.getElementById('staffRole').value;
const department = document.getElementById('departmentSelect').value;
const languages = document.getElementById('staffLanguage').value.trim().split(',').map(l => l.trim()).filter(l => l);
const pregnantUntil = document.getElementById('staffPregnantUntil').value ? new Date(document.getElementById('staffPregnantUntil').value): null;
const leaveStart = document.getElementById('staffLeaveStart').value ? new Date(document.getElementById('staffLeaveStart').value): null;
const leaveEnd = document.getElementById('staffLeaveEnd').value ? new Date(document.getElementById('staffLeaveEnd').value): null;

if (name && gender && role && department) {
if (!staff[department]) staff[department] = [];
if (!staff[department].some(s => s.name.toLowerCase() === name.toLowerCase())) {
staff[department].push({
name,
gender,
role,
preferences: shifts.map(shift => ({
name: shift.name, days: 0
})),
leaveDays: [],
weekendsOff: 0,
nightShifts: 0,
pregnantUntil,
languages,
maxConsecutiveNightShifts: 3
});
if (leaveStart && leaveEnd) {
const leaveDates = getDatesBetween(leaveStart, leaveEnd);
staff[department][staff[department].length - 1].leaveDays = leaveDates;
}
if (role === 's') {
supervisors.add(name);
weekdaySupervisors.add(name);
}
if (pregnantUntil) {
pregnantStaff[name] = pregnantUntil;
}
if (languages.length > 0) {
staffLanguages[name] = languages;
}
updateStaffList();
updateSupervisorSelect();
closeOverlay('addStaffOverlay');
saveToFirebase();
} else {
showFancyAlert("Staff member already exists in the selected department.");
}
} else {
showFancyAlert("Please fill in all staff details.");
}
showTooltip('Staff member added successfully');
}

// Add Individual Staff overlay
function showAddStaffOverlay() {
const overlay = document.getElementById('addStaffOverlay');
overlay.style.display = 'block';
}

// Prevent scrolling when settings modal is open
function showSettingsModal() {
document.getElementById('settingsModal').style.display = 'block';
document.body.style.overflow = 'hidden';
}
function closeSettingsModal() {
document.getElementById('settingsModal').style.display = 'none';
document.body.style.overflow = 'auto';
}

// Tooltip
function showTooltip(message) {
const tooltip = document.getElementById('tooltip');
tooltip.textContent = message;
tooltip.style.display = 'block';
setTimeout(() => {
tooltip.style.display = 'none';
}, 3000);
}

// Export Data
function exportData() {
const data = {
departments,
shifts,
staff,
schedule,
supervisors: Array.from(supervisors),
weekdaySupervisors: Array.from(weekdaySupervisors),
weekendSupervisors: Array.from(weekendSupervisors),
staffNotOnNightShift: Array.from(staffNotOnNightShift),
staffOnLeave,
staffLanguages,
genderDistribution,
staffPairRestrictions,
pregnantStaff,
cycleStartDate: cycleStartDate.toISOString(),
cycleEndDate: cycleEndDate.toISOString(),
previousGenerations
};
const dataStr = JSON.stringify(data);
const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
const exportFileDefaultName = 'isod_scheduler_data.json';

const linkElement = document.createElement('a');
linkElement.setAttribute('href', dataUri);
linkElement.setAttribute('download', exportFileDefaultName);
linkElement.click();
showTooltip('Data exported successfully');
}

// Import Data
function importData() {
const input = document.createElement('input');
input.type = 'file';
input.accept = '.json';
input.onchange = function(event) {
const file = event.target.files[0];
const reader = new FileReader();
reader.onload = function(e) {
const contents = e.target.result;
const data = JSON.parse(contents);
// Update your application state with the imported data
departments = data.departments;
shifts = data.shifts;
staff = data.staff;
schedule = data.schedule;
supervisors = new Set(data.supervisors);
weekdaySupervisors = new Set(data.weekdaySupervisors);
weekendSupervisors = new Set(data.weekendSupervisors);
staffNotOnNightShift = new Set(data.staffNotOnNightShift);
staffOnLeave = data.staffOnLeave;
staffLanguages = data.staffLanguages;
genderDistribution = data.genderDistribution;
staffPairRestrictions = data.staffPairRestrictions;
pregnantStaff = data.pregnantStaff;
cycleStartDate = new Date(data.cycleStartDate);
cycleEndDate = new Date(data.cycleEndDate);
previousGenerations = data.previousGenerations;

// Update UI
initializeDepartments();
initializeShifts();
populateDepartmentSelect();
updateStaffList();
updateSupervisorSelect();
updateScheduleTable();
updatePreviousGenerations();

showTooltip('Data imported successfully');
};
reader.readAsText(file);
};
input.click();
}




// Implement PiP-like feature for schedule table
function showScheduleModal() {
const modal = document.getElementById('scheduleModal');
const modalContent = document.getElementById('modalScheduleContainer');
modalContent.innerHTML = document.getElementById('scheduleTable').outerHTML;
modal.style.display = 'block';

// Close modal when clicking on <span> (x)
modal.querySelector('.close').onclick = function() {
modal.style.display = 'none';
}

// Close modal when clicking outside of it
window.onclick = function(event) {
if (event.target == modal) {
modal.style.display = 'none';
}
}
}

// Search and replace feature
function searchAndReplace() {
const searchTerm = document.getElementById('searchInput').value;
const replaceTerm = document.getElementById('replaceInput').value;
const table = document.getElementById('modalScheduleContainer').querySelector('table');
const cells = table.getElementsByTagName('td');

for (let i = 0; i < cells.length; i++) {
if (cells[i].textContent.includes(searchTerm)) {
cells[i].textContent = cells[i].textContent.replace(searchTerm, replaceTerm);
}
}

// Update the main schedule table
document.getElementById('scheduleTable').outerHTML = table.outerHTML;
updateScheduleFromTable();
}



// Update schedule array from table
function updateScheduleFromTable() {
const table = document.getElementById('scheduleTable');
const rows = table.getElementsByTagName('tr');
schedule = [];

for (let i = 1; i < rows.length; i++) {
// Start from 1 to skip header
const cells = rows[i].getElementsByTagName('td');
if (cells.length >= 4) {
const date = new Date(cells[0].textContent.split('-').reverse().join('-'));
const department = cells[2].textContent;

for (let j = 3; j < cells.length; j++) {
const shift = shifts[j - 3].name;
const staff = cells[j].textContent.split(',').map(s => s.trim()).filter(s => s);
if (staff.length > 0) {
schedule.push({
date,
department,
staff,
shift
});
}
}
}
}
saveToFirebase();
}

function zoomTable(zoomLevel) {
const table = document.querySelector('#modalScheduleContainer table');
table.style.transform = `scale(${zoomLevel / 100})`;
table.style.transformOrigin = 'top left';
document.getElementById('zoomValue').textContent = zoomLevel + '%';
}

// Get dates between two dates
function getDatesBetween(startDate, endDate) {
const dates = [];
let currentDate = new Date(startDate);
while (currentDate <= endDate) {
dates.push(formatDate(currentDate));
currentDate.setDate(currentDate.getDate() + 1);
}
return dates;
}

// Use default staff data
function useDefaultStaff() {
const defaultStaffData = `Abiodun,F,n;Adams,M,s;Adeleke,M,n;Adelodun,M,n;Adenike,F,s;Alimat,F,n;Basirat,F,n;Bolaji,M,s;Celestina,F,n;Dara,F,s;David,M,s;Esther,F,n;Etim,M,n;Gabriel,M,s;Gideon,M,n;Godwin,M,s;James,M,n;Jerry,M,n;Joshua,M,n;Kamilah,F,s;Kemi,F,n;Marho,F,n;Marvellous,F,n;Michael,M,n;Miracle,F,n;Olayemi,F,s;Opeyemi,M,s;Osato,F,n;Samuel,M,n;Solomon,M,s;Sophia,F,s;Stephen A.,M,s;Stephen E.,M,s;Tobi,F,s;Tosin,M,n;Wisdom,M,s;Yetunde,F,s;Zainab,F,n`;
staff = {};
const defaultDept = 'Transaction Monitoring';
staff[defaultDept] = [];
defaultStaffData.split(';').forEach(staffInfo => {
const [name, gender, role] = staffInfo.split(',');
const s = {
name,
gender,
role,
preferences: shifts.map(shift => ({
name: shift.name, days: 0
})),
leaveDays: [],
weekendsOff: 0,
nightShifts: 0,
pregnantUntil: null,
languages: [],
maxConsecutiveNightShifts: 3
};
staff[defaultDept].push(s);
if (role === 's') {
supervisors.add(name);
weekdaySupervisors.add(name);
}
});
updateStaffList();
updateSupervisorSelect();
saveToFirebase();
}

// Update staff list
function updateStaffList() {
const staffList = document.getElementById('staffList');
staffList.innerHTML = '';
Object.entries(staff).forEach(([dept, staffMembers]) => {
staffMembers.forEach((s, index) => {
const card = document.createElement('div');
card.className = 'staff-card';
card.innerHTML = `
<h3 class="${supervisors.has(s.name) ? 'supervisor': ''}">${s.name}</h3>
<p>Department: ${dept}</p>
<p>Gender: ${s.gender}</p>
<p>Role: ${s.role === 's' ? 'Supervisor': 'Normal'}</p>
<p>Preferences: ${s.preferences.map(p => `${p.name}: ${p.days} days`).join(', ')}</p>
<button onclick="editStaffPreferences('${dept}', ${index})">Edit Preferences</button>
<button onclick="deleteStaff('${dept}', ${index})">Delete</button>
<button onclick="resetStaff('${dept}', ${index})">Reset</button>
`;
staffList.appendChild(card);
});
});
}

// Edit staff preferences
function editStaffPreferences(dept, index) {
currentEditingStaff = {
dept, index
};
const s = staff[dept][index];
const overlay = document.getElementById('preferencesOverlay');
const content = document.getElementById('preferencesContent');
content.innerHTML = '';
s.preferences.forEach(pref => {
const prefContainer = document.createElement('div');
prefContainer.className = 'preference-container';
prefContainer.innerHTML = `
<label>${pref.name}: <span id="${pref.name}-value">${pref.days} days</span></label>
<input type="number" min="0" max="31" value="${pref.days}" class="preference-input" id="${pref.name}-input">
`;
content.appendChild(prefContainer);
const input = prefContainer.querySelector('.preference-input');
const valueSpan = prefContainer.querySelector(`#${pref.name}-value`);
input.oninput = function() {
valueSpan.textContent = this.value + ' days';
}
});
overlay.style.display = 'block';
}

// Save preferences
function savePreferences() {
const {
dept, index
} = currentEditingStaff;
const s = staff[dept][index];
s.preferences.forEach(pref => {
const input = document.getElementById(`${pref.name}-input`);
pref.days = parseInt(input.value);
});
updateStaffList();
closeOverlay('preferencesOverlay');
saveToFirebase();
}

// Delete staff
function deleteStaff(dept, index) {
if (confirm('Are you sure you want to delete this staff member?')) {
const deletedStaff = staff[dept].splice(index, 1)[0];
supervisors.delete(deletedStaff.name);
weekdaySupervisors.delete(deletedStaff.name);
weekendSupervisors.delete(deletedStaff.name);
staffNotOnNightShift.delete(deletedStaff.name);
updateStaffList();
updateSupervisorSelect();
saveToFirebase();
}
}

// Reset staff
function resetStaff(dept, index) {
if (confirm('Are you sure you want to reset this staff member\'s stats?')) {
const s = staff[dept][index];
s.workDays = 0;
s.nightShifts = 0;
s.weekendsWorked = 0;
updateStaffList();
saveToFirebase();
}
}

// Update supervisor select
function updateSupervisorSelect() {
const supervisorSelect = document.getElementById('supervisorSelect');
supervisorSelect.innerHTML = '';
Object.values(staff).flat().forEach(s => {
const option = document.createElement('div');
option.className = `supervisor-option ${supervisors.has(s.name) ? 'selected': ''}`;
option.textContent = s.name;
option.onclick = () => toggleSupervisor(s.name);
supervisorSelect.appendChild(option);
});
}

// Toggle supervisor
function toggleSupervisor(name) {
if (supervisors.has(name)) {
supervisors.delete(name);
weekdaySupervisors.delete(name);
weekendSupervisors.delete(name);
} else {
supervisors.add(name);
const isWeekendSupervisor = confirm('Should this supervisor be assigned to weekends primarily?');
if (isWeekendSupervisor) {
weekendSupervisors.add(name);
} else {
weekdaySupervisors.add(name);
}
}
updateSupervisorSelect();
updateStaffList();
saveToFirebase();
}

// Set supervisors
function setSupervisors() {
updateStaffList();
saveToFirebase();
}

// Set cycle duration
function setCycleDuration() {
const duration = parseInt(document.getElementById('cycleDuration').value);
cycleStartDate = new Date();
cycleEndDate = new Date(cycleStartDate);
cycleEndDate.setDate(cycleEndDate.getDate() + (duration * 7));
document.getElementById('cycleStartDate').value = formatDateForInput(cycleStartDate);
document.getElementById('cycleEndDate').value = formatDateForInput(cycleEndDate);
saveToFirebase();
}

// Generate schedule
function generateSchedule() {
if (Object.keys(staff).length === 0 || Object.values(staff).flat().length === 0) {
showFancyAlert("Please add staff members before generating the schedule.");
return;
}

schedule = [];
resetStaffStats();

const totalDays = Math.round((cycleEndDate - cycleStartDate) / (1000 * 60 * 60 * 24)) + 1;

for (let d = 0; d < totalDays; d++) {
const currentDate = new Date(cycleStartDate);
currentDate.setDate(cycleStartDate.getDate() + d);
const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;

departments.forEach(dept => {
if (staff[dept.name]) {
shifts.forEach(shift => {
const availableStaff = staff[dept.name].filter(s => canAssignStaff(s, currentDate, shift, isWeekend));
const selectedStaff = selectStaffForShift(availableStaff, shift, isWeekend, shift.minStaff);
schedule.push({
date: new Date(currentDate),
department: dept.name,
staff: selectedStaff.map(s => s.name),
shift: shift.name
});
selectedStaff.forEach(s => updateStaffStats(s, shift, isWeekend));
});
}
});
}

balanceSchedule();
updateScheduleTable();
savePreviousGeneration();
saveToFirebase();
showTooltip('Schedule generated successfully');
}

// Reset staff stats
function resetStaffStats() {
Object.values(staff).flat().forEach(s => {
s.workDays = 0;
s.nightShifts = 0;
s.weekendsWorked = 0;
s.consecutiveNightShifts = 0;
});
}

// Can assign staff
function canAssignStaff(staffMember, date, shift, isWeekend) {
const dateStr = formatDate(date);

// Check if staff is on leave
if (staffMember.leaveDays && staffMember.leaveDays.includes(dateStr)) return false;

// Check if staff is pregnant and cannot work night shifts
if (staffMember.pregnantUntil && date <= staffMember.pregnantUntil && shift.name === 'Night') return false;

// Some staff should not work night shifts
if (staffNotOnNightShift.has(staffMember.name) && shift.name === 'Night') return false;

// Check if staff has reached max consecutive night shifts
if (shift.name === 'Night' && staffMember.consecutiveNightShifts >= staffMember.maxConsecutiveNightShifts) return false;

// Check if staff has already worked today
const workedToday = schedule.some(entry =>
formatDate(entry.date) === dateStr &&
entry.staff.includes(staffMember.name)
);
if (workedToday) return false;

// Check if staff has days off
if (staffMember.daysOff && staffMember.daysOff.includes(dateStr)) return false;

// Check if staff has already worked maximum days in the week
const weekNumber = getWeekNumber(date);
const daysWorkedThisWeek = getDaysWorkedInWeek(staffMember, weekNumber);
if (daysWorkedThisWeek >= 5) return false;

// Avoid two people working together if in restrictions
for (let pair of staffPairRestrictions) {
if ((pair[0] === staffMember.name || pair[1] === staffMember.name)) {
const otherName = pair[0] === staffMember.name ? pair[1]: pair[0];
const otherAssigned = schedule.some(entry =>
formatDate(entry.date) === dateStr &&
entry.shift === shift.name &&
entry.staff.includes(otherName)
);
if (otherAssigned) return false;
}
}

return true;
}

// Get days worked in a week
function getDaysWorkedInWeek(staffMember, weekNumber) {
return schedule.filter(entry =>
getWeekNumber(entry.date) === weekNumber &&
entry.staff.includes(staffMember.name)
).length;
}

// Select staff for shift
function selectStaffForShift(availableStaff, shift, isWeekend, minStaff) {
let selectedStaff = [];

// Ensure there is a supervisor
const supervisorsAvailable = availableStaff.filter(s => supervisors.has(s.name));
if (supervisorsAvailable.length > 0) {
const supervisor = supervisorsAvailable[Math.floor(Math.random() * supervisorsAvailable.length)];
selectedStaff.push(supervisor);
availableStaff = availableStaff.filter(s => s.name !== supervisor.name);
}

// Fill the remaining slots
const remaining = minStaff - selectedStaff.length;
if (remaining > 0) {
const shuffled = availableStaff.sort(() => 0.5 - Math.random());
selectedStaff = selectedStaff.concat(shuffled.slice(0, remaining));
}

return selectedStaff;
}

// Update staff stats
function updateStaffStats(staffMember, shift, isWeekend) {
staffMember.workDays++;
if (shift.name === 'Night') {
staffMember.nightShifts++;
staffMember.consecutiveNightShifts++;
} else {
staffMember.consecutiveNightShifts = 0;
}
if (isWeekend) staffMember.weekendsWorked++;
}

// Balance Schedule
function balanceSchedule() {
const staffWorkload = {};

// Count the workload for each staff member
schedule.forEach(entry => {
entry.staff.forEach(staffName => {
if (!staffWorkload[staffName]) {
staffWorkload[staffName] = {
total: 0,
shifts: {}
};
}
staffWorkload[staffName].total++;
if (!staffWorkload[staffName].shifts[entry.shift]) {
staffWorkload[staffName].shifts[entry.shift] = 0;
}
staffWorkload[staffName].shifts[entry.shift]++;
});
});

// Find staff with too many or too few shifts
const averageWorkload = Object.values(staffWorkload).reduce((sum,
staff) => sum + staff.total, 0) / Object.keys(staffWorkload).length;
const overworkedStaff = Object.entries(staffWorkload).filter(([name,
workload]) => workload.total > averageWorkload * 1.2);
const underworkedStaff = Object.entries(staffWorkload).filter(([name,
workload]) => workload.total < averageWorkload * 0.8);

// Attempt to balance the schedule
overworkedStaff.forEach(([overworkedName,
overworkload]) => {
underworkedStaff.forEach(([underworkedName, underworkload]) => {
schedule.forEach(entry => {
if (entry.staff.includes(overworkedName) && !entry.staff.includes(underworkedName)) {
const index = entry.staff.indexOf(overworkedName);
entry.staff[index] = underworkedName;
staffWorkload[overworkedName].total--;
staffWorkload[underworkedName].total++;
if (staffWorkload[overworkedName].total <= averageWorkload * 1.1) {
return;
}
}
});
});
});

updateScheduleTable();
}

// Update schedule table
function updateScheduleTable() {
const table = document.getElementById('scheduleTable');
table.innerHTML = '';

// Add month title
const monthRow = table.insertRow();
const monthCell = monthRow.insertCell();
monthCell.colSpan = shifts.length + 3; // Date, Day, Department, Shifts
monthCell.style.textAlign = 'center';
monthCell.style.fontSize = '18px';
monthCell.textContent = `${cycleStartDate.toLocaleString('default', {
month: 'long'
})} - ${cycleEndDate.toLocaleString('default', {
month: 'long'
})} ${cycleEndDate.getFullYear()} Schedule`;

// Add table header
const headerRow = table.insertRow();
headerRow.innerHTML = `
<th>Date</th>
<th>Day</th>
<th>Department</th>
${shifts.map(s => `<th>${s.name}</th>`).join('')}
`;

// Add expand icon
const expandIcon = document.createElement('i');
expandIcon.className = 'fas fa-expand expand-icon';
expandIcon.onclick = showScheduleModal;
table.parentElement.insertBefore(expandIcon, table);

let currentWeek = null;
const groupedSchedule = groupScheduleByDateAndDepartment();

Object.entries(groupedSchedule).forEach(([dateKey, departments]) => {
const date = new Date(dateKey);

// Add week separator if needed
if (!currentWeek || getWeekNumber(date) !== getWeekNumber(currentWeek)) {
currentWeek = date;
let weekRow = table.insertRow();
let weekCell = weekRow.insertCell();
weekCell.colSpan = shifts.length + 3;
weekCell.className = 'week-separator';
weekCell.textContent = `Week ${getWeekNumber(date)}: ${getWeekRange(date)}`;
}

Object.entries(departments).forEach(([dept, shiftsData]) => {
let row = table.insertRow();
row.innerHTML = `
<td>${formatDate(date)}</td>
<td>${getDayName(date)}</td>
<td>${dept}</td>
${shifts.map(s => `
<td class="shift-cell" data-shift="${s.name}"
contenteditable="true"
oninput="updateScheduleStaff('${formatDate(date)}', '${dept}', '${s.name}', this)">
${formatStaffList(shiftsData[s.name] || [])}
</td>
`).join('')}
`;
});
});

addTotalsRow(table);
}

// Add totals row
function addTotalsRow(table) {
const totalsRow = table.insertRow();
totalsRow.className = 'totals-row';
const cells = shifts.length + 3;
for (let i = 0; i < cells; i++) {
const cell = totalsRow.insertCell();
if (i === 0) {
cell.textContent = 'Totals';
} else if (i > 2) {
const shiftName = shifts[i - 3].name;
const total = calculateShiftTotal(shiftName);
cell.textContent = total;
}
}
}

// Calculate shift total
function calculateShiftTotal(shiftName) {
return schedule.reduce((total, entry) => {
if (entry.shift === shiftName) {
return total + entry.staff.length;
}
return total;
},
0);
}

// Sort table
function sortTable(n) {
const table = document.getElementById('scheduleTable');
let switching = true;
let dir = 'asc';
let switchcount = 0;
while (switching) {
switching = false;
const rows = table.rows;
for (let i = 1; i < (rows.length - 1); i++) {
let shouldSwitch = false;
const x = rows[i].getElementsByTagName('TD')[n];
const y = rows[i + 1].getElementsByTagName('TD')[n];
if (dir === 'asc') {
if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
shouldSwitch = true;
break;
}
} else if (dir === 'desc') {
if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
shouldSwitch = true;
break;
}
}
}
if (shouldSwitch) {
rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
switching = true;
switchcount++;
} else {
if (switchcount === 0 && dir === 'asc') {
dir = 'desc';
switching = true;
}
}
}
}

// Select row
function selectRow(row) {
row.classList.toggle('selected');
}

// Highlight search results
function highlightSearchResults(searchTerm) {
const table = document.getElementById('scheduleTable');
const rows = table.getElementsByTagName('tr');
for (let i = 0; i < rows.length; i++) {
const cells = rows[i].getElementsByTagName('td');
for (let j = 0; j < cells.length; j++) {
const cellText = cells[j].innerText;
if (cellText.toLowerCase().includes(searchTerm.toLowerCase())) {
cells[j].innerHTML = cellText.replace(new RegExp(searchTerm, 'gi'), match => `<mark>${match}</mark>`);
}
}
}
}

// Group schedule by date and department
function groupScheduleByDateAndDepartment() {
return schedule.reduce((acc, entry) => {
const dateKey = formatDate(entry.date);
if (!acc[dateKey]) acc[dateKey] = {};
if (!acc[dateKey][entry.department]) acc[dateKey][entry.department] = {};
if (!acc[dateKey][entry.department][entry.shift]) acc[dateKey][entry.department][entry.shift] = [];
acc[dateKey][entry.department][entry.shift] = acc[dateKey][entry.department][entry.shift].concat(entry.staff);
return acc;
},
{});
}

// Format staff list
function formatStaffList(staffList) {
return staffList.map(name => {
const isSupervisor = supervisors.has(name);
return `<span class="staff-name ${isSupervisor ? 'supervisor': ''}" title="${name}">${name}</span>`;
}).join(', ');
}

// Get week range
function getWeekRange(date) {
let start = new Date(date);
start.setDate(start.getDate() - start.getDay() + 1); // Start from Monday
let end = new Date(start);
end.setDate(end.getDate() + 6);
return `${formatDate(start)} to ${formatDate(end)}`;
}

// Get week number
function getWeekNumber(date) {
const firstDayOfYear = new Date(date.getFullYear(),
0,
1);
const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
}

// Get day name
function getDayName(date) {
const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
return days[date.getDay()];
}

// Format date
function formatDate(date) {
if (!(date instanceof Date) || isNaN(date)) {
return 'Invalid Date';
}
return `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;
}

// Update schedule staff
function updateScheduleStaff(date, department, shift, element) {
const staffNames = element.textContent.split(',').map(name => name.trim()).filter(name => name);
schedule = schedule.filter(e => !(
formatDate(e.date) === date &&
e.department === department &&
e.shift === shift
));
if (staffNames.length > 0) {
schedule.push({
date: new Date(date.split('-').reverse().join('-')),
department,
staff: staffNames,
shift
});
}
saveToFirebase();

// Update progress bar
const shiftConfig = shifts.find(s => s.name === shift);
const minStaff = shiftConfig ? shiftConfig.minStaff: 1;
const staffRatio = staffNames.length / minStaff;
const progressBar = element.querySelector('.progress-bar');
if (!progressBar) {
const newProgressBar = document.createElement('div');
newProgressBar.className = 'progress-bar';
newProgressBar.innerHTML = `<div class="progress" style="width: ${staffRatio * 100}%;"></div>`;
element.appendChild(newProgressBar);
} else {
progressBar.querySelector('.progress').style.width = `${staffRatio * 100}%`;
}

// Change color based on staff ratio
const progressElement = progressBar ? progressBar.querySelector('.progress'): newProgressBar.querySelector('.progress');
if (staffRatio < 1) {
progressElement.style.backgroundColor = 'red';
} else if (staffRatio > 1) {
progressElement.style.backgroundColor = 'yellow';
} else {
progressElement.style.backgroundColor = 'green';
}
}

// Modified search function
function searchSchedule() {
const searchTerm = document.getElementById('searchInput').value.toLowerCase();
const tables = [
document.getElementById('scheduleTable'),
document.getElementById('modalScheduleContainer').querySelector('table')
];

tables.forEach(table => {
const rows = table.getElementsByTagName('tr');
for (let i = 1; i < rows.length; i++) {
const row = rows[i];
const cells = row.getElementsByTagName('td');
let found = false;

for (let j = 0; j < cells.length; j++) {
const cellText = cells[j].textContent.toLowerCase();
if (cellText.includes(searchTerm)) {
found = true;
break;
}
}

if (found) {
row.style.display = '';
highlightSearchTerm(row, searchTerm);
} else {
row.style.display = 'none';
}
}
});
}

function highlightSearchTerm(row, term) {
const cells = row.getElementsByTagName('td');
for (let i = 0; i < cells.length; i++) {
const cellText = cells[i].textContent;
cells[i].innerHTML = cellText.replace(new RegExp(term, 'gi'), match => `<mark>${match}</mark>`);
}
}
// Improved search functionality
let currentSearchIndex = -1;
let searchResults = [];

function findNext() {
const searchTerm = document.getElementById('searchInput').value.toLowerCase();
if (searchTerm === '') return;

const tables = [
document.getElementById('scheduleTable'),
document.getElementById('modalScheduleContainer').querySelector('table')
];

// Clear previous highlights
tables.forEach(table => {
const cells = table.getElementsByTagName('td');
for (let cell of cells) {
cell.classList.remove('highlight-cell');
}
});

if (searchResults.length === 0 || currentSearchIndex === -1) {
// Perform new search
searchResults = tables.flatMap(table =>
Array.from(table.getElementsByTagName('td')).filter(cell =>
cell.textContent.toLowerCase().includes(searchTerm)
)
);
currentSearchIndex = 0;
} else {
currentSearchIndex = (currentSearchIndex + 1) % searchResults.length;
}

if (searchResults.length > 0) {
const cell = searchResults[currentSearchIndex];
cell.classList.add('highlight-cell');
cell.scrollIntoView({
behavior: 'smooth', block: 'center'
});
updateSearchResults();
} else {
updateSearchResults('No results found');
}
}

// Modified findAll function

function findAll() {
const searchTerm = document.getElementById('searchInput').value.toLowerCase();
if (searchTerm === '') return;

const tables = [
document.getElementById('scheduleTable'),
document.getElementById('modalScheduleContainer').querySelector('table')
];

const resultsContainer = document.getElementById('findAllResults');
resultsContainer.innerHTML = '';

const uniqueResults = new Set();

tables.forEach(table => {
const cells = table.getElementsByTagName('td');
for (let cell of cells) {
if (cell.textContent.toLowerCase().includes(searchTerm)) {
const row = cell.closest('tr');
const date = row.cells[0].textContent;
const dept = row.cells[2].textContent;
const shift = row.cells[cell.cellIndex].textContent;
const resultKey = `${date}-${dept}-${shift}`;

if (!uniqueResults.has(resultKey)) {
uniqueResults.add(resultKey);
cell.classList.add('highlight-cell');

const resultItem = document.createElement('div');
resultItem.textContent = `${date} - ${dept} - ${shift}`;
resultItem.onclick = () => {
cell.scrollIntoView({
behavior: 'smooth', block: 'center'
});
};
resultsContainer.appendChild(resultItem);
}
}
}
});

if (uniqueResults.size > 0) {
resultsContainer.style.display = 'block';
updateSearchResults(`${uniqueResults.size} unique results found`);
} else {
resultsContainer.style.display = 'none';
updateSearchResults('No results found');
}
}

// New function to toggle chat bar
function toggleChatBar() {
const chatBar = document.getElementById('chatBar');
chatBar.classList.toggle('open');
}


// New function to send a message
function sendMessage() {
const input = document.getElementById('chatInput');
const message = input.value.trim();
if (message) {
const chatMessages = document.getElementById('chatMessages');
const messageElement = document.createElement('div');
messageElement.textContent = message;
chatMessages.appendChild(messageElement);
input.value = '';
chatMessages.scrollTop = chatMessages.scrollHeight;
}
}



function updateSearchResults(message) {
const resultsSpans = document.querySelectorAll('#searchResults');
resultsSpans.forEach(span => {
span.textContent = message || `Result ${currentSearchIndex + 1} of ${searchResults.length}`;
});
}
// New functions for About and Share
// Update the showAboutInfo and closeAboutOverlay functions
function showAboutInfo() {
document.getElementById('aboutOverlay').classList.add('active');
}

function closeAboutOverlay() {
document.getElementById('aboutOverlay').classList.remove('active');
document.getElementById('settingsModal').style.display = 'none';
}

function shareSchedule() {
// Implement sharing functionality here
showFancyAlert('Sharing functionality to be implemented');
}

// Update the showAddDepartmentOverlay and showAddShiftOverlay functions
function showAddDepartmentOverlay() {
document.getElementById('addDepartmentOverlay').style.display = 'block';
}

function showAddShiftOverlay() {
document.getElementById('addShiftOverlay').style.display = 'block';
}

// Save previous generation
function savePreviousGeneration() {
const generationSnapshot = JSON.parse(JSON.stringify(schedule));
previousGenerations.unshift(generationSnapshot);
if (previousGenerations.length > 5) {
previousGenerations.pop();
}
updatePreviousGenerations();
}

// Update previous generations
function updatePreviousGenerations() {
const container = document.getElementById('previousGenerations');
container.innerHTML = '';
previousGenerations.forEach((gen, index) => {
const item = document.createElement('div');
item.className = 'generation-item';
item.innerHTML = `Generation ${index + 1}`;
const trashIcon = document.createElement('i');
trashIcon.className = 'fas fa-trash trash-icon';
trashIcon.onclick = (e) => {
e.stopPropagation();
deletePreviousGeneration(index);
};
item.appendChild(trashIcon);
item.onclick = () => loadPreviousGeneration(index);
container.appendChild(item);
});
}

// Delete previous generation
function deletePreviousGeneration(index) {
previousGenerations.splice(index, 1);
updatePreviousGenerations();
saveToFirebase();
}

// Load previous generation
function loadPreviousGeneration(index) {
schedule = JSON.parse(JSON.stringify(previousGenerations[index]));
updateScheduleTable();
saveToFirebase();
}

// Reset all staff
function resetAllStaff() {
if (confirm('Are you sure you want to reset all staff schedules?')) {
Object.values(staff).flat().forEach(staffMember => {
staffMember.workDays = 0;
staffMember.nightShifts = 0;
staffMember.weekendsWorked = 0;
});

schedule = [];
updateScheduleTable();
saveToFirebase();
}
}

// Save to Firebase
function saveToFirebase() {
if (!currentUser) {
console.error('No user logged in');
return;
}
const data = {
departments,
shifts,
staff,
schedule,
supervisors: Array.from(supervisors),
weekdaySupervisors: Array.from(weekdaySupervisors),
weekendSupervisors: Array.from(weekendSupervisors),
staffNotOnNightShift: Array.from(staffNotOnNightShift),
staffOnLeave,
staffLanguages,
genderDistribution,
staffPairRestrictions,
pregnantStaff,
cycleStartDate: cycleStartDate.toISOString(),
cycleEndDate: cycleEndDate.toISOString(),
previousGenerations
};
firebase.database().ref('schedules/' + currentUser.uid).set(data)
.then(() => console.log('Data saved successfully'))
.catch((error) => console.error('Error saving data:', error));
showTooltip('Data saved to Firebase');
}

// Load from Firebase
function loadFromFirebase() {
if (!currentUser) {
console.error('No user logged in');
return;
}
firebase.database().ref('schedules/' + currentUser.uid).once('value')
.then((snapshot) => {
const data = snapshot.val();
if (data) {
departments = data.departments;
shifts = data.shifts;
staff = data.staff;
schedule = data.schedule;
supervisors = new Set(data.supervisors);
weekdaySupervisors = new Set(data.weekdaySupervisors);
weekendSupervisors = new Set(data.weekendSupervisors);
staffNotOnNightShift = new Set(data.staffNotOnNightShift);
staffOnLeave = data.staffOnLeave || {};
staffLanguages = data.staffLanguages || {};
genderDistribution = data.genderDistribution || {};
staffPairRestrictions = data.staffPairRestrictions || [];
pregnantStaff = data.pregnantStaff || {};
cycleStartDate = new Date(data.cycleStartDate);
cycleEndDate = new Date(data.cycleEndDate);
previousGenerations = data.previousGenerations || [];

initializeDepartments();
initializeShifts();
populateDepartmentSelect();
updateStaffList();
updateSupervisorSelect();
updateScheduleTable();
updatePreviousGenerations();

document.getElementById('cycleStartDate').value = formatDateForInput(cycleStartDate);
document.getElementById('cycleEndDate').value = formatDateForInput(cycleEndDate);

console.log('Data loaded successfully');
} else {
console.log('No data found');
}
})
.catch((error) => console.error('Error loading data:', error));
showTooltip('Data loaded from Firebase');
}

// Export Excel
function exportExcel() {
const wb = XLSX.utils.book_new();
const ws_data = [
['Date', 'Day', 'Department', ...shifts.map(s => `${s.name} (${s.minStaff})`)]
];

const groupedSchedule = schedule.reduce((acc, entry) => {
const key = `${formatDate(entry.date)}-${entry.department}`;
if (!acc[key]) acc[key] = {
date: entry.date,
department: entry.department,
shifts: {}
};
if (!acc[key].shifts[entry.shift]) acc[key].shifts[entry.shift] = [];
acc[key].shifts[entry.shift] = acc[key].shifts[entry.shift].concat(entry.staff);
return acc;
},
{});

Object.values(groupedSchedule).forEach(entry => {
const dayName = getDayName(entry.date);
const row = [
formatDate(entry.date),
dayName,
entry.department,
...shifts.map(s => entry.shifts[s.name] ? entry.shifts[s.name].join(', '): '')
];
ws_data.push(row);
});

const ws = XLSX.utils.aoa_to_sheet(ws_data);
XLSX.utils.book_append_sheet(wb,
ws,
"Schedule");
XLSX.writeFile(wb,
"ISOD_Schedule.xlsx");
}

// Import Excel
function importExcel() {
const file = document.getElementById('excelFile').files[0];
if (!file) {
showFancyAlert("Please select an Excel file to import.");
return;
}
const reader = new FileReader();
reader.onload = function(e) {
const data = new Uint8Array(e.target.result);
const workbook = XLSX.read(data, {
type: 'array'
});
const sheetName = workbook.SheetNames[0];
const worksheet = workbook.Sheets[sheetName];
const jsonData = XLSX.utils.sheet_to_json(worksheet, {
header: 1
});

schedule = [];
supervisors.clear();
weekdaySupervisors.clear();

// Reset staff based on departments
Object.keys(staff).forEach(dept => {
staff[dept] = [];
});

// Process schedule data
for (let i = 1; i < jsonData.length; i++) {
const row = jsonData[i];
if (row && row.length >= 4) {
const dateStr = row[0];
const dayName = row[1];
const dept = row[2];
const dateParts = dateStr.split('-');
const date = new Date(`${dateParts[1]}-${dateParts[0]}-${dateParts[2]}`);
shifts.forEach((shift, index) => {
const staffNames = row[3 + index] ? row[3 + index].split(',').map(s => s.trim()): [];
staffNames.forEach(name => {
if (name) {
if (!staff[dept].some(s => s.name.toLowerCase() === name.toLowerCase())) {
// Add new staff if not exists
staff[dept].push({
name,
preferences: shifts.map(s => ({
name: s.name, days: 0
})),
gender: '',
role: 'n',
leaveDays: [],
weekendsOff: 0,
nightShifts: 0,
pregnantUntil: null,
languages: [],
maxConsecutiveNightShifts: 3
});
}
// Assign role based on existing supervisor list
const staffMember = staff[dept].find(s => s.name.toLowerCase() === name.toLowerCase());
if (supervisors.has(staffMember.name)) {
staffMember.role = 's';
weekdaySupervisors.add(staffMember.name);
}
schedule.push({
date,
department: dept,
staff: [name],
shift: shift.name
});
}
});
});
}
}

updateStaffList();
updateSupervisorSelect();
updateScheduleTable();
closeOverlay('importOverlay');
saveToFirebase();
};
reader.readAsArrayBuffer(file);
}

// Capture table image
function captureTableImage() {
html2canvas(document.getElementById('scheduleTable')).then(canvas => {
const link = document.createElement('a');
link.download = 'schedule_table.png';
link.href = canvas.toDataURL();
link.click();
});
}

// Generate PDF
function generatePDF() {
const element = document.getElementById('scheduleTable');
html2pdf()
.from(element)
.save('schedule.pdf');
}

// Batch update
function batchUpdate() {
const field = document.getElementById('batchUpdateField').value;
const value = document.getElementById('batchUpdateValue').value;
const selectedRows = Array.from(document.querySelectorAll('#scheduleTable tr.selected'));

if (selectedRows.length === 0) {
showFancyAlert("Please select rows to update.");
return;
}

selectedRows.forEach(row => {
const date = row.cells[0].textContent;
const department = row.cells[2].textContent;

schedule.forEach(entry => {
if (formatDate(entry.date) === date && entry.department === department) {
if (field === 'shift') {
entry.shift = value;
} else if (field === 'department') {
entry.department = value;
}
}
});
});

updateScheduleTable();
saveToFirebase();
document.getElementById('batchUpdateMessage').textContent = `Updated ${selectedRows.length} rows`;
}

function showTab(tabName) {
const tabs = document.getElementsByClassName('tab-content');
for (let tab of tabs) {
tab.style.display = 'none';
}
document.getElementById(tabName + 'Tab').style.display = 'block';

const buttons = document.getElementsByClassName('tab-button');
for (let button of buttons) {
button.classList.remove('active');
}
event.target.classList.add('active');

if (tabName === 'stats') {
generateStats();
}
}


// Modified generateStats function
function generateStats() {
const statsTab = document.getElementById('statsTab');
statsTab.innerHTML = '<h2>Schedule Statistics</h2>';

const iframe = document.createElement('iframe');
iframe.className = 'stats-iframe';
statsTab.appendChild(iframe);

const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
iframeDoc.body.innerHTML = `
<table class="stats-table">
<thead>
<tr>
<th>Name</th>
<th>Weekend Offs</th>
<th>Morning</th>
<th>Mid-Morning</th>
<th>Afternoon</th>
<th>Night</th>
<th>Action</th>
</tr>
</thead>
<tbody id="statsTableBody"></tbody>
</table>
`;

const staffStats = calculateStaffStats();
const tableBody = iframeDoc.getElementById('statsTableBody');

for (const [staffName, stats] of Object.entries(staffStats)) {
const row = iframeDoc.createElement('tr');
row.innerHTML = `
<td>${staffName}</td>
<td>${stats.weekendOffs}</td>
<td>${stats.morningShifts}</td>
<td>${stats.midMorningShifts}</td>
<td>${stats.afternoonShifts}</td>
<td>${stats.nightShifts}</td>
<td><button class="refix-button" onclick="parent.refixStaff('${staffName}')">Refix</button></td>
`;
tableBody.appendChild(row);
}

// Apply styles to the iframe content
const style = iframeDoc.createElement('style');
style.textContent = `
body { font-family: Arial, sans-serif; font-size: 12px; }
.stats-table { width: 100%; border-collapse: collapse; }
.stats-table th, .stats-table td { border: 1px solid #ddd; padding: 5px; text-align: center; }
.stats-table tr:nth-child(even) { background-color: #f2f2f2; }
.refix-button { background-color: #4CAF50; color: white; border: none; padding: 2px 5px; cursor: pointer; font-size: 10px; }
`;
iframeDoc.head.appendChild(style);
}

// New function to refix individual staff schedule
function refixStaff(staffName) {
// Implement the logic to refix the schedule for the specific staff member
console.log(`Refixing schedule for ${staffName}`);
// You can add your refixing logic here
showFancyAlert(`Schedule refixed for ${staffName}`);
generateStats(); // Regenerate stats after refixing
}

// Modified calculateStaffStats function
function calculateStaffStats() {
const staffStats = {};

schedule.forEach(entry => {
const date = new Date(entry.date);
const isWeekend = date.getDay() === 0 || date.getDay() === 6;

entry.staff.forEach(staffName => {
if (!staffStats[staffName]) {
staffStats[staffName] = {
weekendOffs: 0,
morningShifts: 0,
midMorningShifts: 0,
afternoonShifts: 0,
nightShifts: 0
};
}

if (isWeekend && !entry.staff.includes(staffName)) {
staffStats[staffName].weekendOffs++;
}

switch (entry.shift) {
case 'Morning':
staffStats[staffName].morningShifts++;
break;
case 'Mid-Morning':
staffStats[staffName].midMorningShifts++;
break;
case 'Afternoon':
staffStats[staffName].afternoonShifts++;
break;
case 'Night':
staffStats[staffName].nightShifts++;
break;
}
});
});

return staffStats;
}


function fixSchedule() {
// Implement schedule fixing logic here
// This could involve reassigning staff to their preferred shifts
// and ensuring each staff member works their required number of days
showFancyAlert('Schedule fixing functionality to be implemented');
}


// Show feedback form
function showFeedbackForm() {
document.getElementById('feedbackContainer').style.display = 'block';
}

// Close feedback form
function closeFeedbackForm() {
document.getElementById('feedbackContainer').style.display = 'none';
}

// Submit feedback
function submitFeedback() {
const feedback = document.getElementById('feedbackText').value;
if (feedback.trim() === '') {
showFancyAlert('Please enter your feedback before submitting.');
return;
}
// Here you would typically send the feedback to a server
console.log('Feedback submitted:', feedback);
showFancyAlert('Thank you for your feedback!');
closeFeedbackForm();
}

function toggleChatVisibility() {
    const chatContent = document.getElementById('chatContent');
    chatContent.style.display = chatContent.style.display === 'none' ? 'block' : 'none';
}

// Replace showFancyAlert() calls with this function
function showWarning(message) {
const warningContainer = document.getElementById('warningContainer');
const warningElement = document.createElement('div');
warningElement.className = 'warning';
warningElement.textContent = message;
warningContainer.appendChild(warningElement);

// Remove the warning after 5 seconds
setTimeout(() => {
warningContainer.removeChild(warningElement);
}, 5000);
}

// Start tutorial
function startTutorial() {
const tour = new Shepherd.Tour({
defaultStepOptions: {
cancelIcon: {
enabled: true
},
classes: 'shepherd-theme-arrows'
}
});

tour.addStep({
id: 'welcome',
text: 'Welcome to the ISOD Staff Scheduling System! Let\'s take a quick tour.',
buttons: [{
text: 'Next',
action: tour.next
}]
});

tour.addStep({
id: 'departments',
text: 'Here you can manage departments and shifts.',
attachTo: {
element: '.department-shift-container',
on: 'bottom'
},
buttons: [{
text: 'Back',
action: tour.back
},
{
text: 'Next',
action: tour.next
}]
});

tour.addStep({
id: 'staff',
text: 'Add and manage staff members here.',
attachTo: {
element: '#staffList',
on: 'top'
},
buttons: [{
text: 'Back',
action: tour.back
},
{
text: 'Next',
action: tour.next
}]
});

tour.addStep({
id: 'schedule',
text: 'Generate and view the schedule in this section.',
attachTo: {
element: '.schedule-container',
on: 'top'
},
buttons: [{
text: 'Back',
action: tour.back
},
{
text: 'Finish',
action: tour.complete
}]
});

tour.start();
}

// Add this to your JavaScript
const greetings = [
"Have a great day!",
"Smile and shine!",
"Make today amazing!",
"Embrace the day's potential!",
"Spread positivity today!"
];

function updateGreeting() {
const dateElement = document.getElementById('currentDate');
const messageElement = document.getElementById('greetingMessage');
const now = new Date();

dateElement.textContent = now.toLocaleDateString('en-US', {
month: 'short', day: 'numeric'
});
messageElement.textContent = greetings[Math.floor(Math.random() * greetings.length)];
}

function toggleGreeting() {
const carousel = document.querySelector('.greeting-carousel');
carousel.style.display = carousel.style.display === 'none' ? 'flex': 'none';
}

// Call this function to initialize the greeting
updateGreeting();

// Update the greeting every day
setInterval(updateGreeting, 24 * 60 * 60 * 1000);

// Add event listener to the toggle button
document.querySelector('.greeting-toggle').addEventListener('click',
toggleGreeting);

// Initialize the application when the page loads
window.onload = function() {
// Check if the user is already logged in
firebase.auth().onAuthStateChanged(function(user) {
if (user) {
// User is signed in, show main content
document.getElementById('mainContent').style.display = 'block';
document.getElementById('loginForm').style.display = 'none';
initializeApp();
} else {
// No user is signed in, show login form
document.getElementById('mainContent').style.display = 'none';
document.getElementById('loginForm').style.display = 'block';
document.getElementById('loginModal').style.display
= 'block';
}
});
};

const adImages = [
"https://pfst.cf2.poecdn.net/base/image/0dc9069000123086cea600dd48bb1e9c59766d8d873109a5eb96ed96553a2349?w=1024&h=768&pmaid=168860672",
"https://pfst.cf2.poecdn.net/base/image/bae8681671aba1845ac587399689943d567687de1c4df4317384bfedb6e1c53b?w=1024&h=768&pmaid=168863441",
"https://pfst.cf2.poecdn.net/base/image/485b98d01ef23589bb782e148f9f084e0601d8d2880fc17deda75cf593f25fc5?w=1024&h=768&pmaid=168882048",
"https://pfst.cf2.poecdn.net/base/image/6a40a073a53e45474602419238321bc5276afcfc330eab1216a9c75bcc95d1f9?w=1024&h=768&pmaid=168890364",
"https://pfst.cf2.poecdn.net/base/image/bf65121a4356296cc3b921a827627b873ebd46de6e7ad1b2d7ead78832fb3731?w=1024&h=768&pmaid=168898041"
];

let currentAdIndex = 0;

function initAdCarousel() {
const adContainer = document.querySelector('.ad-container');
adImages.forEach((src, index) => {
const img = document.createElement('img');
img.src = src;
img.style.display = index === 0 ? 'block': 'none';
adContainer.appendChild(img);
});

setInterval(nextAd,
5000); // Change ad every 5 seconds
}

function nextAd() {
const adContainer = document.querySelector('.ad-container');
const ads = adContainer.querySelectorAll('img');
ads[currentAdIndex].style.display = 'none';
currentAdIndex = (currentAdIndex + 1) % ads.length;
ads[currentAdIndex].style.display = 'block';
}

document.querySelector('.ad-button').addEventListener('click', () => {
// Add your ad click functionality here
showFancyAlert('Ad clicked!');
});

initAdCarousel();

// Add dark mode toggle to hamburger menu
function addDarkModeToggle() {
const dropdownContent = document.querySelector('.dropdown-content');
const darkModeLink = document.createElement('a');
darkModeLink.href = '#';
darkModeLink.innerHTML = '<i class="fas fa-moon"></i> Toggle Dark Mode';
darkModeLink.onclick = toggleDarkMode;
dropdownContent.appendChild(darkModeLink);
}

// Call this function after the page loads
window.addEventListener('load', addDarkModeToggle);


// New UI feature: Dark mode toggle
// Modify toggleDarkMode function
// Modify the existing toggleDarkMode function
function toggleDarkMode() {
document.body.classList.toggle('dark-mode');
const isDarkMode = document.body.classList.contains('dark-mode');
localStorage.setItem('darkMode',
isDarkMode);

// Update checkbox in settings
document.getElementById('darkModeToggle').checked = isDarkMode;

showTooltip(isDarkMode ? 'Dark mode enabled': 'Dark mode disabled');
}

// Check for saved dark mode preference
// Initialize dark mode
if (localStorage.getItem('darkMode') === 'true') {
document.body.classList.add('dark-mode');
}

// Add dark mode toggle button to the UI
/*const darkModeButton = document.createElement('button');
darkModeButton.textContent = 'Toggle Dark Mode';
darkModeButton.onclick = toggleDarkMode;
document.body.appendChild(darkModeButton);*/

// Make sure to call these functions to initialize new features
document.addEventListener('DOMContentLoaded',
function() {
/*
            // Add chat toggle button to the header
            const header = document.querySelector('.header');
            const chatToggle = document.createElement('button');
            chatToggle.innerHTML = '<i class="fas fa-comments"></i>';
            chatToggle.onclick = toggleChatBar;
            header.appendChild(chatToggle);*/

initAdCarousel();
updateGreeting();
setInterval(updateGreeting, 24 * 60 * 60 *
1000); // Update greeting daily

// Initialize other features...
});

   const greetingAdCarousel = document.getElementById('greetingAdCarousel');
        const carouselItems = [];

        function initGreetingAdCarousel() {
            adImages.forEach((src, index) => {
                const item = document.createElement('div');
                item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                item.innerHTML = `
                    <img src="${src}" class="carousel-image" alt="Greeting ${index + 1}">
                    <div class="greeting-overlay">
                        <div class="greeting-date" id="greetingDate${index}"></div>
                        <div class="greeting-message">${greetings[index]}</div>
                    </div>
                `;
                greetingAdCarousel.appendChild(item);
                carouselItems.push(item);
            });

            const dots = document.createElement('div');
            dots.className = 'carousel-dots';
            adImages.forEach((_, index) => {
                const dot = document.createElement('div');
                dot.className = `dot ${index === 0 ? 'active' : ''}`;
                dot.onclick = () => goToSlide(index);
                dots.appendChild(dot);
            });
            greetingAdCarousel.appendChild(dots);

            updateGreetingDates();
            setInterval(nextSlide, 5000);
        }

        function updateGreetingDates() {
            const now = new Date();
            carouselItems.forEach((item, index) => {
                const dateElement = item.querySelector(`#greetingDate${index}`);
                dateElement.textContent = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
        }

        let currentSlide = 0;

        function nextSlide() {
            goToSlide((currentSlide + 1) % carouselItems.length);
        }

        function goToSlide(n) {
            carouselItems[currentSlide].classList.remove('active');
            document.querySelectorAll('.dot')[currentSlide].classList.remove('active');
            currentSlide = n;
            carouselItems[currentSlide].classList.add('active');
            document.querySelectorAll('.dot')[currentSlide].classList.add('active');
        }

        function toggleForums() {
            document.getElementById('forumsPanel').classList.toggle('open');
        }

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('open');
        }

        function sendMessage() {
            const input = document.getElementById('forumsInput');
            const message = input.value.trim();
            if (message) {
                const messagesContainer = document.getElementById('forumsMessages');
                const messageElement = document.createElement('div');
                messageElement.textContent = message;
                messagesContainer.appendChild(messageElement);
                input.value = '';
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
         // Check if user is a Centaur
        function checkIfCentaur(user) {
            firebase.database().ref('centaurs/' + user.uid).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        user.isCentaur = true;
                        showFancyAlert('Welcome, Centaur!');
                        addCentaurBadge();
                    }
                });
        }

        // Add Centaur badge to the UI
        function addCentaurBadge() {
            const badge = document.createElement('span');
            badge.className = 'centaur-badge';
            badge.textContent = 'Centaur';
            document.querySelector('.header').appendChild(badge);
        }

        // Chat system functions
        function toggleChatSystem() {
            const chatSystem = document.getElementById('chatSystem');
            chatSystem.style.display = chatSystem.style.display === 'none' ? 'flex' : 'none';
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageElement = document.createElement('div');
                messageElement.textContent = message;
                messagesContainer.appendChild(messageElement);
                input.value = '';
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // If the user is a Centaur and the message starts with "/push", treat it as a push notification
                if (currentUser.isCentaur && message.startsWith('/push')) {
                    sendPushNotification(message.slice(6));
                }
            }
        }

        // Send push notification (for Centaurs)
        function sendPushNotification(message) {
            // In a real-world scenario, you'd send this to a server to handle push notifications
            // For this example, we'll just show it as a fancy alert
            showFancyAlert('Push Notification Sent: ' + message);
        }

        // Fancy Alert function
        function showFancyAlert(message) {
            const alertBox = document.getElementById('fancyAlert');
            alertBox.textContent = message;
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 3000);
        }


        function startVoiceInput() {
            // Implement voice input functionality here
            showFancyAlert('Voice input feature to be implemented');
        }

        // Initialize the greeting-ad carousel when the page loads
        window.addEventListener('load', initGreetingAdCarousel);


</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISOD Staff Scheduling System</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- XLSX for Excel import/export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <!-- HTML2Canvas and html2pdf for capturing and generating PDFs -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Shepherd for onboarding tutorial -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@9.1.1/dist/css/shepherd.css" />
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@9.1.1/dist/js/shepherd.min.js"></script>
    <!-- DataTables for enhanced table functionality -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <!-- SortableJS for drag-and-drop functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
:root {
        --dark-blue: #1a2a3a;
        --yellow: #329208;
        --text-color: #ffffff;
        --border-color: rgba(255, 255, 255, 0.2);
        --highlight-color: rgba(255, 215, 0, 0.2);
        --supervisor-color: #ff4500;
        --morning-color: #87CEEB;
        --midmorning-color: #00CED1;
        --afternoon-color: #FFA500;
        --night-color: #4B0082;
        --overlay-bg: rgba(26, 42, 58, 0.95);
        --button-hover: #e6c200;
        --table-header: rgba(255, 255, 255, 0.1);
        --week-separator-bg: var(--yellow);
        --week-separator-text: var(--dark-blue);
    }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--dark-blue);
            color: var(--text-color);
            font-size: 14px;
            background-image: url('https://pfst.cf2.poecdn.net/base/image/2ee0c5b959e51b25b9c8df43d2b4498a32304a9f173f78b251faf1850dc9e2cf?w=1024&h=576&pmaid=160532020');
            background-size: cover;
            background-attachment: fixed;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--overlay-bg);
            z-index: -1;
        }
        .container {
            max-width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }
        h1, h2 {
            color: var(--yellow);
            margin: 10px 0;
            text-align: center;
        }
        input, select, button, textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: none;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-size: 14px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--yellow);
        }
        button {
            background-color: var(--yellow);
            color: var(--dark-blue);
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: var(--button-hover);
        }
        .scroll-container {
            display: flex;
            overflow-x: auto;
            padding: 5px 0;
            gap: 5px;
        }
        .scroll-item {
            flex: 0 0 auto;
            padding: 5px 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        .scroll-item.active {
            background-color: var(--yellow);
            color: var(--dark-blue);
        }
        .staff-card {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 8px;
            margin-right: 5px;
            min-width: 150px;
            font-size: 12px;
        }
        .staff-card h3 {
            margin: 0 0 5px 0;
            font-size: 14px;
        }
        .supervisor {
            color: var(--supervisor-color);
            font-weight: bold;
        }
        .schedule-container {
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-top: 10px;
            max-height: 600px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            background-color: var(--dark-blue);
            color: var(--text-color);
            font-size: 12px;
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 5px;
            text-align: center;
            vertical-align: middle;
        }
        th {
            background-color: var(--table-header);
            position: sticky;
            top: 0;
            z-index: 2;
        }
        .editable:focus {
            background-color: rgba(255, 255, 255, 0.2);
            outline: none;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        .overlay-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--dark-blue);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            font-size: 24px;
            color: var(--text-color);
        }
        .preference-container {
            margin-bottom: 10px;
        }
        .preference-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        .preference-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--yellow);
            cursor: pointer;
            box-shadow: 0 0 0 3px var(--dark-blue), 0 0 0 6px var(--yellow);
        }
        .preference-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--yellow);
            cursor: pointer;
            box-shadow: 0 0 0 3px var(--dark-blue), 0 0 0 6px var(--yellow);
        }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .add-icon {
            cursor: pointer;
            font-size: 16px;
            color: var(--yellow);
        }
        .warninga {
            background-color: rgba(255, 215, 0, 0.2);
            border: 1px solid var(--yellow);
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .warning {
            background-color: rgba(255, 215, 0, 0.2);
            border: 1px solid var(--yellow);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .supervisor-select {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .supervisor-option {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        .supervisor-option.selected {
            background-color: var(--yellow);
            color: var(--dark-blue);
        }
        .calendar-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .calendar-bar input[type="date"] {
            background-color: transparent;
            border: none;
            color: var(--text-color);
            font-size: 12px;
        }
        /* Updated search container styles */
        .search-container {
            position: relative;
            margin-bottom: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .search-container input {
            padding-left: 25px;
        }
        .search-icon {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color);
            font-size: 12px;
        }
        /* Add these styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }


        .chat-toggle, .chat-close {
            background: none;
            border: none;
            color: var(--yellow);
            font-size: 24px;
            cursor: pointer;
        }
        .hamburger {
            font-size: 24px;
            cursor: pointer;
            color: var(--yellow);
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--dark-blue);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            right: 0;
        }
        .dropdown-content a {
            color: var(--text-color);
            padding: 10px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .dropdown-content a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
        .cycle-setter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .cycle-setter i {
            font-size: 20px;
            color: var(--yellow);
        }
        .department-shift-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .department-shift-section {
            margin-bottom: 10px;
        }
        .highlighted {
            background-color: var(--highlight-color);
        }
        .week-separator {
            background-color: var(--week-separator-bg);
            color: var(--week-separator-text);
            font-weight: bold;
            text-align: center;
            padding: 8px;
            font-size: 16px;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        .preference-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .preference-input input[type="number"] {
            width: 60px;
        }
        .previous-generations {
            display: flex;
            overflow-x: auto;
            padding: 10px 0;
            gap: 10px;
        }
        .generation-item {
            flex: 0 0 auto;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            position: relative;
            transition: background-color 0.3s;
        }
        .generation-item:hover {
            background-color: rgba(255, 215, 0, 0.3);
        }
        .generation-item .trash-icon {
            color: var(--yellow);
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
        }
        .staff-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            background-color: var(--supervisor-color);
            color: var(--text-color);
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            margin: 2px;
            cursor: pointer;
        }
        .progress-bar {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            height: 5px;
            margin-top: 5px;
        }

        .progress {
            height: 100%;
            background-color: green;
            transition: width 0.3s ease;
        }
        .active-users {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .active-user {
            display: inline-block;
            margin-right: 10px;
            padding: 5px 10px;
            background-color: var(--yellow);
            color: var(--dark-blue);
            border-radius: 15px;
            font-size: 12px;
        }
        .feedback-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--dark-blue);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            display: none;
        }
        .feedback-container textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
        }
        .feedback-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--yellow);
            color: var(--dark-blue);
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        .batch-update-container {
            margin-bottom: 20px;
        }
        .batch-update-container select, .batch-update-container input {
            margin-right: 10px;
            width: auto;
        }
        .error-message {
            color: #ff6b6b;
            margin-top: 5px;
            font-size: 12px;
        }
        .success-message {
            color: #51cf66;
            margin-top: 5px;
            font-size: 12px;
        }
        .sortable {
            cursor: pointer;
        }

        .sortable:hover {
            background-color: var(--highlight-color);
        }

        .selected {
            background-color: var(--highlight-color);
        }

        .totals-row {
            font-weight: bold;
            background-color: var(--table-header);
        }
        .staff-name {
            display: inline-block;
            margin-right: 5px;
            font-size: 12px;
        }
        .supervisor {
            font-weight: bold;
            color: #ff4500;
        }

        .schedule-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            cursor: pointer;
        }

        .tab-button.active {
            border-bottom: 2px solid var(--yellow);
        }

        .tab-content {
            padding: 20px;
        }

        body.dark-mode {
            background-color: #201e22;
            color: #fff;
        }

        body.dark-mode .card,
        body.dark-mode .overlay-content {
            background-color: #1c1c1c;
        }

        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode button {
            background-color: #0f0f0f;
            color: #fff;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: var(--dark-blue);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            width: 80%;
            max-width: 900px;
            border-radius: 10px;
        }

        .close {
            color: var(--text-color);
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: var(--yellow);
            text-decoration: none;
            cursor: pointer;
        }

        .search-replace-container {
            margin-bottom: 10px;
        }

        .search-replace-container input {
            margin-right: 10px;
        }

        .expand-icon {
            cursor: pointer;
            font-size: 20px;
            color: var(--yellow);
        }

        /* Settings Modal Styles */
        /* Updated settings modal styles */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
            display: none;
        }

        .settings-content {
            background-color: var(--dark-blue);
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
        }


        .settings-header {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Highlight style for search results */
        .highlight-cell {
            background-color: rgba(91,0,255,0.3) !important;
        }

        /* Find All results container */
        .find-all-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .back-arrow {
            font-size: 24px;
            margin-right: 20px;
            cursor: pointer;
            color: var(--yellow);
        }

        .settings-content {
            padding: 20px;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h2 {
            margin-bottom: 15px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .setting-icon {
            font-size: 20px;
            margin-right: 15px;
            color: var(--yellow);
        }

        /* Update the about overlay styles */
        .about-overlay {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background-color: var(--dark-blue);
            transition: right 0.3s ease-in-out;
            z-index: 1001;
            overflow-y: auto;
        }

        .about-content {
            padding: 20px;
            color: var(--text-color);
        }

        .about-overlay.active {
            right: 0;
        }

        /* Tooltip Styles */
        .tooltip {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: var(--dark-blue);
            color: var(--text-color);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            font-size: 14px;
            max-width: 250px;
        }
        
        /* Login Modal */
                /* Login Modal Styles */
        .login-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }
             .login-modal-content {
            background-color: var(--dark-blue);
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            color: var(--text-color);
        }
                /* Chat System Styles */
        .chat-system {
	          display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 400px;
            background-color: var(--dark-blue);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
    
.chat-content {
    display: none;
}


        #scheduleTable {
            width: 100%;
            border-collapse: collapse;
        }
        #scheduleTable th, #scheduleTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #scheduleTable th {
            background-color: #f2f2f2;
        }
        #scheduleTable th {
            background-color: #480e83;
            color: #333;
        }
        .week-separator {
            background-color: #e6f2ff;
            font-weight: bold;
            text-align: center;
        }
        .shift-cell {
            max-width: none;
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
        }
        mark {
            background-color: #00ff90;
            color: #9d38fc;
        }

        .group {
            background-color: var(--week-separator-bg);
            font-weight: bold;
        }
        .tutorial-highlight {
            box-shadow: 0 0 0 2px var(--yellow);
        }
        
        /* new header styles */
        
        
        .header-icon {
            font-size: 24px;
            color: var(--yellow);
            cursor: pointer;
        }

        
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }
        
                .greeting-ad-carousel {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .carousel-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .carousel-item.active {
            opacity: 1;
        }

        .carousel-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }


        /* New styles for the chat bar */
        .chat-bar {
            width: 300px;
            height: 100%;
            position: fixed;
            top: 0;
            left: -300px;
            background-color: var(--dark-blue);
            transition: left 0.3s ease-in-out;
            z-index: 1000;
        }

        .chat-bar.open {
            left: 0;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--yellow);
            color: var(--dark-blue);
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-input {
            display: flex;
            padding: 10px;
        }
        .chat-input input {
            flex-grow: 1;
            margin-right: 10px;
        }
        
                /* Fancy Alert Box Styles */
        .fancy-alert {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--dark-blue);
            color: var(--text-color);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Centaur Badge */
        .centaur-badge {
            background-color: var(--yellow);
            color: var(--dark-blue);
            padding: 2px 5px;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 5px;
        }

        .chat-input button {
            background-color: transparent;
            border: none;
            color: var(--yellow);
            font-size: 20px;
            cursor: pointer;
        }

        .ad-carousel {
            position: relative;
            width: 100%;
            height: 200px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .ad-container {
            width: 100%;
            height: 100%;
        }

        .ad-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ad-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: var(--yellow);
            color: var(--dark-blue);
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }

        /* Styles for the stats table */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .stats-table th, .stats-table td {
            border: 1px solid var(--border-color);
            padding: 5px;
            text-align: center;
        }

        .stats-table tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .stats-iframe {
            width: 100%;
            height: 400px;
            border: none;
        }

        .refix-button {
            background-color: var(--yellow);
            color: var(--dark-blue);
            border: none;
            padding: 2px 5px;
            cursor: pointer;
            font-size: 10px;
        }

        .greeting-carousel {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .greeting-content {
            display: flex;
            flex-direction: column;
        }

        .greeting-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .greeting-date {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .greeting-message {
            font-size: 32px;
            font-style: italic;
        }

        .greeting-toggle {
            background: none;
            border: none;
            color: var(--yellow);
            font-size: 18px;
            cursor: pointer;
        }

.carousel-dots {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.5);
            margin: 0 5px;
            cursor: pointer;
        }

        .dot.active {
            background-color: white;
        }

        .forums-panel {
            position: fixed;
            left: -300px;
            top: 0;
            width: 300px;
            height: 100%;
            background-color: var(--dark-blue);
            transition: left 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }

        .forums-panel.open {
            left: 0;
        }

        .forums-header {
            padding: 10px;
            background-color: var(--yellow);
            color: var(--dark-blue);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .forums-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background-image: url('path/to/your/chat-background-image.jpg');
            background-size: cover;
        }

        .forums-input {
            display: flex;
            padding: 10px;
            background-color: rgba(255,255,255,0.1);
        }

        .forums-input input {
            flex-grow: 1;
            margin-right: 10px;
        }

        .forums-input button {
            background: none;
            border: none;
            color: var(--yellow);
            font-size: 20px;
            cursor: pointer;
        }

        .settings-panel {
            position: fixed;
            right: -300px;
            top: 0;
            width: 300px;
            height: 100%;
            background-color: var(--dark-blue);
            transition: right 0.3s ease-in-out;
        }

        .settings-panel.open {
            right: 0;
        }

@media (max-width: 1024px) {
            .schedule-container {
                max-height: 400px;
            }
        }
@media (max-width: 768px) {
            .cycle-setter {
                flex-direction: column;
                align-items: flex-start;
            }
            .calendar-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            .schedule-container {
                max-height: 300px;
            }
        }
@media (max-width: 600px) {
            .schedule-container {
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="main-header">
						
						<h1 class="header-icon">        🌵ISOD Staff Scheduler</h1>
            
            <button class="chat-toggle"
            onclick="toggleChatBar()"><i
            class="fas fa-paper-plane
            header-icon"></i></button>
            
            <div class="dropdown">
                <span class="hamburger header-icon">&#9776;</span>
                <div class="dropdown-content">
                    <a href="#" onclick="showImportOverlay()"><i class="fas fa-file-import"></i> Import Excel</a>
                    <a href="#" onclick="exportExcel()"><i class="fas fa-file-export"></i> Export Excel</a>
                    <a href="#" onclick="saveToFirebase()"><i class="fas fa-save"></i> Save Schedule</a>
                    <a href="#" onclick="loadFromFirebase()"><i class="fas fa-folder-open"></i> Load Schedule</a>
                    <a href="#" onclick="captureTableImage()"><i class="fas fa-camera"></i> Capture Table</a>
                    <a href="#" onclick="generatePDF()"><i class="fas fa-file-pdf"></i> Generate PDF</a>
                    <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    <a href="#" onclick="skipLogin()"><i class="fas fa-forward"></i> Skip Login</a>
                    <a href="#" onclick="startTutorial()"><i class="fas fa-question-circle"></i> Start Tutorial</a>
                </div>
            </div>
            
            
        </div>
    </header>
    
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-modal-content">
            <h2>Login</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()">Login</button>
            <button onclick="showSignUpForm()">Sign Up</button>
            <button onclick="skipLogin()">Skip Login</button>
        </div>
    </div>



    <!-- Fancy Alert Box -->
    <div id="fancyAlert"
    class="fancy-alert"></div>
    

    <div id="loginForm" style="display: none;">
        <h2>Login</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <button onclick="showSignUpForm()">Sign Up</button>
        <button onclick="skipLogin()">Skip Login</button>
    </div>

    <div id="signUpForm" style="display: none;">
        <h2>Sign Up</h2>
        <input type="email" id="signUpEmail" placeholder="Email">
        <input type="password" id="signUpPassword" placeholder="Password">
        <button onclick="signUp()">Sign Up</button>
        <button onclick="showLoginForm()">Back to Login</button>
    </div>

    <div id="onboardingScreens" style="display: none;">
        <div id="onboardingContent">
            <!-- Onboarding content will be populated here -->
        </div>
        <div style="text-align: center;">
            <button onclick="prevOnboarding()">Previous</button>
            <button onclick="nextOnboarding()">Next</button>
            <button onclick="skipOnboarding()">Skip</button>
        </div>
    </div>

    <div id="mainContent" style="display: none;">
        <div class="active-users" id="activeUsers">
            <!-- Active users will be populated here -->
        </div>

        <div class="chat-bar" id="chatBar">
            <div class="chat-header">
                <span>Chat</span>
                <button class="chat-close" onclick="toggleChatBar()"><i class="fas fa-times"></i></button>
            </div>
            <!-- Rest of your chat bar content -->
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Type a message...">
                <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        <!--
            <div class="greeting-ad-carousel" id="greetingAdCarousel">
        <!-- Carousel items will be dynamically added here 
    </div> -->
    
    <div class="forums-panel" id="forumsPanel">
        <div class="forums-header">
            <span>Forums</span>
            <i class="fas fa-times" onclick="toggleForums()"></i>
        </div>
        <div class="forums-messages" id="forumsMessages"></div>
        <div class="forums-input">
            <input type="text" id="forumsInput" placeholder="Type a message...">
            <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            <button onclick="startVoiceInput()"><i class="fas fa-microphone"></i></button>
        </div>
    </div>
    
<div class="settings-panel" id="settingsPanel">
        <!-- Settings content -->
    </div>
    
				<!--
        <div class="ad-carousel">
            <div class="ad-container">
                <!-- Ad images will be inserted here dynamically 
            </div>
            <button class="ad-button">View Ad</button>
        </div> -->


        <!-- Add this before the
            department-shift-container -->
        <div class="greeting-carousel">
            <div class="greeting-content">
                <div class="greeting-date">
                    <i class="fas fa-calendar-alt"></i> <span id="currentDate"></span>
                </div>
                <div class="greeting-message" id="greetingMessage"></div>
            </div>
            <!--
            <div class="carousel-dots">
                <span class="dot active"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div> -->
        </div>

        <div class="card">
            <div class="department-shift-container">
                <div class="department-shift-section">
                    <div class="section-header">
                        <h2><i class="fas fa-building"></i> Departments</h2>
                        <i class="fas fa-plus-circle add-icon" onclick="showAddDepartmentOverlay()" title="Add Department"></i>
                    </div>
                    <div class="scroll-container" id="departmentScroll">
                        <!-- Department buttons will be populated here -->
                    </div>
                </div>
                <div class="department-shift-section">
                    <div class="section-header">
                        <h2><i class="fas fa-clock"></i> Shifts</h2>
                        <i class="fas fa-plus-circle add-icon" onclick="showAddShiftOverlay()" title="Add Shift"></i>
                    </div>
                    <div class="scroll-container" id="shiftScroll">
                        <!-- Shift buttons will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Add Staff</h2>
            <select id="departmentSelect">
                <option value="">Select Department</option>
                <!-- Department options will be populated here -->
            </select>
            <textarea id="quickAddStaff" placeholder="Enter comma-separated staff names (e.g., Tosin, Leke, Juwon, Isaac)" rows="3"></textarea>
            <button onclick="quickAddStaff()">Add Staff <i class="fas fa-user-plus"></i></button>
            <button onclick="showAddStaffOverlay()">Add Individual Staff</button>
            <button onclick="useDefaultStaff()">Use Default Staff Data</button>
        </div>

        <div class="card">
            <h2>Set Supervisors</h2>
            <div class="supervisor-select" id="supervisorSelect">
                <!-- Supervisor options will be populated here -->
            </div>
            <button onclick="setSupervisors()">Update Supervisors <i class="fas fa-user-shield"></i></button>
        </div>

        <div class="card">
            <h2>Staff List</h2>
            <div class="scroll-container" id="staffList">
                <!-- Staff cards will be populated here -->
            </div>
        </div>

        <div class="card">
            <div class="cycle-setter">
                <i class="fas fa-calendar-alt"></i>
                <select id="cycleDuration">
                    <option value="4">4 Weeks</option>
                    <option value="5">5 Weeks</option>
                </select>
                <span>Cycle</span>
                <button onclick="setCycleDuration()">Set Cycle</button>
            </div>

            <div class="calendar-bar">
                <input type="date" id="cycleStartDate">
                <span>to</span>
                <input type="date" id="cycleEndDate">
            </div>
        </div>

        <!-- Updated search container -->
        <div class="card">
            <h2>Current Schedule</h2>
            <div class="search-container">
                <!-- <i class="fas fa-search
                                               search-icon"></i>-->
                <input type="text" id="searchInput"
                placeholder="🔍    Search staff...">
                <button onclick="findNext()">Find Next</button>
                <button onclick="findAll()">Find All</button>
                <span id="searchResults"></span>
            </div>
            <div id="findAllResults" class="find-all-results" style="display: none;"></div>
        </div>
        <div id="warningContainer"></div>
        <div class="batch-update-container">
            <h3>Batch Update</h3>
            <select id="batchUpdateField">
                <option value="shift">Shift</option>
                <option value="department">Department</option>
            </select>
            <input type="text" id="batchUpdateValue" placeholder="New value">
            <button
                onclick="batchUpdate()">Update</button>
            <div
                id="batchUpdateMessage"></div>
        </div>
        <!-- Add this div for warnings -->
        <div id="warningContainer"></div>
        <div class="schedule-tabs">
            <button class="tab-button active" onclick="showTab('timetable')">Timetable</button>
            <button class="tab-button" onclick="showTab('stats')">Stats</button>
        </div>
        <div id="timetableTab" class="tab-content">

            <div class="schedule-container">
                <table id="scheduleTable">
                    <!-- Schedule table will be generated here -->
                </table>
            </div>
        </div>

        <div id="statsTab" class="tab-content" style="display: none;">
            <!-- Stats content will be dynamically generated here -->
        </div>
    </div>

    <button onclick="generateSchedule()">Generate Schedule <i class="fas fa-calendar-check"></i></button>
    <button onclick="resetAllStaff()">Reset All Staff</button>

    <div class="card">
        <h2>Previous Generations</h2>
        <div class="previous-generations" id="previousGenerations">
            <!-- Previous generations will be listed here -->
        </div>
    </div>
</div>
</div>

<!-- Overlays and Modals -->
<div class="overlay" id="preferencesOverlay">
<div class="overlay-content">
<span class="close-btn" onclick="closeOverlay('preferencesOverlay')">&times;</span>
<h2>Edit Preferences</h2>
<div id="preferencesContent"></div>
<button onclick="savePreferences()">Save Preferences</button>
</div>
</div>

<div class="overlay" id="addDepartmentOverlay">
<div class="overlay-content">
<span class="close-btn" onclick="closeOverlay('addDepartmentOverlay')">&times;</span>
<h2>Add Department</h2>
<input type="text" id="newDepartment" placeholder="Department Name">
<input type="text" id="newDepartmentAbbr" placeholder="Abbreviation">
<button onclick="addDepartment()">Add Department</button>
</div>
</div>

<div class="overlay" id="addShiftOverlay">
<div class="overlay-content">
<span class="close-btn" onclick="closeOverlay('addShiftOverlay')">&times;</span>
<h2>Add Shift</h2>
<input type="text" id="newShiftName" placeholder="Shift Name">
<input type="time" id="newShiftStart" placeholder="Start Time">
<input type="time" id="newShiftEnd" placeholder="End Time">
<input type="number" id="newShiftMinStaff" placeholder="Minimum Staff" min="1">
<button onclick="addShift()">Add Shift</button>
</div>
</div>

<div class="overlay" id="importOverlay">
<div class="overlay-content">
<span class="close-btn" onclick="closeOverlay('importOverlay')">&times;</span>
<h2>Import Excel</h2>
<input type="file" id="excelFile" accept=".xlsx, .xls">
<button onclick="importExcel()">Import</button>
</div>
</div>

<div class="overlay" id="addStaffOverlay">
<div class="overlay-content">
<span class="close-btn" onclick="closeOverlay('addStaffOverlay')">&times;</span>
<h2>Add New Staff</h2>
<input type="text" id="staffName" placeholder="Staff Name">
<select id="staffGender">
<option value="">Select Gender</option>
<option value="F">Female</option>
<option value="M">Male</option>
</select>
<select id="staffRole">
<option value="n">Normal</option>
<option value="s">Supervisor</option>
</select>
<input type="text" id="staffLanguage" placeholder="Language(s) Spoken">
<input type="date" id="staffPregnantUntil" placeholder="Pregnant Until (optional)">
<input type="date" id="staffLeaveStart" placeholder="Leave Start Date">
<input type="date" id="staffLeaveEnd" placeholder="Leave End Date">
<button onclick="addIndividualStaff()">Add Staff</button>
</div>
</div>

<div class="feedback-button" onclick="showFeedbackForm()">
Feedback
</div>
<div class="feedback-container" id="feedbackContainer">
<h3>Provide Feedback</h3>
<textarea id="feedbackText" placeholder="Enter your feedback here..."></textarea>
<button onclick="submitFeedback()">Submit Feedback</button>
<button onclick="closeFeedbackForm()">Close</button>
</div>

<div id="scheduleModal" class="modal">
<div class="modal-content">
<span class="close">&times;</span>
<div class="search-replace-container">
<input type="text" id="searchInput" placeholder="Search">
<input type="text" id="replaceInput" placeholder="Replace">
<button onclick="searchAndReplace()">Replace</button>
<div class="search-container">
<!-- <i class="fas fa-search
                           search-icon"></i>-->
<input type="text" id="searchInput"
placeholder="🔍    Search staff...">
<button onclick="findNext()">Find Next</button>
<button onclick="findAll()">Find All</button>
<span id="searchResults"></span>
</div>
<input type="range" id="zoomSlider"
min="50" max="150" value="100"
oninput="zoomTable(this.value)">
<span id="zoomValue">100%</span>
</div>
<div id="modalScheduleContainer"></div>
</div>
</div>

<!-- Updated settings modal -->
<div id="settingsModal" class="settings-modal">
<div class="settings-content">
<div class="settings-header">
<i class="fas fa-arrow-left back-arrow" onclick="closeSettingsModal()"></i>
<h2>Settings</h2>
</div>
<div class="settings-section">
<h2>General</h2>
<div class="setting-item">
<i class="fas fa-moon setting-icon"></i>
<span>Dark Mode</span>
<input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
</div>
<div class="setting-item">
<i class="fas fa-info-circle setting-icon"></i>
<span>About</span>
<button onclick="showAboutInfo()">View</button>
</div>
<div id="aboutOverlay" class="about-overlay">
<div class="about-content">
<h2>About ISOD Staff Scheduling System</h2>
<p>
Version: 1.0
</p>
<p>
Developed by: Your Company
</p>
<p>
Description: A comprehensive staff scheduling system for efficient workforce management.
</p>
<button onclick="closeAboutOverlay()">Back to Settings</button>
</div>
</div>

<div class="setting-item">
<i class="fas fa-share-alt setting-icon"></i>
<span>Share</span>
<button onclick="shareSchedule()">Share</button>
</div>
</div>
<div class="settings-section">
<h2>Notifications</h2>
<div class="setting-item">
<i class="fas fa-bell setting-icon"></i>
<span>Enable Notifications</span>
<input type="checkbox" id="notificationsToggle">
</div>
</div>
<div class="settings-section">
<h2>Data Management</h2>
<div class="setting-item">
<i class="fas fa-database setting-icon"></i>
<button onclick="exportData()">Export Data</button>
</div>
<div class="setting-item">
<i class="fas fa-file-import setting-icon"></i>
<button onclick="importData()">Import Data</button>
</div>
</div>
</div>
</div>

<div id="tooltip" class="tooltip"></div>

<!-- Your JavaScript code -->
<script>
// Firebase configuration
const firebaseConfig = {
apiKey: "AIzaSyA8jrkF9TpIINymdXBDDI1yl4NuU_lsu7A",
authDomain: "isod-scheduler.firebaseapp.com",
projectId: "isod-scheduler",
storageBucket: "isod-scheduler.appspot.com",
messagingSenderId: "433265398148",
appId: "1:433265398148:web:d3fd3fe91692bd46c40dd1"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);

// Define global variables
let departments = [{
name: 'Transaction Monitoring',
abbr: 'TM'
},
{
name: 'Security Operation Center',
abbr: 'SOC2'
},
{
name: 'Fraud Desk',
abbr: 'FD'
}];
let shifts = [{
name: 'Morning',
start: '07:00',
end: '14:00',
minStaff: 15
},
{
name: 'Mid-Morning',
start: '10:00',
end: '17:00',
minStaff: 5
},
{
name: 'Afternoon',
start: '12:00',
end: '19:00',
minStaff: 14
},
{
name: 'Night',
start: '19:00',
end: '07:00',
minStaff: 8
}];
let staff = {};
let schedule = [];
let supervisors = new Set();
let weekdaySupervisors = new Set();
let weekendSupervisors = new Set();
let staffNotOnNightShift = new Set();
let staffOnLeave = {};
let staffLanguages = {};
let genderDistribution = {};
let staffPairRestrictions = [];
let pregnantStaff = {};
let currentEditingStaff = null;
let cycleStartDate = new Date();
let cycleEndDate = new Date(cycleStartDate);
cycleEndDate.setDate(cycleEndDate.getDate() + 28); // Default to 4 weeks
let previousGenerations = [];
let currentUser = null;
let activeUsers = new Set();
let onboardingPages = [
"Welcome to the ISOD Staff Scheduling System!",
"You can manage departments and shifts here.",
"Add staff members and set their preferences.",
"Generate schedules based on complex rules.",
"Thank you for using our system!"
];
let currentOnboardingPage = 0;

// Check if user is logged in
firebase.auth().onAuthStateChanged((user) => {
if (user) {
currentUser = user;
document.getElementById('loginForm').style.display = 'none';
document.getElementById('signUpForm').style.display = 'none';
document.getElementById('onboardingScreens').style.display = 'block';
document.getElementById('mainContent').style.display = 'none';
showOnboardingPage();
initializeApp();
updateActiveUsers(user.email, true);
} else {
document.getElementById('loginForm').style.display = 'block';
document.getElementById('signUpForm').style.display = 'none';
document.getElementById('mainContent').style.display = 'none';
}
});

// Skip login function
function skipLogin() {
currentUser = {
uid: 'guest'
}; // Use a guest UID
document.getElementById('loginForm').style.display = 'none';
document.getElementById('signUpForm').style.display = 'none';
document.getElementById('onboardingScreens').style.display = 'block';
document.getElementById('mainContent').style.display = 'block';
showOnboardingPage();
initializeApp();
}

// Onboarding functions
function showOnboardingPage() {
const content = document.getElementById('onboardingContent');
content.innerHTML = `<h2>${onboardingPages[currentOnboardingPage]}</h2>`;
}

function nextOnboarding() {
currentOnboardingPage++;
if (currentOnboardingPage >= onboardingPages.length) {
closeOnboarding();
} else {
showOnboardingPage();
}
}

function prevOnboarding() {
if (currentOnboardingPage > 0) {
currentOnboardingPage--;
showOnboardingPage();
}
}

function skipOnboarding() {
closeOnboarding();
}

function closeOnboarding() {
document.getElementById('onboardingScreens').style.display = 'none';
document.getElementById('mainContent').style.display = 'block';
}

// Login function
function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    checkIfCentaur(user);
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    initializeApp();
                })
                .catch((error) => {
                    showFancyAlert('Login failed: ' + error.message);
                });
        }

// Sign up function
function signUp() {
const email = document.getElementById('signUpEmail').value;
const password = document.getElementById('signUpPassword').value;
firebase.auth().createUserWithEmailAndPassword(email, password)
.catch((error) => {
showFancyAlert('Sign up failed: ' + error.message);
});
}

// Logout function
function logout() {
updateActiveUsers(currentUser.email, false);
firebase.auth().signOut().then(() => {
location.reload();
}).catch((error) => {
console.error('Logout failed:', error);
});
}

// Show sign up form
function showSignUpForm() {
document.getElementById('loginForm').style.display = 'none';
document.getElementById('signUpForm').style.display = 'block';
}

// Show login form
function showLoginForm() {
document.getElementById('loginForm').style.display = 'block';
document.getElementById('signUpForm').style.display = 'none';
}

// Update active users
function updateActiveUsers(userEmail, isActive) {
const usersRef = firebase.database().ref('activeUsers');
if (isActive) {
usersRef.child(btoa(userEmail)).set(true);
} else {
usersRef.child(btoa(userEmail)).remove();
}
}

// Listen for active users changes
function listenForActiveUsers() {
const usersRef = firebase.database().ref('activeUsers');
usersRef.on('value', (snapshot) => {
activeUsers.clear();
snapshot.forEach((childSnapshot) => {
activeUsers.add(atob(childSnapshot.key));
});
updateActiveUsersDisplay();
});
}

// Update active users display
function updateActiveUsersDisplay() {
const container = document.getElementById('activeUsers');
container.innerHTML = '<strong>Active Users:</strong> ';
activeUsers.forEach(user => {
const userSpan = document.createElement('span');
userSpan.className = 'active-user';
userSpan.textContent = user;
container.appendChild(userSpan);
});
}

// Initialize the application
function initializeApp() {
initializeDepartments();
initializeShifts();
populateDepartmentSelect();
updateSupervisorSelect();
listenForActiveUsers();

// Set initial dates for the cycle
document.getElementById('cycleStartDate').value = formatDateForInput(cycleStartDate);
document.getElementById('cycleEndDate').value = formatDateForInput(cycleEndDate);

// Add event listener for cycle date changes
document.getElementById('cycleStartDate').addEventListener('change', function() {
cycleStartDate = new Date(this.value);
if (cycleStartDate > cycleEndDate) {
cycleEndDate = new Date(cycleStartDate);
cycleEndDate.setDate(cycleEndDate.getDate() + (parseInt(document.getElementById('cycleDuration').value) * 7));
document.getElementById('cycleEndDate').value = formatDateForInput(cycleEndDate);
}
});

document.getElementById('cycleEndDate').addEventListener('change',
function() {
cycleEndDate = new Date(this.value);
if (cycleEndDate < cycleStartDate) {
cycleStartDate = new Date(cycleEndDate);
cycleStartDate.setDate(cycleStartDate.getDate() - (parseInt(document.getElementById('cycleDuration').value) * 7));
document.getElementById('cycleStartDate').value = formatDateForInput(cycleStartDate);
}
});

// Initialize dark mode toggle
document.getElementById('darkModeToggle').checked = document.body.classList.contains('dark-mode');

// Add settings option to hamburger menu
const settingsLink = document.createElement('a');
settingsLink.href = '#';
settingsLink.innerHTML = '<i class="fas fa-cog"></i> Settings';
settingsLink.onclick = showSettingsModal;
document.querySelector('.dropdown-content').appendChild(settingsLink);

// Initialize chat system
            document.getElementById('chatSystem').style.display = 'flex';

            // Add chat toggle button to the header
            const header = document.querySelector('.header');
            const chatToggle = document.createElement('button');
            chatToggle.innerHTML = '<i class="fas fa-comments"></i>';
            chatToggle.onclick = toggleChatSystem;
            header.appendChild(chatToggle);
}

// Function to format date for input fields
function formatDateForInput(date) {
return date.toISOString().split('T')[0];
}

// Initialize departments
function initializeDepartments() {
const departmentScroll = document.getElementById('departmentScroll');
departmentScroll.innerHTML = '';
departments.forEach(dept => {
const btn = document.createElement('span');
btn.className = 'scroll-item';
btn.textContent = dept.name;
btn.onclick = () => selectDepartment(dept.name);
departmentScroll.appendChild(btn);
});
}

// Populate department select dropdown
function populateDepartmentSelect() {
const departmentSelect = document.getElementById('departmentSelect');
departmentSelect.innerHTML = '<option value="">Select Department</option>';
departments.forEach(dept => {
const option = document.createElement('option');
option.value = dept.name;
option.textContent = dept.name;
departmentSelect.appendChild(option);
});
}

// Initialize shifts
function initializeShifts() {
const shiftScroll = document.getElementById('shiftScroll');
shiftScroll.innerHTML = '';
shifts.forEach(shift => {
const btn = document.createElement('span');
btn.className = 'scroll-item';
btn.textContent = `${shift.name} (${shift.start}-${shift.end})`;
btn.title = `Min Staff: ${shift.minStaff}`;
btn.onclick = () => editShift(shift);
shiftScroll.appendChild(btn);
});
}

// Add department
function addDepartment() {
const newDept = document.getElementById('newDepartment').value.trim();
const newAbbr = document.getElementById('newDepartmentAbbr').value.trim();
if (newDept && newAbbr && !departments.some(d => d.name.toLowerCase() === newDept.toLowerCase())) {
departments.push({
name: newDept, abbr: newAbbr
});
initializeDepartments();
populateDepartmentSelect();
document.getElementById('newDepartment').value = '';
document.getElementById('newDepartmentAbbr').value = '';
closeOverlay('addDepartmentOverlay');
saveToFirebase();
} else {
showFancyAlert("Invalid department details or department already exists.");
}
showTooltip('Department added successfully');
}

// Fix Close Overlay
function closeOverlay(overlayId) {
document.getElementById(overlayId).style.display = 'none';
}

// Add shift
function addShift() {
const name = document.getElementById('newShiftName').value.trim();
const start = document.getElementById('newShiftStart').value;
const end = document.getElementById('newShiftEnd').value;
const minStaff = parseInt(document.getElementById('newShiftMinStaff').value);
if (name && start && end && minStaff && !shifts.some(s => s.name.toLowerCase() === name.toLowerCase())) {
shifts.push({
name, start, end, minStaff
});
initializeShifts();
document.getElementById('newShiftName').value = '';
document.getElementById('newShiftStart').value = '';
document.getElementById('newShiftEnd').value = '';
document.getElementById('newShiftMinStaff').value = '';
closeOverlay('addShiftOverlay');
saveToFirebase();
} else {
showFancyAlert("Invalid shift details or shift already exists.");
}
showTooltip('Shift added successfully');
}

// Select department
function selectDepartment(dept) {
document.querySelectorAll('.scroll-item').forEach(btn => {
btn.classList.toggle('active', btn.textContent === dept);
});
updateStaffList();
}

// Edit shift
function editShift(shift) {
const newName = prompt('Enter new shift name:', shift.name);
const newStart = prompt('Enter new start time (HH:MM):', shift.start);
const newEnd = prompt('Enter new end time (HH:MM):', shift.end);
const newMinStaff = prompt('Enter new minimum staff:', shift.minStaff);
if (newName && newStart && newEnd && newMinStaff && !isNaN(newMinStaff)) {
shift.name = newName.trim();
shift.start = newStart;
shift.end = newEnd;
shift.minStaff = parseInt(newMinStaff);
initializeShifts();
updateScheduleTable();
saveToFirebase();
} else {
showFancyAlert("Invalid shift details.");
}
}

// Quick add staff
function quickAddStaff() {
const staffNames = document.getElementById('quickAddStaff').value.split(',').map(name => name.trim()).filter(name => name);
const department = document.getElementById('departmentSelect').value;
if (department && staffNames.length > 0) {
if (!staff[department]) staff[department] = [];
staffNames.forEach(name => {
if (name && !staff[department].some(s => s.name.toLowerCase() === name.toLowerCase())) {
staff[department].push({
name,
preferences: shifts.map(shift => ({
name: shift.name, days: 0
})),
gender: '',
role: 'n',
leaveDays: [],
weekendsOff: 0,
nightShifts: 0,
pregnantUntil: null,
languages: [],
maxConsecutiveNightShifts: 3
});
}
});
document.getElementById('quickAddStaff').value = '';
updateStaffList();
updateSupervisorSelect();
saveToFirebase();
} else {
showFancyAlert("Please select a department and enter valid staff names.");
}
showTooltip('Staff added successfully');
}

// Add individual staff via overlay
function addIndividualStaff() {
const name = document.getElementById('staffName').value.trim();
const gender = document.getElementById('staffGender').value;
const role = document.getElementById('staffRole').value;
const department = document.getElementById('departmentSelect').value;
const languages = document.getElementById('staffLanguage').value.trim().split(',').map(l => l.trim()).filter(l => l);
const pregnantUntil = document.getElementById('staffPregnantUntil').value ? new Date(document.getElementById('staffPregnantUntil').value): null;
const leaveStart = document.getElementById('staffLeaveStart').value ? new Date(document.getElementById('staffLeaveStart').value): null;
const leaveEnd = document.getElementById('staffLeaveEnd').value ? new Date(document.getElementById('staffLeaveEnd').value): null;

if (name && gender && role && department) {
if (!staff[department]) staff[department] = [];
if (!staff[department].some(s => s.name.toLowerCase() === name.toLowerCase())) {
staff[department].push({
name,
gender,
role,
preferences: shifts.map(shift => ({
name: shift.name, days: 0
})),
leaveDays: [],
weekendsOff: 0,
nightShifts: 0,
pregnantUntil,
languages,
maxConsecutiveNightShifts: 3
});
if (leaveStart && leaveEnd) {
const leaveDates = getDatesBetween(leaveStart, leaveEnd);
staff[department][staff[department].length - 1].leaveDays = leaveDates;
}
if (role === 's') {
supervisors.add(name);
weekdaySupervisors.add(name);
}
if (pregnantUntil) {
pregnantStaff[name] = pregnantUntil;
}
if (languages.length > 0) {
staffLanguages[name] = languages;
}
updateStaffList();
updateSupervisorSelect();
closeOverlay('addStaffOverlay');
saveToFirebase();
} else {
showFancyAlert("Staff member already exists in the selected department.");
}
} else {
showFancyAlert("Please fill in all staff details.");
}
showTooltip('Staff member added successfully');
}

// Add Individual Staff overlay
function showAddStaffOverlay() {
const overlay = document.getElementById('addStaffOverlay');
overlay.style.display = 'block';
}

// Prevent scrolling when settings modal is open
function showSettingsModal() {
document.getElementById('settingsModal').style.display = 'block';
document.body.style.overflow = 'hidden';
}
function closeSettingsModal() {
document.getElementById('settingsModal').style.display = 'none';
document.body.style.overflow = 'auto';
}

// Tooltip
function showTooltip(message) {
const tooltip = document.getElementById('tooltip');
tooltip.textContent = message;
tooltip.style.display = 'block';
setTimeout(() => {
tooltip.style.display = 'none';
}, 3000);
}

// Export Data
function exportData() {
const data = {
departments,
shifts,
staff,
schedule,
supervisors: Array.from(supervisors),
weekdaySupervisors: Array.from(weekdaySupervisors),
weekendSupervisors: Array.from(weekendSupervisors),
staffNotOnNightShift: Array.from(staffNotOnNightShift),
staffOnLeave,
staffLanguages,
genderDistribution,
staffPairRestrictions,
pregnantStaff,
cycleStartDate: cycleStartDate.toISOString(),
cycleEndDate: cycleEndDate.toISOString(),
previousGenerations
};
const dataStr = JSON.stringify(data);
const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
const exportFileDefaultName = 'isod_scheduler_data.json';

const linkElement = document.createElement('a');
linkElement.setAttribute('href', dataUri);
linkElement.setAttribute('download', exportFileDefaultName);
linkElement.click();
showTooltip('Data exported successfully');
}

// Import Data
function importData() {
const input = document.createElement('input');
input.type = 'file';
input.accept = '.json';
input.onchange = function(event) {
const file = event.target.files[0];
const reader = new FileReader();
reader.onload = function(e) {
const contents = e.target.result;
const data = JSON.parse(contents);
// Update your application state with the imported data
departments = data.departments;
shifts = data.shifts;
staff = data.staff;
schedule = data.schedule;
supervisors = new Set(data.supervisors);
weekdaySupervisors = new Set(data.weekdaySupervisors);
weekendSupervisors = new Set(data.weekendSupervisors);
staffNotOnNightShift = new Set(data.staffNotOnNightShift);
staffOnLeave = data.staffOnLeave;
staffLanguages = data.staffLanguages;
genderDistribution = data.genderDistribution;
staffPairRestrictions = data.staffPairRestrictions;
pregnantStaff = data.pregnantStaff;
cycleStartDate = new Date(data.cycleStartDate);
cycleEndDate = new Date(data.cycleEndDate);
previousGenerations = data.previousGenerations;

// Update UI
initializeDepartments();
initializeShifts();
populateDepartmentSelect();
updateStaffList();
updateSupervisorSelect();
updateScheduleTable();
updatePreviousGenerations();

showTooltip('Data imported successfully');
};
reader.readAsText(file);
};
input.click();
}




// Implement PiP-like feature for schedule table
function showScheduleModal() {
const modal = document.getElementById('scheduleModal');
const modalContent = document.getElementById('modalScheduleContainer');
modalContent.innerHTML = document.getElementById('scheduleTable').outerHTML;
modal.style.display = 'block';

// Close modal when clicking on <span> (x)
modal.querySelector('.close').onclick = function() {
modal.style.display = 'none';
}

// Close modal when clicking outside of it
window.onclick = function(event) {
if (event.target == modal) {
modal.style.display = 'none';
}
}
}

// Search and replace feature
function searchAndReplace() {
const searchTerm = document.getElementById('searchInput').value;
const replaceTerm = document.getElementById('replaceInput').value;
const table = document.getElementById('modalScheduleContainer').querySelector('table');
const cells = table.getElementsByTagName('td');

for (let i = 0; i < cells.length; i++) {
if (cells[i].textContent.includes(searchTerm)) {
cells[i].textContent = cells[i].textContent.replace(searchTerm, replaceTerm);
}
}

// Update the main schedule table
document.getElementById('scheduleTable').outerHTML = table.outerHTML;
updateScheduleFromTable();
}



// Update schedule array from table
function updateScheduleFromTable() {
const table = document.getElementById('scheduleTable');
const rows = table.getElementsByTagName('tr');
schedule = [];

for (let i = 1; i < rows.length; i++) {
// Start from 1 to skip header
const cells = rows[i].getElementsByTagName('td');
if (cells.length >= 4) {
const date = new Date(cells[0].textContent.split('-').reverse().join('-'));
const department = cells[2].textContent;

for (let j = 3; j < cells.length; j++) {
const shift = shifts[j - 3].name;
const staff = cells[j].textContent.split(',').map(s => s.trim()).filter(s => s);
if (staff.length > 0) {
schedule.push({
date,
department,
staff,
shift
});
}
}
}
}
saveToFirebase();
}

function zoomTable(zoomLevel) {
const table = document.querySelector('#modalScheduleContainer table');
table.style.transform = `scale(${zoomLevel / 100})`;
table.style.transformOrigin = 'top left';
document.getElementById('zoomValue').textContent = zoomLevel + '%';
}

// Get dates between two dates
function getDatesBetween(startDate, endDate) {
const dates = [];
let currentDate = new Date(startDate);
while (currentDate <= endDate) {
dates.push(formatDate(currentDate));
currentDate.setDate(currentDate.getDate() + 1);
}
return dates;
}

// Use default staff data
function useDefaultStaff() {
const defaultStaffData = `Abiodun,F,n;Adams,M,s;Adeleke,M,n;Adelodun,M,n;Adenike,F,s;Alimat,F,n;Basirat,F,n;Bolaji,M,s;Celestina,F,n;Dara,F,s;David,M,s;Esther,F,n;Etim,M,n;Gabriel,M,s;Gideon,M,n;Godwin,M,s;James,M,n;Jerry,M,n;Joshua,M,n;Kamilah,F,s;Kemi,F,n;Marho,F,n;Marvellous,F,n;Michael,M,n;Miracle,F,n;Olayemi,F,s;Opeyemi,M,s;Osato,F,n;Samuel,M,n;Solomon,M,s;Sophia,F,s;Stephen A.,M,s;Stephen E.,M,s;Tobi,F,s;Tosin,M,n;Wisdom,M,s;Yetunde,F,s;Zainab,F,n`;
staff = {};
const defaultDept = 'Transaction Monitoring';
staff[defaultDept] = [];
defaultStaffData.split(';').forEach(staffInfo => {
const [name, gender, role] = staffInfo.split(',');
const s = {
name,
gender,
role,
preferences: shifts.map(shift => ({
name: shift.name, days: 0
})),
leaveDays: [],
weekendsOff: 0,
nightShifts: 0,
pregnantUntil: null,
languages: [],
maxConsecutiveNightShifts: 3
};
staff[defaultDept].push(s);
if (role === 's') {
supervisors.add(name);
weekdaySupervisors.add(name);
}
});
updateStaffList();
updateSupervisorSelect();
saveToFirebase();
}

// Update staff list
function updateStaffList() {
const staffList = document.getElementById('staffList');
staffList.innerHTML = '';
Object.entries(staff).forEach(([dept, staffMembers]) => {
staffMembers.forEach((s, index) => {
const card = document.createElement('div');
card.className = 'staff-card';
card.innerHTML = `
<h3 class="${supervisors.has(s.name) ? 'supervisor': ''}">${s.name}</h3>
<p>Department: ${dept}</p>
<p>Gender: ${s.gender}</p>
<p>Role: ${s.role === 's' ? 'Supervisor': 'Normal'}</p>
<p>Preferences: ${s.preferences.map(p => `${p.name}: ${p.days} days`).join(', ')}</p>
<button onclick="editStaffPreferences('${dept}', ${index})">Edit Preferences</button>
<button onclick="deleteStaff('${dept}', ${index})">Delete</button>
<button onclick="resetStaff('${dept}', ${index})">Reset</button>
`;
staffList.appendChild(card);
});
});
}

// Edit staff preferences
function editStaffPreferences(dept, index) {
currentEditingStaff = {
dept, index
};
const s = staff[dept][index];
const overlay = document.getElementById('preferencesOverlay');
const content = document.getElementById('preferencesContent');
content.innerHTML = '';
s.preferences.forEach(pref => {
const prefContainer = document.createElement('div');
prefContainer.className = 'preference-container';
prefContainer.innerHTML = `
<label>${pref.name}: <span id="${pref.name}-value">${pref.days} days</span></label>
<input type="number" min="0" max="31" value="${pref.days}" class="preference-input" id="${pref.name}-input">
`;
content.appendChild(prefContainer);
const input = prefContainer.querySelector('.preference-input');
const valueSpan = prefContainer.querySelector(`#${pref.name}-value`);
input.oninput = function() {
valueSpan.textContent = this.value + ' days';
}
});
overlay.style.display = 'block';
}

// Save preferences
function savePreferences() {
const {
dept, index
} = currentEditingStaff;
const s = staff[dept][index];
s.preferences.forEach(pref => {
const input = document.getElementById(`${pref.name}-input`);
pref.days = parseInt(input.value);
});
updateStaffList();
closeOverlay('preferencesOverlay');
saveToFirebase();
}

// Delete staff
function deleteStaff(dept, index) {
if (confirm('Are you sure you want to delete this staff member?')) {
const deletedStaff = staff[dept].splice(index, 1)[0];
supervisors.delete(deletedStaff.name);
weekdaySupervisors.delete(deletedStaff.name);
weekendSupervisors.delete(deletedStaff.name);
staffNotOnNightShift.delete(deletedStaff.name);
updateStaffList();
updateSupervisorSelect();
saveToFirebase();
}
}

// Reset staff
function resetStaff(dept, index) {
if (confirm('Are you sure you want to reset this staff member\'s stats?')) {
const s = staff[dept][index];
s.workDays = 0;
s.nightShifts = 0;
s.weekendsWorked = 0;
updateStaffList();
saveToFirebase();
}
}

// Update supervisor select
function updateSupervisorSelect() {
const supervisorSelect = document.getElementById('supervisorSelect');
supervisorSelect.innerHTML = '';
Object.values(staff).flat().forEach(s => {
const option = document.createElement('div');
option.className = `supervisor-option ${supervisors.has(s.name) ? 'selected': ''}`;
option.textContent = s.name;
option.onclick = () => toggleSupervisor(s.name);
supervisorSelect.appendChild(option);
});
}

// Toggle supervisor
function toggleSupervisor(name) {
if (supervisors.has(name)) {
supervisors.delete(name);
weekdaySupervisors.delete(name);
weekendSupervisors.delete(name);
} else {
supervisors.add(name);
const isWeekendSupervisor = confirm('Should this supervisor be assigned to weekends primarily?');
if (isWeekendSupervisor) {
weekendSupervisors.add(name);
} else {
weekdaySupervisors.add(name);
}
}
updateSupervisorSelect();
updateStaffList();
saveToFirebase();
}

// Set supervisors
function setSupervisors() {
updateStaffList();
saveToFirebase();
}

// Set cycle duration
function setCycleDuration() {
const duration = parseInt(document.getElementById('cycleDuration').value);
cycleStartDate = new Date();
cycleEndDate = new Date(cycleStartDate);
cycleEndDate.setDate(cycleEndDate.getDate() + (duration * 7));
document.getElementById('cycleStartDate').value = formatDateForInput(cycleStartDate);
document.getElementById('cycleEndDate').value = formatDateForInput(cycleEndDate);
saveToFirebase();
}

// Generate schedule
function generateSchedule() {
if (Object.keys(staff).length === 0 || Object.values(staff).flat().length === 0) {
showFancyAlert("Please add staff members before generating the schedule.");
return;
}

schedule = [];
resetStaffStats();

const totalDays = Math.round((cycleEndDate - cycleStartDate) / (1000 * 60 * 60 * 24)) + 1;

for (let d = 0; d < totalDays; d++) {
const currentDate = new Date(cycleStartDate);
currentDate.setDate(cycleStartDate.getDate() + d);
const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;

departments.forEach(dept => {
if (staff[dept.name]) {
shifts.forEach(shift => {
const availableStaff = staff[dept.name].filter(s => canAssignStaff(s, currentDate, shift, isWeekend));
const selectedStaff = selectStaffForShift(availableStaff, shift, isWeekend, shift.minStaff);
schedule.push({
date: new Date(currentDate),
department: dept.name,
staff: selectedStaff.map(s => s.name),
shift: shift.name
});
selectedStaff.forEach(s => updateStaffStats(s, shift, isWeekend));
});
}
});
}

balanceSchedule();
updateScheduleTable();
savePreviousGeneration();
saveToFirebase();
showTooltip('Schedule generated successfully');
}

// Reset staff stats
function resetStaffStats() {
Object.values(staff).flat().forEach(s => {
s.workDays = 0;
s.nightShifts = 0;
s.weekendsWorked = 0;
s.consecutiveNightShifts = 0;
});
}

// Can assign staff
function canAssignStaff(staffMember, date, shift, isWeekend) {
const dateStr = formatDate(date);

// Check if staff is on leave
if (staffMember.leaveDays && staffMember.leaveDays.includes(dateStr)) return false;

// Check if staff is pregnant and cannot work night shifts
if (staffMember.pregnantUntil && date <= staffMember.pregnantUntil && shift.name === 'Night') return false;

// Some staff should not work night shifts
if (staffNotOnNightShift.has(staffMember.name) && shift.name === 'Night') return false;

// Check if staff has reached max consecutive night shifts
if (shift.name === 'Night' && staffMember.consecutiveNightShifts >= staffMember.maxConsecutiveNightShifts) return false;

// Check if staff has already worked today
const workedToday = schedule.some(entry =>
formatDate(entry.date) === dateStr &&
entry.staff.includes(staffMember.name)
);
if (workedToday) return false;

// Check if staff has days off
if (staffMember.daysOff && staffMember.daysOff.includes(dateStr)) return false;

// Check if staff has already worked maximum days in the week
const weekNumber = getWeekNumber(date);
const daysWorkedThisWeek = getDaysWorkedInWeek(staffMember, weekNumber);
if (daysWorkedThisWeek >= 5) return false;

// Avoid two people working together if in restrictions
for (let pair of staffPairRestrictions) {
if ((pair[0] === staffMember.name || pair[1] === staffMember.name)) {
const otherName = pair[0] === staffMember.name ? pair[1]: pair[0];
const otherAssigned = schedule.some(entry =>
formatDate(entry.date) === dateStr &&
entry.shift === shift.name &&
entry.staff.includes(otherName)
);
if (otherAssigned) return false;
}
}

return true;
}

// Get days worked in a week
function getDaysWorkedInWeek(staffMember, weekNumber) {
return schedule.filter(entry =>
getWeekNumber(entry.date) === weekNumber &&
entry.staff.includes(staffMember.name)
).length;
}

// Select staff for shift
function selectStaffForShift(availableStaff, shift, isWeekend, minStaff) {
let selectedStaff = [];

// Ensure there is a supervisor
const supervisorsAvailable = availableStaff.filter(s => supervisors.has(s.name));
if (supervisorsAvailable.length > 0) {
const supervisor = supervisorsAvailable[Math.floor(Math.random() * supervisorsAvailable.length)];
selectedStaff.push(supervisor);
availableStaff = availableStaff.filter(s => s.name !== supervisor.name);
}

// Fill the remaining slots
const remaining = minStaff - selectedStaff.length;
if (remaining > 0) {
const shuffled = availableStaff.sort(() => 0.5 - Math.random());
selectedStaff = selectedStaff.concat(shuffled.slice(0, remaining));
}

return selectedStaff;
}

// Update staff stats
function updateStaffStats(staffMember, shift, isWeekend) {
staffMember.workDays++;
if (shift.name === 'Night') {
staffMember.nightShifts++;
staffMember.consecutiveNightShifts++;
} else {
staffMember.consecutiveNightShifts = 0;
}
if (isWeekend) staffMember.weekendsWorked++;
}

// Balance Schedule
function balanceSchedule() {
const staffWorkload = {};

// Count the workload for each staff member
schedule.forEach(entry => {
entry.staff.forEach(staffName => {
if (!staffWorkload[staffName]) {
staffWorkload[staffName] = {
total: 0,
shifts: {}
};
}
staffWorkload[staffName].total++;
if (!staffWorkload[staffName].shifts[entry.shift]) {
staffWorkload[staffName].shifts[entry.shift] = 0;
}
staffWorkload[staffName].shifts[entry.shift]++;
});
});

// Find staff with too many or too few shifts
const averageWorkload = Object.values(staffWorkload).reduce((sum,
staff) => sum + staff.total, 0) / Object.keys(staffWorkload).length;
const overworkedStaff = Object.entries(staffWorkload).filter(([name,
workload]) => workload.total > averageWorkload * 1.2);
const underworkedStaff = Object.entries(staffWorkload).filter(([name,
workload]) => workload.total < averageWorkload * 0.8);

// Attempt to balance the schedule
overworkedStaff.forEach(([overworkedName,
overworkload]) => {
underworkedStaff.forEach(([underworkedName, underworkload]) => {
schedule.forEach(entry => {
if (entry.staff.includes(overworkedName) && !entry.staff.includes(underworkedName)) {
const index = entry.staff.indexOf(overworkedName);
entry.staff[index] = underworkedName;
staffWorkload[overworkedName].total--;
staffWorkload[underworkedName].total++;
if (staffWorkload[overworkedName].total <= averageWorkload * 1.1) {
return;
}
}
});
});
});

updateScheduleTable();
}

// Update schedule table
function updateScheduleTable() {
const table = document.getElementById('scheduleTable');
table.innerHTML = '';

// Add month title
const monthRow = table.insertRow();
const monthCell = monthRow.insertCell();
monthCell.colSpan = shifts.length + 3; // Date, Day, Department, Shifts
monthCell.style.textAlign = 'center';
monthCell.style.fontSize = '18px';
monthCell.textContent = `${cycleStartDate.toLocaleString('default', {
month: 'long'
})} - ${cycleEndDate.toLocaleString('default', {
month: 'long'
})} ${cycleEndDate.getFullYear()} Schedule`;

// Add table header
const headerRow = table.insertRow();
headerRow.innerHTML = `
<th>Date</th>
<th>Day</th>
<th>Department</th>
${shifts.map(s => `<th>${s.name}</th>`).join('')}
`;

// Add expand icon
const expandIcon = document.createElement('i');
expandIcon.className = 'fas fa-expand expand-icon';
expandIcon.onclick = showScheduleModal;
table.parentElement.insertBefore(expandIcon, table);

let currentWeek = null;
const groupedSchedule = groupScheduleByDateAndDepartment();

Object.entries(groupedSchedule).forEach(([dateKey, departments]) => {
const date = new Date(dateKey);

// Add week separator if needed
if (!currentWeek || getWeekNumber(date) !== getWeekNumber(currentWeek)) {
currentWeek = date;
let weekRow = table.insertRow();
let weekCell = weekRow.insertCell();
weekCell.colSpan = shifts.length + 3;
weekCell.className = 'week-separator';
weekCell.textContent = `Week ${getWeekNumber(date)}: ${getWeekRange(date)}`;
}

Object.entries(departments).forEach(([dept, shiftsData]) => {
let row = table.insertRow();
row.innerHTML = `
<td>${formatDate(date)}</td>
<td>${getDayName(date)}</td>
<td>${dept}</td>
${shifts.map(s => `
<td class="shift-cell" data-shift="${s.name}"
contenteditable="true"
oninput="updateScheduleStaff('${formatDate(date)}', '${dept}', '${s.name}', this)">
${formatStaffList(shiftsData[s.name] || [])}
</td>
`).join('')}
`;
});
});

addTotalsRow(table);
}

// Add totals row
function addTotalsRow(table) {
const totalsRow = table.insertRow();
totalsRow.className = 'totals-row';
const cells = shifts.length + 3;
for (let i = 0; i < cells; i++) {
const cell = totalsRow.insertCell();
if (i === 0) {
cell.textContent = 'Totals';
} else if (i > 2) {
const shiftName = shifts[i - 3].name;
const total = calculateShiftTotal(shiftName);
cell.textContent = total;
}
}
}

// Calculate shift total
function calculateShiftTotal(shiftName) {
return schedule.reduce((total, entry) => {
if (entry.shift === shiftName) {
return total + entry.staff.length;
}
return total;
},
0);
}

// Sort table
function sortTable(n) {
const table = document.getElementById('scheduleTable');
let switching = true;
let dir = 'asc';
let switchcount = 0;
while (switching) {
switching = false;
const rows = table.rows;
for (let i = 1; i < (rows.length - 1); i++) {
let shouldSwitch = false;
const x = rows[i].getElementsByTagName('TD')[n];
const y = rows[i + 1].getElementsByTagName('TD')[n];
if (dir === 'asc') {
if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
shouldSwitch = true;
break;
}
} else if (dir === 'desc') {
if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
shouldSwitch = true;
break;
}
}
}
if (shouldSwitch) {
rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
switching = true;
switchcount++;
} else {
if (switchcount === 0 && dir === 'asc') {
dir = 'desc';
switching = true;
}
}
}
}

// Select row
function selectRow(row) {
row.classList.toggle('selected');
}

// Highlight search results
function highlightSearchResults(searchTerm) {
const table = document.getElementById('scheduleTable');
const rows = table.getElementsByTagName('tr');
for (let i = 0; i < rows.length; i++) {
const cells = rows[i].getElementsByTagName('td');
for (let j = 0; j < cells.length; j++) {
const cellText = cells[j].innerText;
if (cellText.toLowerCase().includes(searchTerm.toLowerCase())) {
cells[j].innerHTML = cellText.replace(new RegExp(searchTerm, 'gi'), match => `<mark>${match}</mark>`);
}
}
}
}

// Group schedule by date and department
function groupScheduleByDateAndDepartment() {
return schedule.reduce((acc, entry) => {
const dateKey = formatDate(entry.date);
if (!acc[dateKey]) acc[dateKey] = {};
if (!acc[dateKey][entry.department]) acc[dateKey][entry.department] = {};
if (!acc[dateKey][entry.department][entry.shift]) acc[dateKey][entry.department][entry.shift] = [];
acc[dateKey][entry.department][entry.shift] = acc[dateKey][entry.department][entry.shift].concat(entry.staff);
return acc;
},
{});
}

// Format staff list
function formatStaffList(staffList) {
return staffList.map(name => {
const isSupervisor = supervisors.has(name);
return `<span class="staff-name ${isSupervisor ? 'supervisor': ''}" title="${name}">${name}</span>`;
}).join(', ');
}

// Get week range
function getWeekRange(date) {
let start = new Date(date);
start.setDate(start.getDate() - start.getDay() + 1); // Start from Monday
let end = new Date(start);
end.setDate(end.getDate() + 6);
return `${formatDate(start)} to ${formatDate(end)}`;
}

// Get week number
function getWeekNumber(date) {
const firstDayOfYear = new Date(date.getFullYear(),
0,
1);
const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
}

// Get day name
function getDayName(date) {
const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
return days[date.getDay()];
}

// Format date
function formatDate(date) {
if (!(date instanceof Date) || isNaN(date)) {
return 'Invalid Date';
}
return `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;
}

// Update schedule staff
function updateScheduleStaff(date, department, shift, element) {
const staffNames = element.textContent.split(',').map(name => name.trim()).filter(name => name);
schedule = schedule.filter(e => !(
formatDate(e.date) === date &&
e.department === department &&
e.shift === shift
));
if (staffNames.length > 0) {
schedule.push({
date: new Date(date.split('-').reverse().join('-')),
department,
staff: staffNames,
shift
});
}
saveToFirebase();

// Update progress bar
const shiftConfig = shifts.find(s => s.name === shift);
const minStaff = shiftConfig ? shiftConfig.minStaff: 1;
const staffRatio = staffNames.length / minStaff;
const progressBar = element.querySelector('.progress-bar');
if (!progressBar) {
const newProgressBar = document.createElement('div');
newProgressBar.className = 'progress-bar';
newProgressBar.innerHTML = `<div class="progress" style="width: ${staffRatio * 100}%;"></div>`;
element.appendChild(newProgressBar);
} else {
progressBar.querySelector('.progress').style.width = `${staffRatio * 100}%`;
}

// Change color based on staff ratio
const progressElement = progressBar ? progressBar.querySelector('.progress'): newProgressBar.querySelector('.progress');
if (staffRatio < 1) {
progressElement.style.backgroundColor = 'red';
} else if (staffRatio > 1) {
progressElement.style.backgroundColor = 'yellow';
} else {
progressElement.style.backgroundColor = 'green';
}
}

// Modified search function
function searchSchedule() {
const searchTerm = document.getElementById('searchInput').value.toLowerCase();
const tables = [
document.getElementById('scheduleTable'),
document.getElementById('modalScheduleContainer').querySelector('table')
];

tables.forEach(table => {
const rows = table.getElementsByTagName('tr');
for (let i = 1; i < rows.length; i++) {
const row = rows[i];
const cells = row.getElementsByTagName('td');
let found = false;

for (let j = 0; j < cells.length; j++) {
const cellText = cells[j].textContent.toLowerCase();
if (cellText.includes(searchTerm)) {
found = true;
break;
}
}

if (found) {
row.style.display = '';
highlightSearchTerm(row, searchTerm);
} else {
row.style.display = 'none';
}
}
});
}

function highlightSearchTerm(row, term) {
const cells = row.getElementsByTagName('td');
for (let i = 0; i < cells.length; i++) {
const cellText = cells[i].textContent;
cells[i].innerHTML = cellText.replace(new RegExp(term, 'gi'), match => `<mark>${match}</mark>`);
}
}
// Improved search functionality
let currentSearchIndex = -1;
let searchResults = [];

function findNext() {
const searchTerm = document.getElementById('searchInput').value.toLowerCase();
if (searchTerm === '') return;

const tables = [
document.getElementById('scheduleTable'),
document.getElementById('modalScheduleContainer').querySelector('table')
];

// Clear previous highlights
tables.forEach(table => {
const cells = table.getElementsByTagName('td');
for (let cell of cells) {
cell.classList.remove('highlight-cell');
}
});

if (searchResults.length === 0 || currentSearchIndex === -1) {
// Perform new search
searchResults = tables.flatMap(table =>
Array.from(table.getElementsByTagName('td')).filter(cell =>
cell.textContent.toLowerCase().includes(searchTerm)
)
);
currentSearchIndex = 0;
} else {
currentSearchIndex = (currentSearchIndex + 1) % searchResults.length;
}

if (searchResults.length > 0) {
const cell = searchResults[currentSearchIndex];
cell.classList.add('highlight-cell');
cell.scrollIntoView({
behavior: 'smooth', block: 'center'
});
updateSearchResults();
} else {
updateSearchResults('No results found');
}
}

// Modified findAll function

function findAll() {
const searchTerm = document.getElementById('searchInput').value.toLowerCase();
if (searchTerm === '') return;

const tables = [
document.getElementById('scheduleTable'),
document.getElementById('modalScheduleContainer').querySelector('table')
];

const resultsContainer = document.getElementById('findAllResults');
resultsContainer.innerHTML = '';

const uniqueResults = new Set();

tables.forEach(table => {
const cells = table.getElementsByTagName('td');
for (let cell of cells) {
if (cell.textContent.toLowerCase().includes(searchTerm)) {
const row = cell.closest('tr');
const date = row.cells[0].textContent;
const dept = row.cells[2].textContent;
const shift = row.cells[cell.cellIndex].textContent;
const resultKey = `${date}-${dept}-${shift}`;

if (!uniqueResults.has(resultKey)) {
uniqueResults.add(resultKey);
cell.classList.add('highlight-cell');

const resultItem = document.createElement('div');
resultItem.textContent = `${date} - ${dept} - ${shift}`;
resultItem.onclick = () => {
cell.scrollIntoView({
behavior: 'smooth', block: 'center'
});
};
resultsContainer.appendChild(resultItem);
}
}
}
});

if (uniqueResults.size > 0) {
resultsContainer.style.display = 'block';
updateSearchResults(`${uniqueResults.size} unique results found`);
} else {
resultsContainer.style.display = 'none';
updateSearchResults('No results found');
}
}

// New function to toggle chat bar
function toggleChatBar() {
const chatBar = document.getElementById('chatBar');
chatBar.classList.toggle('open');
}


// New function to send a message
function sendMessage() {
const input = document.getElementById('chatInput');
const message = input.value.trim();
if (message) {
const chatMessages = document.getElementById('chatMessages');
const messageElement = document.createElement('div');
messageElement.textContent = message;
chatMessages.appendChild(messageElement);
input.value = '';
chatMessages.scrollTop = chatMessages.scrollHeight;
}
}



function updateSearchResults(message) {
const resultsSpans = document.querySelectorAll('#searchResults');
resultsSpans.forEach(span => {
span.textContent = message || `Result ${currentSearchIndex + 1} of ${searchResults.length}`;
});
}
// New functions for About and Share
// Update the showAboutInfo and closeAboutOverlay functions
function showAboutInfo() {
document.getElementById('aboutOverlay').classList.add('active');
}

function closeAboutOverlay() {
document.getElementById('aboutOverlay').classList.remove('active');
document.getElementById('settingsModal').style.display = 'none';
}

function shareSchedule() {
// Implement sharing functionality here
showFancyAlert('Sharing functionality to be implemented');
}

// Update the showAddDepartmentOverlay and showAddShiftOverlay functions
function showAddDepartmentOverlay() {
document.getElementById('addDepartmentOverlay').style.display = 'block';
}

function showAddShiftOverlay() {
document.getElementById('addShiftOverlay').style.display = 'block';
}

// Save previous generation
function savePreviousGeneration() {
const generationSnapshot = JSON.parse(JSON.stringify(schedule));
previousGenerations.unshift(generationSnapshot);
if (previousGenerations.length > 5) {
previousGenerations.pop();
}
updatePreviousGenerations();
}

// Update previous generations
function updatePreviousGenerations() {
const container = document.getElementById('previousGenerations');
container.innerHTML = '';
previousGenerations.forEach((gen, index) => {
const item = document.createElement('div');
item.className = 'generation-item';
item.innerHTML = `Generation ${index + 1}`;
const trashIcon = document.createElement('i');
trashIcon.className = 'fas fa-trash trash-icon';
trashIcon.onclick = (e) => {
e.stopPropagation();
deletePreviousGeneration(index);
};
item.appendChild(trashIcon);
item.onclick = () => loadPreviousGeneration(index);
container.appendChild(item);
});
}

// Delete previous generation
function deletePreviousGeneration(index) {
previousGenerations.splice(index, 1);
updatePreviousGenerations();
saveToFirebase();
}

// Load previous generation
function loadPreviousGeneration(index) {
schedule = JSON.parse(JSON.stringify(previousGenerations[index]));
updateScheduleTable();
saveToFirebase();
}

// Reset all staff
function resetAllStaff() {
if (confirm('Are you sure you want to reset all staff schedules?')) {
Object.values(staff).flat().forEach(staffMember => {
staffMember.workDays = 0;
staffMember.nightShifts = 0;
staffMember.weekendsWorked = 0;
});

schedule = [];
updateScheduleTable();
saveToFirebase();
}
}

// Save to Firebase
function saveToFirebase() {
if (!currentUser) {
console.error('No user logged in');
return;
}
const data = {
departments,
shifts,
staff,
schedule,
supervisors: Array.from(supervisors),
weekdaySupervisors: Array.from(weekdaySupervisors),
weekendSupervisors: Array.from(weekendSupervisors),
staffNotOnNightShift: Array.from(staffNotOnNightShift),
staffOnLeave,
staffLanguages,
genderDistribution,
staffPairRestrictions,
pregnantStaff,
cycleStartDate: cycleStartDate.toISOString(),
cycleEndDate: cycleEndDate.toISOString(),
previousGenerations
};
firebase.database().ref('schedules/' + currentUser.uid).set(data)
.then(() => console.log('Data saved successfully'))
.catch((error) => console.error('Error saving data:', error));
showTooltip('Data saved to Firebase');
}

// Load from Firebase
function loadFromFirebase() {
if (!currentUser) {
console.error('No user logged in');
return;
}
firebase.database().ref('schedules/' + currentUser.uid).once('value')
.then((snapshot) => {
const data = snapshot.val();
if (data) {
departments = data.departments;
shifts = data.shifts;
staff = data.staff;
schedule = data.schedule;
supervisors = new Set(data.supervisors);
weekdaySupervisors = new Set(data.weekdaySupervisors);
weekendSupervisors = new Set(data.weekendSupervisors);
staffNotOnNightShift = new Set(data.staffNotOnNightShift);
staffOnLeave = data.staffOnLeave || {};
staffLanguages = data.staffLanguages || {};
genderDistribution = data.genderDistribution || {};
staffPairRestrictions = data.staffPairRestrictions || [];
pregnantStaff = data.pregnantStaff || {};
cycleStartDate = new Date(data.cycleStartDate);
cycleEndDate = new Date(data.cycleEndDate);
previousGenerations = data.previousGenerations || [];

initializeDepartments();
initializeShifts();
populateDepartmentSelect();
updateStaffList();
updateSupervisorSelect();
updateScheduleTable();
updatePreviousGenerations();

document.getElementById('cycleStartDate').value = formatDateForInput(cycleStartDate);
document.getElementById('cycleEndDate').value = formatDateForInput(cycleEndDate);

console.log('Data loaded successfully');
} else {
console.log('No data found');
}
})
.catch((error) => console.error('Error loading data:', error));
showTooltip('Data loaded from Firebase');
}

// Export Excel
function exportExcel() {
const wb = XLSX.utils.book_new();
const ws_data = [
['Date', 'Day', 'Department', ...shifts.map(s => `${s.name} (${s.minStaff})`)]
];

const groupedSchedule = schedule.reduce((acc, entry) => {
const key = `${formatDate(entry.date)}-${entry.department}`;
if (!acc[key]) acc[key] = {
date: entry.date,
department: entry.department,
shifts: {}
};
if (!acc[key].shifts[entry.shift]) acc[key].shifts[entry.shift] = [];
acc[key].shifts[entry.shift] = acc[key].shifts[entry.shift].concat(entry.staff);
return acc;
},
{});

Object.values(groupedSchedule).forEach(entry => {
const dayName = getDayName(entry.date);
const row = [
formatDate(entry.date),
dayName,
entry.department,
...shifts.map(s => entry.shifts[s.name] ? entry.shifts[s.name].join(', '): '')
];
ws_data.push(row);
});

const ws = XLSX.utils.aoa_to_sheet(ws_data);
XLSX.utils.book_append_sheet(wb,
ws,
"Schedule");
XLSX.writeFile(wb,
"ISOD_Schedule.xlsx");
}

// Import Excel
function importExcel() {
const file = document.getElementById('excelFile').files[0];
if (!file) {
showFancyAlert("Please select an Excel file to import.");
return;
}
const reader = new FileReader();
reader.onload = function(e) {
const data = new Uint8Array(e.target.result);
const workbook = XLSX.read(data, {
type: 'array'
});
const sheetName = workbook.SheetNames[0];
const worksheet = workbook.Sheets[sheetName];
const jsonData = XLSX.utils.sheet_to_json(worksheet, {
header: 1
});

schedule = [];
supervisors.clear();
weekdaySupervisors.clear();

// Reset staff based on departments
Object.keys(staff).forEach(dept => {
staff[dept] = [];
});

// Process schedule data
for (let i = 1; i < jsonData.length; i++) {
const row = jsonData[i];
if (row && row.length >= 4) {
const dateStr = row[0];
const dayName = row[1];
const dept = row[2];
const dateParts = dateStr.split('-');
const date = new Date(`${dateParts[1]}-${dateParts[0]}-${dateParts[2]}`);
shifts.forEach((shift, index) => {
const staffNames = row[3 + index] ? row[3 + index].split(',').map(s => s.trim()): [];
staffNames.forEach(name => {
if (name) {
if (!staff[dept].some(s => s.name.toLowerCase() === name.toLowerCase())) {
// Add new staff if not exists
staff[dept].push({
name,
preferences: shifts.map(s => ({
name: s.name, days: 0
})),
gender: '',
role: 'n',
leaveDays: [],
weekendsOff: 0,
nightShifts: 0,
pregnantUntil: null,
languages: [],
maxConsecutiveNightShifts: 3
});
}
// Assign role based on existing supervisor list
const staffMember = staff[dept].find(s => s.name.toLowerCase() === name.toLowerCase());
if (supervisors.has(staffMember.name)) {
staffMember.role = 's';
weekdaySupervisors.add(staffMember.name);
}
schedule.push({
date,
department: dept,
staff: [name],
shift: shift.name
});
}
});
});
}
}

updateStaffList();
updateSupervisorSelect();
updateScheduleTable();
closeOverlay('importOverlay');
saveToFirebase();
};
reader.readAsArrayBuffer(file);
}

// Capture table image
function captureTableImage() {
html2canvas(document.getElementById('scheduleTable')).then(canvas => {
const link = document.createElement('a');
link.download = 'schedule_table.png';
link.href = canvas.toDataURL();
link.click();
});
}

// Generate PDF
function generatePDF() {
const element = document.getElementById('scheduleTable');
html2pdf()
.from(element)
.save('schedule.pdf');
}

// Batch update
function batchUpdate() {
const field = document.getElementById('batchUpdateField').value;
const value = document.getElementById('batchUpdateValue').value;
const selectedRows = Array.from(document.querySelectorAll('#scheduleTable tr.selected'));

if (selectedRows.length === 0) {
showFancyAlert("Please select rows to update.");
return;
}

selectedRows.forEach(row => {
const date = row.cells[0].textContent;
const department = row.cells[2].textContent;

schedule.forEach(entry => {
if (formatDate(entry.date) === date && entry.department === department) {
if (field === 'shift') {
entry.shift = value;
} else if (field === 'department') {
entry.department = value;
}
}
});
});

updateScheduleTable();
saveToFirebase();
document.getElementById('batchUpdateMessage').textContent = `Updated ${selectedRows.length} rows`;
}

function showTab(tabName) {
const tabs = document.getElementsByClassName('tab-content');
for (let tab of tabs) {
tab.style.display = 'none';
}
document.getElementById(tabName + 'Tab').style.display = 'block';

const buttons = document.getElementsByClassName('tab-button');
for (let button of buttons) {
button.classList.remove('active');
}
event.target.classList.add('active');

if (tabName === 'stats') {
generateStats();
}
}


// Modified generateStats function
function generateStats() {
const statsTab = document.getElementById('statsTab');
statsTab.innerHTML = '<h2>Schedule Statistics</h2>';

const iframe = document.createElement('iframe');
iframe.className = 'stats-iframe';
statsTab.appendChild(iframe);

const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
iframeDoc.body.innerHTML = `
<table class="stats-table">
<thead>
<tr>
<th>Name</th>
<th>Weekend Offs</th>
<th>Morning</th>
<th>Mid-Morning</th>
<th>Afternoon</th>
<th>Night</th>
<th>Action</th>
</tr>
</thead>
<tbody id="statsTableBody"></tbody>
</table>
`;

const staffStats = calculateStaffStats();
const tableBody = iframeDoc.getElementById('statsTableBody');

for (const [staffName, stats] of Object.entries(staffStats)) {
const row = iframeDoc.createElement('tr');
row.innerHTML = `
<td>${staffName}</td>
<td>${stats.weekendOffs}</td>
<td>${stats.morningShifts}</td>
<td>${stats.midMorningShifts}</td>
<td>${stats.afternoonShifts}</td>
<td>${stats.nightShifts}</td>
<td><button class="refix-button" onclick="parent.refixStaff('${staffName}')">Refix</button></td>
`;
tableBody.appendChild(row);
}

// Apply styles to the iframe content
const style = iframeDoc.createElement('style');
style.textContent = `
body { font-family: Arial, sans-serif; font-size: 12px; }
.stats-table { width: 100%; border-collapse: collapse; }
.stats-table th, .stats-table td { border: 1px solid #ddd; padding: 5px; text-align: center; }
.stats-table tr:nth-child(even) { background-color: #f2f2f2; }
.refix-button { background-color: #4CAF50; color: white; border: none; padding: 2px 5px; cursor: pointer; font-size: 10px; }
`;
iframeDoc.head.appendChild(style);
}

// New function to refix individual staff schedule
function refixStaff(staffName) {
// Implement the logic to refix the schedule for the specific staff member
console.log(`Refixing schedule for ${staffName}`);
// You can add your refixing logic here
showFancyAlert(`Schedule refixed for ${staffName}`);
generateStats(); // Regenerate stats after refixing
}

// Modified calculateStaffStats function
function calculateStaffStats() {
const staffStats = {};

schedule.forEach(entry => {
const date = new Date(entry.date);
const isWeekend = date.getDay() === 0 || date.getDay() === 6;

entry.staff.forEach(staffName => {
if (!staffStats[staffName]) {
staffStats[staffName] = {
weekendOffs: 0,
morningShifts: 0,
midMorningShifts: 0,
afternoonShifts: 0,
nightShifts: 0
};
}

if (isWeekend && !entry.staff.includes(staffName)) {
staffStats[staffName].weekendOffs++;
}

switch (entry.shift) {
case 'Morning':
staffStats[staffName].morningShifts++;
break;
case 'Mid-Morning':
staffStats[staffName].midMorningShifts++;
break;
case 'Afternoon':
staffStats[staffName].afternoonShifts++;
break;
case 'Night':
staffStats[staffName].nightShifts++;
break;
}
});
});

return staffStats;
}


function fixSchedule() {
// Implement schedule fixing logic here
// This could involve reassigning staff to their preferred shifts
// and ensuring each staff member works their required number of days
showFancyAlert('Schedule fixing functionality to be implemented');
}


// Show feedback form
function showFeedbackForm() {
document.getElementById('feedbackContainer').style.display = 'block';
}

// Close feedback form
function closeFeedbackForm() {
document.getElementById('feedbackContainer').style.display = 'none';
}

// Submit feedback
function submitFeedback() {
const feedback = document.getElementById('feedbackText').value;
if (feedback.trim() === '') {
showFancyAlert('Please enter your feedback before submitting.');
return;
}
// Here you would typically send the feedback to a server
console.log('Feedback submitted:', feedback);
showFancyAlert('Thank you for your feedback!');
closeFeedbackForm();
}

function toggleChatVisibility() {
    const chatContent = document.getElementById('chatContent');
    chatContent.style.display = chatContent.style.display === 'none' ? 'block' : 'none';
}

// Replace showFancyAlert() calls with this function
function showWarning(message) {
const warningContainer = document.getElementById('warningContainer');
const warningElement = document.createElement('div');
warningElement.className = 'warning';
warningElement.textContent = message;
warningContainer.appendChild(warningElement);

// Remove the warning after 5 seconds
setTimeout(() => {
warningContainer.removeChild(warningElement);
}, 5000);
}

// Start tutorial
function startTutorial() {
const tour = new Shepherd.Tour({
defaultStepOptions: {
cancelIcon: {
enabled: true
},
classes: 'shepherd-theme-arrows'
}
});

tour.addStep({
id: 'welcome',
text: 'Welcome to the ISOD Staff Scheduling System! Let\'s take a quick tour.',
buttons: [{
text: 'Next',
action: tour.next
}]
});

tour.addStep({
id: 'departments',
text: 'Here you can manage departments and shifts.',
attachTo: {
element: '.department-shift-container',
on: 'bottom'
},
buttons: [{
text: 'Back',
action: tour.back
},
{
text: 'Next',
action: tour.next
}]
});

tour.addStep({
id: 'staff',
text: 'Add and manage staff members here.',
attachTo: {
element: '#staffList',
on: 'top'
},
buttons: [{
text: 'Back',
action: tour.back
},
{
text: 'Next',
action: tour.next
}]
});

tour.addStep({
id: 'schedule',
text: 'Generate and view the schedule in this section.',
attachTo: {
element: '.schedule-container',
on: 'top'
},
buttons: [{
text: 'Back',
action: tour.back
},
{
text: 'Finish',
action: tour.complete
}]
});

tour.start();
}

// Add this to your JavaScript
const greetings = [
"Have a great day!",
"Smile and shine!",
"Make today amazing!",
"Embrace the day's potential!",
"Spread positivity today!"
];

function updateGreeting() {
const dateElement = document.getElementById('currentDate');
const messageElement = document.getElementById('greetingMessage');
const now = new Date();

dateElement.textContent = now.toLocaleDateString('en-US', {
month: 'short', day: 'numeric'
});
messageElement.textContent = greetings[Math.floor(Math.random() * greetings.length)];
}

function toggleGreeting() {
const carousel = document.querySelector('.greeting-carousel');
carousel.style.display = carousel.style.display === 'none' ? 'flex': 'none';
}

// Call this function to initialize the greeting
updateGreeting();

// Update the greeting every day
setInterval(updateGreeting, 24 * 60 * 60 * 1000);

// Add event listener to the toggle button
document.querySelector('.greeting-toggle').addEventListener('click',
toggleGreeting);

// Initialize the application when the page loads
window.onload = function() {
// Check if the user is already logged in
firebase.auth().onAuthStateChanged(function(user) {
if (user) {
// User is signed in, show main content
document.getElementById('mainContent').style.display = 'block';
document.getElementById('loginForm').style.display = 'none';
initializeApp();
} else {
// No user is signed in, show login form
document.getElementById('mainContent').style.display = 'none';
document.getElementById('loginForm').style.display = 'block';
document.getElementById('loginModal').style.display
= 'block';
}
});
};

const adImages = [
"https://pfst.cf2.poecdn.net/base/image/0dc9069000123086cea600dd48bb1e9c59766d8d873109a5eb96ed96553a2349?w=1024&h=768&pmaid=168860672",
"https://pfst.cf2.poecdn.net/base/image/bae8681671aba1845ac587399689943d567687de1c4df4317384bfedb6e1c53b?w=1024&h=768&pmaid=168863441",
"https://pfst.cf2.poecdn.net/base/image/485b98d01ef23589bb782e148f9f084e0601d8d2880fc17deda75cf593f25fc5?w=1024&h=768&pmaid=168882048",
"https://pfst.cf2.poecdn.net/base/image/6a40a073a53e45474602419238321bc5276afcfc330eab1216a9c75bcc95d1f9?w=1024&h=768&pmaid=168890364",
"https://pfst.cf2.poecdn.net/base/image/bf65121a4356296cc3b921a827627b873ebd46de6e7ad1b2d7ead78832fb3731?w=1024&h=768&pmaid=168898041"
];

let currentAdIndex = 0;

function initAdCarousel() {
const adContainer = document.querySelector('.ad-container');
adImages.forEach((src, index) => {
const img = document.createElement('img');
img.src = src;
img.style.display = index === 0 ? 'block': 'none';
adContainer.appendChild(img);
});

setInterval(nextAd,
5000); // Change ad every 5 seconds
}

function nextAd() {
const adContainer = document.querySelector('.ad-container');
const ads = adContainer.querySelectorAll('img');
ads[currentAdIndex].style.display = 'none';
currentAdIndex = (currentAdIndex + 1) % ads.length;
ads[currentAdIndex].style.display = 'block';
}

document.querySelector('.ad-button').addEventListener('click', () => {
// Add your ad click functionality here
showFancyAlert('Ad clicked!');
});

initAdCarousel();

// Add dark mode toggle to hamburger menu
function addDarkModeToggle() {
const dropdownContent = document.querySelector('.dropdown-content');
const darkModeLink = document.createElement('a');
darkModeLink.href = '#';
darkModeLink.innerHTML = '<i class="fas fa-moon"></i> Toggle Dark Mode';
darkModeLink.onclick = toggleDarkMode;
dropdownContent.appendChild(darkModeLink);
}

// Call this function after the page loads
window.addEventListener('load', addDarkModeToggle);


// New UI feature: Dark mode toggle
// Modify toggleDarkMode function
// Modify the existing toggleDarkMode function
function toggleDarkMode() {
document.body.classList.toggle('dark-mode');
const isDarkMode = document.body.classList.contains('dark-mode');
localStorage.setItem('darkMode',
isDarkMode);

// Update checkbox in settings
document.getElementById('darkModeToggle').checked = isDarkMode;

showTooltip(isDarkMode ? 'Dark mode enabled': 'Dark mode disabled');
}

// Check for saved dark mode preference
// Initialize dark mode
if (localStorage.getItem('darkMode') === 'true') {
document.body.classList.add('dark-mode');
}

// Add dark mode toggle button to the UI
/*const darkModeButton = document.createElement('button');
darkModeButton.textContent = 'Toggle Dark Mode';
darkModeButton.onclick = toggleDarkMode;
document.body.appendChild(darkModeButton);*/

// Make sure to call these functions to initialize new features
document.addEventListener('DOMContentLoaded',
function() {
/*
            // Add chat toggle button to the header
            const header = document.querySelector('.header');
            const chatToggle = document.createElement('button');
            chatToggle.innerHTML = '<i class="fas fa-comments"></i>';
            chatToggle.onclick = toggleChatBar;
            header.appendChild(chatToggle);*/

initAdCarousel();
updateGreeting();
setInterval(updateGreeting, 24 * 60 * 60 *
1000); // Update greeting daily

// Initialize other features...
});

   const greetingAdCarousel = document.getElementById('greetingAdCarousel');
        const carouselItems = [];

        function initGreetingAdCarousel() {
            adImages.forEach((src, index) => {
                const item = document.createElement('div');
                item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                item.innerHTML = `
                    <img src="${src}" class="carousel-image" alt="Greeting ${index + 1}">
                    <div class="greeting-overlay">
                        <div class="greeting-date" id="greetingDate${index}"></div>
                        <div class="greeting-message">${greetings[index]}</div>
                    </div>
                `;
                greetingAdCarousel.appendChild(item);
                carouselItems.push(item);
            });

            const dots = document.createElement('div');
            dots.className = 'carousel-dots';
            adImages.forEach((_, index) => {
                const dot = document.createElement('div');
                dot.className = `dot ${index === 0 ? 'active' : ''}`;
                dot.onclick = () => goToSlide(index);
                dots.appendChild(dot);
            });
            greetingAdCarousel.appendChild(dots);

            updateGreetingDates();
            setInterval(nextSlide, 5000);
        }

        function updateGreetingDates() {
            const now = new Date();
            carouselItems.forEach((item, index) => {
                const dateElement = item.querySelector(`#greetingDate${index}`);
                dateElement.textContent = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
        }

        let currentSlide = 0;

        function nextSlide() {
            goToSlide((currentSlide + 1) % carouselItems.length);
        }

        function goToSlide(n) {
            carouselItems[currentSlide].classList.remove('active');
            document.querySelectorAll('.dot')[currentSlide].classList.remove('active');
            currentSlide = n;
            carouselItems[currentSlide].classList.add('active');
            document.querySelectorAll('.dot')[currentSlide].classList.add('active');
        }

        function toggleForums() {
            document.getElementById('forumsPanel').classList.toggle('open');
        }

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('open');
        }

        function sendMessage() {
            const input = document.getElementById('forumsInput');
            const message = input.value.trim();
            if (message) {
                const messagesContainer = document.getElementById('forumsMessages');
                const messageElement = document.createElement('div');
                messageElement.textContent = message;
                messagesContainer.appendChild(messageElement);
                input.value = '';
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
         // Check if user is a Centaur
        function checkIfCentaur(user) {
            firebase.database().ref('centaurs/' + user.uid).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        user.isCentaur = true;
                        showFancyAlert('Welcome, Centaur!');
                        addCentaurBadge();
                    }
                });
        }

        // Add Centaur badge to the UI
        function addCentaurBadge() {
            const badge = document.createElement('span');
            badge.className = 'centaur-badge';
            badge.textContent = 'Centaur';
            document.querySelector('.header').appendChild(badge);
        }

        // Chat system functions
        function toggleChatSystem() {
            const chatSystem = document.getElementById('chatSystem');
            chatSystem.style.display = chatSystem.style.display === 'none' ? 'flex' : 'none';
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageElement = document.createElement('div');
                messageElement.textContent = message;
                messagesContainer.appendChild(messageElement);
                input.value = '';
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // If the user is a Centaur and the message starts with "/push", treat it as a push notification
                if (currentUser.isCentaur && message.startsWith('/push')) {
                    sendPushNotification(message.slice(6));
                }
            }
        }

        // Send push notification (for Centaurs)
        function sendPushNotification(message) {
            // In a real-world scenario, you'd send this to a server to handle push notifications
            // For this example, we'll just show it as a fancy alert
            showFancyAlert('Push Notification Sent: ' + message);
        }

        // Fancy Alert function
        function showFancyAlert(message) {
            const alertBox = document.getElementById('fancyAlert');
            alertBox.textContent = message;
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 3000);
        }


        function startVoiceInput() {
            // Implement voice input functionality here
            showFancyAlert('Voice input feature to be implemented');
        }

        // Initialize the greeting-ad carousel when the page loads
        window.addEventListener('load', initGreetingAdCarousel);


</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISOD Staff Scheduling System</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- XLSX for Excel import/export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <!-- HTML2Canvas and html2pdf for capturing and generating PDFs -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Shepherd for onboarding tutorial -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@9.1.1/dist/css/shepherd.css" />
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@9.1.1/dist/js/shepherd.min.js"></script>
    <!-- DataTables for enhanced table functionality -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <!-- SortableJS for drag-and-drop functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
:root {
        --dark-blue: #1a2a3a;
        --yellow: #329208;
        --text-color: #ffffff;
        --border-color: rgba(255, 255, 255, 0.2);
        --highlight-color: rgba(255, 215, 0, 0.2);
        --supervisor-color: #ff4500;
        --morning-color: #87CEEB;
        --midmorning-color: #00CED1;
        --afternoon-color: #FFA500;
        --night-color: #4B0082;
        --overlay-bg: rgba(26, 42, 58, 0.95);
        --button-hover: #e6c200;
        --table-header: rgba(255, 255, 255, 0.1);
        --week-separator-bg: var(--yellow);
        --week-separator-text: var(--dark-blue);
    }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--dark-blue);
            color: var(--text-color);
            font-size: 14px;
            background-image: url('https://pfst.cf2.poecdn.net/base/image/2ee0c5b959e51b25b9c8df43d2b4498a32304a9f173f78b251faf1850dc9e2cf?w=1024&h=576&pmaid=160532020');
            background-size: cover;
            background-attachment: fixed;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--overlay-bg);
            z-index: -1;
        }
        .container {
            max-width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }
        h1, h2 {
            color: var(--yellow);
            margin: 10px 0;
            text-align: center;
        }
        input, select, button, textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: none;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-size: 14px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--yellow);
        }
        button {
            background-color: var(--yellow);
            color: var(--dark-blue);
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: var(--button-hover);
        }
        .scroll-container {
            display: flex;
            overflow-x: auto;
            padding: 5px 0;
            gap: 5px;
        }
        .scroll-item {
            flex: 0 0 auto;
            padding: 5px 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        .scroll-item.active {
            background-color: var(--yellow);
            color: var(--dark-blue);
        }
        .staff-card {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 8px;
            margin-right: 5px;
            min-width: 150px;
            font-size: 12px;
        }
        .staff-card h3 {
            margin: 0 0 5px 0;
            font-size: 14px;
        }
        .supervisor {
            color: var(--supervisor-color);
            font-weight: bold;
        }
        .schedule-container {
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-top: 10px;
            max-height: 600px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            background-color: var(--dark-blue);
            color: var(--text-color);
            font-size: 12px;
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 5px;
            text-align: center;
            vertical-align: middle;
        }
        th {
            background-color: var(--table-header);
            position: sticky;
            top: 0;
            z-index: 2;
        }
        .editable:focus {
            background-color: rgba(255, 255, 255, 0.2);
            outline: none;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        .overlay-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--dark-blue);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            font-size: 24px;
            color: var(--text-color);
        }
        .preference-container {
            margin-bottom: 10px;
        }
        .preference-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        .preference-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--yellow);
            cursor: pointer;
            box-shadow: 0 0 0 3px var(--dark-blue), 0 0 0 6px var(--yellow);
        }
        .preference-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--yellow);
            cursor: pointer;
            box-shadow: 0 0 0 3px var(--dark-blue), 0 0 0 6px var(--yellow);
        }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .add-icon {
            cursor: pointer;
            font-size: 16px;
            color: var(--yellow);
        }
        .warninga {
            background-color: rgba(255, 215, 0, 0.2);
            border: 1px solid var(--yellow);
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .warning {
            background-color: rgba(255, 215, 0, 0.2);
            border: 1px solid var(--yellow);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .supervisor-select {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .supervisor-option {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        .supervisor-option.selected {
            background-color: var(--yellow);
            color: var(--dark-blue);
        }
        .calendar-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .calendar-bar input[type="date"] {
            background-color: transparent;
            border: none;
            color: var(--text-color);
            font-size: 12px;
        }
        /* Updated search container styles */
        .search-container {
            position: relative;
            margin-bottom: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .search-container input {
            padding-left: 25px;
        }
        .search-icon {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color);
            font-size: 12px;
        }
        /* Add these styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }


        .chat-toggle, .chat-close {
            background: none;
            border: none;
            color: var(--yellow);
            font-size: 24px;
            cursor: pointer;
        }
        .hamburger {
            font-size: 24px;
            cursor: pointer;
            color: var(--yellow);
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--dark-blue);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            right: 0;
        }
        .dropdown-content a {
            color: var(--text-color);
            padding: 10px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .dropdown-content a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
        .cycle-setter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .cycle-setter i {
            font-size: 20px;
            color: var(--yellow);
        }
        .department-shift-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .department-shift-section {
            margin-bottom: 10px;
        }
        .highlighted {
            background-color: var(--highlight-color);
        }
        .week-separator {
            background-color: var(--week-separator-bg);
            color: var(--week-separator-text);
            font-weight: bold;
            text-align: center;
            padding: 8px;
            font-size: 16px;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        .preference-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .preference-input input[type="number"] {
            width: 60px;
        }
        .previous-generations {
            display: flex;
            overflow-x: auto;
            padding: 10px 0;
            gap: 10px;
        }
        .generation-item {
            flex: 0 0 auto;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            position: relative;
            transition: background-color 0.3s;
        }
        .generation-item:hover {
            background-color: rgba(255, 215, 0, 0.3);
        }
        .generation-item .trash-icon {
            color: var(--yellow);
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
        }
        .staff-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            background-color: var(--supervisor-color);
            color: var(--text-color);
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            margin: 2px;
            cursor: pointer;
        }
        .progress-bar {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            height: 5px;
            margin-top: 5px;
        }

        .progress {
            height: 100%;
            background-color: green;
            transition: width 0.3s ease;
        }
        .active-users {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .active-user {
            display: inline-block;
            margin-right: 10px;
            padding: 5px 10px;
            background-color: var(--yellow);
            color: var(--dark-blue);
            border-radius: 15px;
            font-size: 12px;
        }
        .feedback-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--dark-blue);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            display: none;
        }
        .feedback-container textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
        }
        .feedback-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--yellow);
            color: var(--dark-blue);
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        .batch-update-container {
            margin-bottom: 20px;
        }
        .batch-update-container select, .batch-update-container input {
            margin-right: 10px;
            width: auto;
        }
        .error-message {
            color: #ff6b6b;
            margin-top: 5px;
            font-size: 12px;
        }
        .success-message {
            color: #51cf66;
            margin-top: 5px;
            font-size: 12px;
        }
        .sortable {
            cursor: pointer;
        }

        .sortable:hover {
            background-color: var(--highlight-color);
        }

        .selected {
            background-color: var(--highlight-color);
        }

        .totals-row {
            font-weight: bold;
            background-color: var(--table-header);
        }
        .staff-name {
            display: inline-block;
            margin-right: 5px;
            font-size: 12px;
        }
        .supervisor {
            font-weight: bold;
            color: #ff4500;
        }

        .schedule-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            cursor: pointer;
        }

        .tab-button.active {
            border-bottom: 2px solid var(--yellow);
        }

        .tab-content {
            padding: 20px;
        }

        body.dark-mode {
            background-color: #201e22;
            color: #fff;
        }

        body.dark-mode .card,
        body.dark-mode .overlay-content {
            background-color: #1c1c1c;
        }

        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode button {
            background-color: #0f0f0f;
            color: #fff;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: var(--dark-blue);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            width: 80%;
            max-width: 900px;
            border-radius: 10px;
        }

        .close {
            color: var(--text-color);
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: var(--yellow);
            text-decoration: none;
            cursor: pointer;
        }

        .search-replace-container {
            margin-bottom: 10px;
        }

        .search-replace-container input {
            margin-right: 10px;
        }

        .expand-icon {
            cursor: pointer;
            font-size: 20px;
            color: var(--yellow);
        }

        /* Settings Modal Styles */
        /* Updated settings modal styles */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
            display: none;
        }

        .settings-content {
            background-color: var(--dark-blue);
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
        }


        .settings-header {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Highlight style for search results */
        .highlight-cell {
            background-color: rgba(91,0,255,0.3) !important;
        }

        /* Find All results container */
        .find-all-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .back-arrow {
            font-size: 24px;
            margin-right: 20px;
            cursor: pointer;
            color: var(--yellow);
        }

        .settings-content {
            padding: 20px;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h2 {
            margin-bottom: 15px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .setting-icon {
            font-size: 20px;
            margin-right: 15px;
            color: var(--yellow);
        }

        /* Update the about overlay styles */
        .about-overlay {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background-color: var(--dark-blue);
            transition: right 0.3s ease-in-out;
            z-index: 1001;
            overflow-y: auto;
        }

        .about-content {
            padding: 20px;
            color: var(--text-color);
        }

        .about-overlay.active {
            right: 0;
        }

        /* Tooltip Styles */
        .tooltip {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: var(--dark-blue);
            color: var(--text-color);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            font-size: 14px;
            max-width: 250px;
        }
        
        /* Login Modal */
                /* Login Modal Styles */
        .login-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }
             .login-modal-content {
            background-color: var(--dark-blue);
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            color: var(--text-color);
        }
                /* Chat System Styles */
        .chat-system {
	          display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 400px;
            background-color: var(--dark-blue);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
    
.chat-content {
    display: none;
}


        #scheduleTable {
            width: 100%;
            border-collapse: collapse;
        }
        #scheduleTable th, #scheduleTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #scheduleTable th {
            background-color: #f2f2f2;
        }
        #scheduleTable th {
            background-color: #480e83;
            color: #333;
        }
        .week-separator {
            background-color: #e6f2ff;
            font-weight: bold;
            text-align: center;
        }
        .shift-cell {
            max-width: none;
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
        }
        mark {
            background-color: #00ff90;
            color: #9d38fc;
        }

        .group {
            background-color: var(--week-separator-bg);
            font-weight: bold;
        }
        .tutorial-highlight {
            box-shadow: 0 0 0 2px var(--yellow);
        }
        
        /* new header styles */
        
        
        .header-icon {
            font-size: 24px;
            color: var(--yellow);
            cursor: pointer;
        }

        
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }
        
                .greeting-ad-carousel {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .carousel-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .carousel-item.active {
            opacity: 1;
        }

        .carousel-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }


        /* New styles for the chat bar */
        .chat-bar {
            width: 300px;
            height: 100%;
            position: fixed;
            top: 0;
            left: -300px;
            background-color: var(--dark-blue);
            transition: left 0.3s ease-in-out;
            z-index: 1000;
        }

        .chat-bar.open {
            left: 0;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--yellow);
            color: var(--dark-blue);
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-input {
            display: flex;
            padding: 10px;
        }
        .chat-input input {
            flex-grow: 1;
            margin-right: 10px;
        }
        
                /* Fancy Alert Box Styles */
        .fancy-alert {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--dark-blue);
            color: var(--text-color);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Centaur Badge */
        .centaur-badge {
            background-color: var(--yellow);
            color: var(--dark-blue);
            padding: 2px 5px;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 5px;
        }

        .chat-input button {
            background-color: transparent;
            border: none;
            color: var(--yellow);
            font-size: 20px;
            cursor: pointer;
        }

        .ad-carousel {
            position: relative;
            width: 100%;
            height: 200px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .ad-container {
            width: 100%;
            height: 100%;
        }

        .ad-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ad-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: var(--yellow);
            color: var(--dark-blue);
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }

        /* Styles for the stats table */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .stats-table th, .stats-table td {
            border: 1px solid var(--border-color);
            padding: 5px;
            text-align: center;
        }

        .stats-table tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .stats-iframe {
            width: 100%;
            height: 400px;
            border: none;
        }

        .refix-button {
            background-color: var(--yellow);
            color: var(--dark-blue);
            border: none;
            padding: 2px 5px;
            cursor: pointer;
            font-size: 10px;
        }

        .greeting-carousel {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .greeting-content {
            display: flex;
            flex-direction: column;
        }

        .greeting-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .greeting-date {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .greeting-message {
            font-size: 32px;
            font-style: italic;
        }

        .greeting-toggle {
            background: none;
            border: none;
            color: var(--yellow);
            font-size: 18px;
            cursor: pointer;
        }

.carousel-dots {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.5);
            margin: 0 5px;
            cursor: pointer;
        }

        .dot.active {
            background-color: white;
        }

        .forums-panel {
            position: fixed;
            left: -300px;
            top: 0;
            width: 300px;
            height: 100%;
            background-color: var(--dark-blue);
            transition: left 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }

        .forums-panel.open {
            left: 0;
        }

        .forums-header {
            padding: 10px;
            background-color: var(--yellow);
            color: var(--dark-blue);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .forums-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background-image: url('path/to/your/chat-background-image.jpg');
            background-size: cover;
        }

        .forums-input {
            display: flex;
            padding: 10px;
            background-color: rgba(255,255,255,0.1);
        }

        .forums-input input {
            flex-grow: 1;
            margin-right: 10px;
        }

        .forums-input button {
            background: none;
            border: none;
            color: var(--yellow);
            font-size: 20px;
            cursor: pointer;
        }

        .settings-panel {
            position: fixed;
            right: -300px;
            top: 0;
            width: 300px;
            height: 100%;
            background-color: var(--dark-blue);
            transition: right 0.3s ease-in-out;
        }

        .settings-panel.open {
            right: 0;
        }

@media (max-width: 1024px) {
            .schedule-container {
                max-height: 400px;
            }
        }
@media (max-width: 768px) {
            .cycle-setter {
                flex-direction: column;
                align-items: flex-start;
            }
            .calendar-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            .schedule-container {
                max-height: 300px;
            }
        }
@media (max-width: 600px) {
            .schedule-container {
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="main-header">
						
						<h1 class="header-icon">        🌵ISOD Staff Scheduler</h1>
            
            <button class="chat-toggle"
            onclick="toggleChatBar()"><i
            class="fas fa-paper-plane
            header-icon"></i></button>
            
            <div class="dropdown">
                <span class="hamburger header-icon">&#9776;</span>
                <div class="dropdown-content">
                    <a href="#" onclick="showImportOverlay()"><i class="fas fa-file-import"></i> Import Excel</a>
                    <a href="#" onclick="exportExcel()"><i class="fas fa-file-export"></i> Export Excel</a>
                    <a href="#" onclick="saveToFirebase()"><i class="fas fa-save"></i> Save Schedule</a>
                    <a href="#" onclick="loadFromFirebase()"><i class="fas fa-folder-open"></i> Load Schedule</a>
                    <a href="#" onclick="captureTableImage()"><i class="fas fa-camera"></i> Capture Table</a>
                    <a href="#" onclick="generatePDF()"><i class="fas fa-file-pdf"></i> Generate PDF</a>
                    <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    <a href="#" onclick="skipLogin()"><i class="fas fa-forward"></i> Skip Login</a>
                    <a href="#" onclick="startTutorial()"><i class="fas fa-question-circle"></i> Start Tutorial</a>
                </div>
            </div>
            
            
        </div>
    </header>
    
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-modal-content">
            <h2>Login</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()">Login</button>
            <button onclick="showSignUpForm()">Sign Up</button>
            <button onclick="skipLogin()">Skip Login</button>
        </div>
    </div>



    <!-- Fancy Alert Box -->
    <div id="fancyAlert"
    class="fancy-alert"></div>
    

    <div id="loginForm" style="display: none;">
        <h2>Login</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <button onclick="showSignUpForm()">Sign Up</button>
        <button onclick="skipLogin()">Skip Login</button>
    </div>

    <div id="signUpForm" style="display: none;">
        <h2>Sign Up</h2>
        <input type="email" id="signUpEmail" placeholder="Email">
        <input type="password" id="signUpPassword" placeholder="Password">
        <button onclick="signUp()">Sign Up</button>
        <button onclick="showLoginForm()">Back to Login</button>
    </div>

    <div id="onboardingScreens" style="display: none;">
        <div id="onboardingContent">
            <!-- Onboarding content will be populated here -->
        </div>
        <div style="text-align: center;">
            <button onclick="prevOnboarding()">Previous</button>
            <button onclick="nextOnboarding()">Next</button>
            <button onclick="skipOnboarding()">Skip</button>
        </div>
    </div>

    <div id="mainContent" style="display: none;">
        <div class="active-users" id="activeUsers">
            <!-- Active users will be populated here -->
        </div>

        <div class="chat-bar" id="chatBar">
            <div class="chat-header">
                <span>Chat</span>
                <button class="chat-close" onclick="toggleChatBar()"><i class="fas fa-times"></i></button>
            </div>
            <!-- Rest of your chat bar content -->
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Type a message...">
                <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        <!--
            <div class="greeting-ad-carousel" id="greetingAdCarousel">
        <!-- Carousel items will be dynamically added here 
    </div> -->
    
    <div class="forums-panel" id="forumsPanel">
        <div class="forums-header">
            <span>Forums</span>
            <i class="fas fa-times" onclick="toggleForums()"></i>
        </div>
        <div class="forums-messages" id="forumsMessages"></div>
        <div class="forums-input">
            <input type="text" id="forumsInput" placeholder="Type a message...">
            <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            <button onclick="startVoiceInput()"><i class="fas fa-microphone"></i></button>
        </div>
    </div>
    
<div class="settings-panel" id="settingsPanel">
        <!-- Settings content -->
    </div>
    
				<!--
        <div class="ad-carousel">
            <div class="ad-container">
                <!-- Ad images will be inserted here dynamically 
            </div>
            <button class="ad-button">View Ad</button>
        </div> -->


        <!-- Add this before the
            department-shift-container -->
        <div class="greeting-carousel">
            <div class="greeting-content">
                <div class="greeting-date">
                    <i class="fas fa-calendar-alt"></i> <span id="currentDate"></span>
                </div>
                <div class="greeting-message" id="greetingMessage"></div>
            </div>
            <!--
            <div class="carousel-dots">
                <span class="dot active"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div> -->
        </div>

        <div class="card">
            <div class="department-shift-container">
                <div class="department-shift-section">
                    <div class="section-header">
                        <h2><i class="fas fa-building"></i> Departments</h2>
                        <i class="fas fa-plus-circle add-icon" onclick="showAddDepartmentOverlay()" title="Add Department"></i>
                    </div>
                    <div class="scroll-container" id="departmentScroll">
                        <!-- Department buttons will be populated here -->
                    </div>
                </div>
                <div class="department-shift-section">
                    <div class="section-header">
                        <h2><i class="fas fa-clock"></i> Shifts</h2>
                        <i class="fas fa-plus-circle add-icon" onclick="showAddShiftOverlay()" title="Add Shift"></i>
                    </div>
                    <div class="scroll-container" id="shiftScroll">
                        <!-- Shift buttons will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Add Staff</h2>
            <select id="departmentSelect">
                <option value="">Select Department</option>
                <!-- Department options will be populated here -->
            </select>
            <textarea id="quickAddStaff" placeholder="Enter comma-separated staff names (e.g., Tosin, Leke, Juwon, Isaac)" rows="3"></textarea>
            <button onclick="quickAddStaff()">Add Staff <i class="fas fa-user-plus"></i></button>
            <button onclick="showAddStaffOverlay()">Add Individual Staff</button>
            <button onclick="useDefaultStaff()">Use Default Staff Data</button>
        </div>

        <div class="card">
            <h2>Set Supervisors</h2>
            <div class="supervisor-select" id="supervisorSelect">
                <!-- Supervisor options will be populated here -->
            </div>
            <button onclick="setSupervisors()">Update Supervisors <i class="fas fa-user-shield"></i></button>
        </div>

        <div class="card">
            <h2>Staff List</h2>
            <div class="scroll-container" id="staffList">
                <!-- Staff cards will be populated here -->
            </div>
        </div>

        <div class="card">
            <div class="cycle-setter">
                <i class="fas fa-calendar-alt"></i>
                <select id="cycleDuration">
                    <option value="4">4 Weeks</option>
                    <option value="5">5 Weeks</option>
                </select>
                <span>Cycle</span>
                <button onclick="setCycleDuration()">Set Cycle</button>
            </div>

            <div class="calendar-bar">
                <input type="date" id="cycleStartDate">
                <span>to</span>
                <input type="date" id="cycleEndDate">
            </div>
        </div>

        <!-- Updated search container -->
        <div class="card">
            <h2>Current Schedule</h2>
            <div class="search-container">
                <!-- <i class="fas fa-search
                                               search-icon"></i>-->
                <input type="text" id="searchInput"
                placeholder="🔍    Search staff...">
                <button onclick="findNext()">Find Next</button>
                <button onclick="findAll()">Find All</button>
                <span id="searchResults"></span>
            </div>
            <div id="findAllResults" class="find-all-results" style="display: none;"></div>
        </div>
        <div id="warningContainer"></div>
        <div class="batch-update-container">
            <h3>Batch Update</h3>
            <select id="batchUpdateField">
                <option value="shift">Shift</option>
                <option value="department">Department</option>
            </select>
            <input type="text" id="batchUpdateValue" placeholder="New value">
            <button
                onclick="batchUpdate()">Update</button>
            <div
                id="batchUpdateMessage"></div>
        </div>
        <!-- Add this div for warnings -->
        <div id="warningContainer"></div>
        <div class="schedule-tabs">
            <button class="tab-button active" onclick="showTab('timetable')">Timetable</button>
            <button class="tab-button" onclick="showTab('stats')">Stats</button>
        </div>
        <div id="timetableTab" class="tab-content">

            <div class="schedule-container">
                <table id="scheduleTable">
                    <!-- Schedule table will be generated here -->
                </table>
            </div>
        </div>

        <div id="statsTab" class="tab-content" style="display: none;">
            <!-- Stats content will be dynamically generated here -->
        </div>
    </div>

    <button onclick="generateSchedule()">Generate Schedule <i class="fas fa-calendar-check"></i></button>
    <button onclick="resetAllStaff()">Reset All Staff</button>

    <div class="card">
        <h2>Previous Generations</h2>
        <div class="previous-generations" id="previousGenerations">
            <!-- Previous generations will be listed here -->
        </div>
    </div>
</div>
</div>

<!-- Overlays and Modals -->
<div class="overlay" id="preferencesOverlay">
<div class="overlay-content">
<span class="close-btn" onclick="closeOverlay('preferencesOverlay')">&times;</span>
<h2>Edit Preferences</h2>
<div id="preferencesContent"></div>
<button onclick="savePreferences()">Save Preferences</button>
</div>
</div>

<div class="overlay" id="addDepartmentOverlay">
<div class="overlay-content">
<span class="close-btn" onclick="closeOverlay('addDepartmentOverlay')">&times;</span>
<h2>Add Department</h2>
<input type="text" id="newDepartment" placeholder="Department Name">
<input type="text" id="newDepartmentAbbr" placeholder="Abbreviation">
<button onclick="addDepartment()">Add Department</button>
</div>
</div>

<div class="overlay" id="addShiftOverlay">
<div class="overlay-content">
<span class="close-btn" onclick="closeOverlay('addShiftOverlay')">&times;</span>
<h2>Add Shift</h2>
<input type="text" id="newShiftName" placeholder="Shift Name">
<input type="time" id="newShiftStart" placeholder="Start Time">
<input type="time" id="newShiftEnd" placeholder="End Time">
<input type="number" id="newShiftMinStaff" placeholder="Minimum Staff" min="1">
<button onclick="addShift()">Add Shift</button>
</div>
</div>

<div class="overlay" id="importOverlay">
<div class="overlay-content">
<span class="close-btn" onclick="closeOverlay('importOverlay')">&times;</span>
<h2>Import Excel</h2>
<input type="file" id="excelFile" accept=".xlsx, .xls">
<button onclick="importExcel()">Import</button>
</div>
</div>

<div class="overlay" id="addStaffOverlay">
<div class="overlay-content">
<span class="close-btn" onclick="closeOverlay('addStaffOverlay')">&times;</span>
<h2>Add New Staff</h2>
<input type="text" id="staffName" placeholder="Staff Name">
<select id="staffGender">
<option value="">Select Gender</option>
<option value="F">Female</option>
<option value="M">Male</option>
</select>
<select id="staffRole">
<option value="n">Normal</option>
<option value="s">Supervisor</option>
</select>
<input type="text" id="staffLanguage" placeholder="Language(s) Spoken">
<input type="date" id="staffPregnantUntil" placeholder="Pregnant Until (optional)">
<input type="date" id="staffLeaveStart" placeholder="Leave Start Date">
<input type="date" id="staffLeaveEnd" placeholder="Leave End Date">
<button onclick="addIndividualStaff()">Add Staff</button>
</div>
</div>

<div class="feedback-button" onclick="showFeedbackForm()">
Feedback
</div>
<div class="feedback-container" id="feedbackContainer">
<h3>Provide Feedback</h3>
<textarea id="feedbackText" placeholder="Enter your feedback here..."></textarea>
<button onclick="submitFeedback()">Submit Feedback</button>
<button onclick="closeFeedbackForm()">Close</button>
</div>

<div id="scheduleModal" class="modal">
<div class="modal-content">
<span class="close">&times;</span>
<div class="search-replace-container">
<input type="text" id="searchInput" placeholder="Search">
<input type="text" id="replaceInput" placeholder="Replace">
<button onclick="searchAndReplace()">Replace</button>
<div class="search-container">
<!-- <i class="fas fa-search
                           search-icon"></i>-->
<input type="text" id="searchInput"
placeholder="🔍    Search staff...">
<button onclick="findNext()">Find Next</button>
<button onclick="findAll()">Find All</button>
<span id="searchResults"></span>
</div>
<input type="range" id="zoomSlider"
min="50" max="150" value="100"
oninput="zoomTable(this.value)">
<span id="zoomValue">100%</span>
</div>
<div id="modalScheduleContainer"></div>
</div>
</div>

<!-- Updated settings modal -->
<div id="settingsModal" class="settings-modal">
<div class="settings-content">
<div class="settings-header">
<i class="fas fa-arrow-left back-arrow" onclick="closeSettingsModal()"></i>
<h2>Settings</h2>
</div>
<div class="settings-section">
<h2>General</h2>
<div class="setting-item">
<i class="fas fa-moon setting-icon"></i>
<span>Dark Mode</span>
<input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
</div>
<div class="setting-item">
<i class="fas fa-info-circle setting-icon"></i>
<span>About</span>
<button onclick="showAboutInfo()">View</button>
</div>
<div id="aboutOverlay" class="about-overlay">
<div class="about-content">
<h2>About ISOD Staff Scheduling System</h2>
<p>
Version: 1.0
</p>
<p>
Developed by: Your Company
</p>
<p>
Description: A comprehensive staff scheduling system for efficient workforce management.
</p>
<button onclick="closeAboutOverlay()">Back to Settings</button>
</div>
</div>

<div class="setting-item">
<i class="fas fa-share-alt setting-icon"></i>
<span>Share</span>
<button onclick="shareSchedule()">Share</button>
</div>
</div>
<div class="settings-section">
<h2>Notifications</h2>
<div class="setting-item">
<i class="fas fa-bell setting-icon"></i>
<span>Enable Notifications</span>
<input type="checkbox" id="notificationsToggle">
</div>
</div>
<div class="settings-section">
<h2>Data Management</h2>
<div class="setting-item">
<i class="fas fa-database setting-icon"></i>
<button onclick="exportData()">Export Data</button>
</div>
<div class="setting-item">
<i class="fas fa-file-import setting-icon"></i>
<button onclick="importData()">Import Data</button>
</div>
</div>
</div>
</div>

<div id="tooltip" class="tooltip"></div>

<!-- Your JavaScript code -->
<script>
// Firebase configuration
const firebaseConfig = {
apiKey: "AIzaSyA8jrkF9TpIINymdXBDDI1yl4NuU_lsu7A",
authDomain: "isod-scheduler.firebaseapp.com",
projectId: "isod-scheduler",
storageBucket: "isod-scheduler.appspot.com",
messagingSenderId: "433265398148",
appId: "1:433265398148:web:d3fd3fe91692bd46c40dd1"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);

// Define global variables
let departments = [{
name: 'Transaction Monitoring',
abbr: 'TM'
},
{
name: 'Security Operation Center',
abbr: 'SOC2'
},
{
name: 'Fraud Desk',
abbr: 'FD'
}];
let shifts = [{
name: 'Morning',
start: '07:00',
end: '14:00',
minStaff: 15
},
{
name: 'Mid-Morning',
start: '10:00',
end: '17:00',
minStaff: 5
},
{
name: 'Afternoon',
start: '12:00',
end: '19:00',
minStaff: 14
},
{
name: 'Night',
start: '19:00',
end: '07:00',
minStaff: 8
}];
let staff = {};
let schedule = [];
let supervisors = new Set();
let weekdaySupervisors = new Set();
let weekendSupervisors = new Set();
let staffNotOnNightShift = new Set();
let staffOnLeave = {};
let staffLanguages = {};
let genderDistribution = {};
let staffPairRestrictions = [];
let pregnantStaff = {};
let currentEditingStaff = null;
let cycleStartDate = new Date();
let cycleEndDate = new Date(cycleStartDate);
cycleEndDate.setDate(cycleEndDate.getDate() + 28); // Default to 4 weeks
let previousGenerations = [];
let currentUser = null;
let activeUsers = new Set();
let onboardingPages = [
"Welcome to the ISOD Staff Scheduling System!",
"You can manage departments and shifts here.",
"Add staff members and set their preferences.",
"Generate schedules based on complex rules.",
"Thank you for using our system!"
];
let currentOnboardingPage = 0;

// Check if user is logged in
firebase.auth().onAuthStateChanged((user) => {
if (user) {
currentUser = user;
document.getElementById('loginForm').style.display = 'none';
document.getElementById('signUpForm').style.display = 'none';
document.getElementById('onboardingScreens').style.display = 'block';
document.getElementById('mainContent').style.display = 'none';
showOnboardingPage();
initializeApp();
updateActiveUsers(user.email, true);
} else {
document.getElementById('loginForm').style.display = 'block';
document.getElementById('signUpForm').style.display = 'none';
document.getElementById('mainContent').style.display = 'none';
}
});

// Skip login function
function skipLogin() {
currentUser = {
uid: 'guest'
}; // Use a guest UID
document.getElementById('loginForm').style.display = 'none';
document.getElementById('signUpForm').style.display = 'none';
document.getElementById('onboardingScreens').style.display = 'block';
document.getElementById('mainContent').style.display = 'block';
showOnboardingPage();
initializeApp();
}

// Onboarding functions
function showOnboardingPage() {
const content = document.getElementById('onboardingContent');
content.innerHTML = `<h2>${onboardingPages[currentOnboardingPage]}</h2>`;
}

function nextOnboarding() {
currentOnboardingPage++;
if (currentOnboardingPage >= onboardingPages.length) {
closeOnboarding();
} else {
showOnboardingPage();
}
}

function prevOnboarding() {
if (currentOnboardingPage > 0) {
currentOnboardingPage--;
showOnboardingPage();
}
}

function skipOnboarding() {
closeOnboarding();
}

function closeOnboarding() {
document.getElementById('onboardingScreens').style.display = 'none';
document.getElementById('mainContent').style.display = 'block';
}

// Login function
function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    checkIfCentaur(user);
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    initializeApp();
                })
                .catch((error) => {
                    showFancyAlert('Login failed: ' + error.message);
                });
        }

// Sign up function
function signUp() {
const email = document.getElementById('signUpEmail').value;
const password = document.getElementById('signUpPassword').value;
firebase.auth().createUserWithEmailAndPassword(email, password)
.catch((error) => {
showFancyAlert('Sign up failed: ' + error.message);
});
}

// Logout function
function logout() {
updateActiveUsers(currentUser.email, false);
firebase.auth().signOut().then(() => {
location.reload();
}).catch((error) => {
console.error('Logout failed:', error);
});
}

// Show sign up form
function showSignUpForm() {
document.getElementById('loginForm').style.display = 'none';
document.getElementById('signUpForm').style.display = 'block';
}

// Show login form
function showLoginForm() {
document.getElementById('loginForm').style.display = 'block';
document.getElementById('signUpForm').style.display = 'none';
}

// Update active users
function updateActiveUsers(userEmail, isActive) {
const usersRef = firebase.database().ref('activeUsers');
if (isActive) {
usersRef.child(btoa(userEmail)).set(true);
} else {
usersRef.child(btoa(userEmail)).remove();
}
}

// Listen for active users changes
function listenForActiveUsers() {
const usersRef = firebase.database().ref('activeUsers');
usersRef.on('value', (snapshot) => {
activeUsers.clear();
snapshot.forEach((childSnapshot) => {
activeUsers.add(atob(childSnapshot.key));
});
updateActiveUsersDisplay();
});
}

// Update active users display
function updateActiveUsersDisplay() {
const container = document.getElementById('activeUsers');
container.innerHTML = '<strong>Active Users:</strong> ';
activeUsers.forEach(user => {
const userSpan = document.createElement('span');
userSpan.className = 'active-user';
userSpan.textContent = user;
container.appendChild(userSpan);
});
}

// Initialize the application
function initializeApp() {
initializeDepartments();
initializeShifts();
populateDepartmentSelect();
updateSupervisorSelect();
listenForActiveUsers();

// Set initial dates for the cycle
document.getElementById('cycleStartDate').value = formatDateForInput(cycleStartDate);
document.getElementById('cycleEndDate').value = formatDateForInput(cycleEndDate);

// Add event listener for cycle date changes
document.getElementById('cycleStartDate').addEventListener('change', function() {
cycleStartDate = new Date(this.value);
if (cycleStartDate > cycleEndDate) {
cycleEndDate = new Date(cycleStartDate);
cycleEndDate.setDate(cycleEndDate.getDate() + (parseInt(document.getElementById('cycleDuration').value) * 7));
document.getElementById('cycleEndDate').value = formatDateForInput(cycleEndDate);
}
});

document.getElementById('cycleEndDate').addEventListener('change',
function() {
cycleEndDate = new Date(this.value);
if (cycleEndDate < cycleStartDate) {
cycleStartDate = new Date(cycleEndDate);
cycleStartDate.setDate(cycleStartDate.getDate() - (parseInt(document.getElementById('cycleDuration').value) * 7));
document.getElementById('cycleStartDate').value = formatDateForInput(cycleStartDate);
}
});

// Initialize dark mode toggle
document.getElementById('darkModeToggle').checked = document.body.classList.contains('dark-mode');

// Add settings option to hamburger menu
const settingsLink = document.createElement('a');
settingsLink.href = '#';
settingsLink.innerHTML = '<i class="fas fa-cog"></i> Settings';
settingsLink.onclick = showSettingsModal;
document.querySelector('.dropdown-content').appendChild(settingsLink);

// Initialize chat system
            document.getElementById('chatSystem').style.display = 'flex';

            // Add chat toggle button to the header
            const header = document.querySelector('.header');
            const chatToggle = document.createElement('button');
            chatToggle.innerHTML = '<i class="fas fa-comments"></i>';
            chatToggle.onclick = toggleChatSystem;
            header.appendChild(chatToggle);
}

// Function to format date for input fields
function formatDateForInput(date) {
return date.toISOString().split('T')[0];
}

// Initialize departments
function initializeDepartments() {
const departmentScroll = document.getElementById('departmentScroll');
departmentScroll.innerHTML = '';
departments.forEach(dept => {
const btn = document.createElement('span');
btn.className = 'scroll-item';
btn.textContent = dept.name;
btn.onclick = () => selectDepartment(dept.name);
departmentScroll.appendChild(btn);
});
}

// Populate department select dropdown
function populateDepartmentSelect() {
const departmentSelect = document.getElementById('departmentSelect');
departmentSelect.innerHTML = '<option value="">Select Department</option>';
departments.forEach(dept => {
const option = document.createElement('option');
option.value = dept.name;
option.textContent = dept.name;
departmentSelect.appendChild(option);
});
}

// Initialize shifts
function initializeShifts() {
const shiftScroll = document.getElementById('shiftScroll');
shiftScroll.innerHTML = '';
shifts.forEach(shift => {
const btn = document.createElement('span');
btn.className = 'scroll-item';
btn.textContent = `${shift.name} (${shift.start}-${shift.end})`;
btn.title = `Min Staff: ${shift.minStaff}`;
btn.onclick = () => editShift(shift);
shiftScroll.appendChild(btn);
});
}

// Add department
function addDepartment() {
const newDept = document.getElementById('newDepartment').value.trim();
const newAbbr = document.getElementById('newDepartmentAbbr').value.trim();
if (newDept && newAbbr && !departments.some(d => d.name.toLowerCase() === newDept.toLowerCase())) {
departments.push({
name: newDept, abbr: newAbbr
});
initializeDepartments();
populateDepartmentSelect();
document.getElementById('newDepartment').value = '';
document.getElementById('newDepartmentAbbr').value = '';
closeOverlay('addDepartmentOverlay');
saveToFirebase();
} else {
showFancyAlert("Invalid department details or department already exists.");
}
showTooltip('Department added successfully');
}

// Fix Close Overlay
function closeOverlay(overlayId) {
document.getElementById(overlayId).style.display = 'none';
}

// Add shift
function addShift() {
const name = document.getElementById('newShiftName').value.trim();
const start = document.getElementById('newShiftStart').value;
const end = document.getElementById('newShiftEnd').value;
const minStaff = parseInt(document.getElementById('newShiftMinStaff').value);
if (name && start && end && minStaff && !shifts.some(s => s.name.toLowerCase() === name.toLowerCase())) {
shifts.push({
name, start, end, minStaff
});
initializeShifts();
document.getElementById('newShiftName').value = '';
document.getElementById('newShiftStart').value = '';
document.getElementById('newShiftEnd').value = '';
document.getElementById('newShiftMinStaff').value = '';
closeOverlay('addShiftOverlay');
saveToFirebase();
} else {
showFancyAlert("Invalid shift details or shift already exists.");
}
showTooltip('Shift added successfully');
}

// Select department
function selectDepartment(dept) {
document.querySelectorAll('.scroll-item').forEach(btn => {
btn.classList.toggle('active', btn.textContent === dept);
});
updateStaffList();
}

// Edit shift
function editShift(shift) {
const newName = prompt('Enter new shift name:', shift.name);
const newStart = prompt('Enter new start time (HH:MM):', shift.start);
const newEnd = prompt('Enter new end time (HH:MM):', shift.end);
const newMinStaff = prompt('Enter new minimum staff:', shift.minStaff);
if (newName && newStart && newEnd && newMinStaff && !isNaN(newMinStaff)) {
shift.name = newName.trim();
shift.start = newStart;
shift.end = newEnd;
shift.minStaff = parseInt(newMinStaff);
initializeShifts();
updateScheduleTable();
saveToFirebase();
} else {
showFancyAlert("Invalid shift details.");
}
}

// Quick add staff
function quickAddStaff() {
const staffNames = document.getElementById('quickAddStaff').value.split(',').map(name => name.trim()).filter(name => name);
const department = document.getElementById('departmentSelect').value;
if (department && staffNames.length > 0) {
if (!staff[department]) staff[department] = [];
staffNames.forEach(name => {
if (name && !staff[department].some(s => s.name.toLowerCase() === name.toLowerCase())) {
staff[department].push({
name,
preferences: shifts.map(shift => ({
name: shift.name, days: 0
})),
gender: '',
role: 'n',
leaveDays: [],
weekendsOff: 0,
nightShifts: 0,
pregnantUntil: null,
languages: [],
maxConsecutiveNightShifts: 3
});
}
});
document.getElementById('quickAddStaff').value = '';
updateStaffList();
updateSupervisorSelect();
saveToFirebase();
} else {
showFancyAlert("Please select a department and enter valid staff names.");
}
showTooltip('Staff added successfully');
}

// Add individual staff via overlay
function addIndividualStaff() {
const name = document.getElementById('staffName').value.trim();
const gender = document.getElementById('staffGender').value;
const role = document.getElementById('staffRole').value;
const department = document.getElementById('departmentSelect').value;
const languages = document.getElementById('staffLanguage').value.trim().split(',').map(l => l.trim()).filter(l => l);
const pregnantUntil = document.getElementById('staffPregnantUntil').value ? new Date(document.getElementById('staffPregnantUntil').value): null;
const leaveStart = document.getElementById('staffLeaveStart').value ? new Date(document.getElementById('staffLeaveStart').value): null;
const leaveEnd = document.getElementById('staffLeaveEnd').value ? new Date(document.getElementById('staffLeaveEnd').value): null;

if (name && gender && role && department) {
if (!staff[department]) staff[department] = [];
if (!staff[department].some(s => s.name.toLowerCase() === name.toLowerCase())) {
staff[department].push({
name,
gender,
role,
preferences: shifts.map(shift => ({
name: shift.name, days: 0
})),
leaveDays: [],
weekendsOff: 0,
nightShifts: 0,
pregnantUntil,
languages,
maxConsecutiveNightShifts: 3
});
if (leaveStart && leaveEnd) {
const leaveDates = getDatesBetween(leaveStart, leaveEnd);
staff[department][staff[department].length - 1].leaveDays = leaveDates;
}
if (role === 's') {
supervisors.add(name);
weekdaySupervisors.add(name);
}
if (pregnantUntil) {
pregnantStaff[name] = pregnantUntil;
}
if (languages.length > 0) {
staffLanguages[name] = languages;
}
updateStaffList();
updateSupervisorSelect();
closeOverlay('addStaffOverlay');
saveToFirebase();
} else {
showFancyAlert("Staff member already exists in the selected department.");
}
} else {
showFancyAlert("Please fill in all staff details.");
}
showTooltip('Staff member added successfully');
}

// Add Individual Staff overlay
function showAddStaffOverlay() {
const overlay = document.getElementById('addStaffOverlay');
overlay.style.display = 'block';
}

// Prevent scrolling when settings modal is open
function showSettingsModal() {
document.getElementById('settingsModal').style.display = 'block';
document.body.style.overflow = 'hidden';
}
function closeSettingsModal() {
document.getElementById('settingsModal').style.display = 'none';
document.body.style.overflow = 'auto';
}

// Tooltip
function showTooltip(message) {
const tooltip = document.getElementById('tooltip');
tooltip.textContent = message;
tooltip.style.display = 'block';
setTimeout(() => {
tooltip.style.display = 'none';
}, 3000);
}

// Export Data
function exportData() {
const data = {
departments,
shifts,
staff,
schedule,
supervisors: Array.from(supervisors),
weekdaySupervisors: Array.from(weekdaySupervisors),
weekendSupervisors: Array.from(weekendSupervisors),
staffNotOnNightShift: Array.from(staffNotOnNightShift),
staffOnLeave,
staffLanguages,
genderDistribution,
staffPairRestrictions,
pregnantStaff,
cycleStartDate: cycleStartDate.toISOString(),
cycleEndDate: cycleEndDate.toISOString(),
previousGenerations
};
const dataStr = JSON.stringify(data);
const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
const exportFileDefaultName = 'isod_scheduler_data.json';

const linkElement = document.createElement('a');
linkElement.setAttribute('href', dataUri);
linkElement.setAttribute('download', exportFileDefaultName);
linkElement.click();
showTooltip('Data exported successfully');
}

// Import Data
function importData() {
const input = document.createElement('input');
input.type = 'file';
input.accept = '.json';
input.onchange = function(event) {
const file = event.target.files[0];
const reader = new FileReader();
reader.onload = function(e) {
const contents = e.target.result;
const data = JSON.parse(contents);
// Update your application state with the imported data
departments = data.departments;
shifts = data.shifts;
staff = data.staff;
schedule = data.schedule;
supervisors = new Set(data.supervisors);
weekdaySupervisors = new Set(data.weekdaySupervisors);
weekendSupervisors = new Set(data.weekendSupervisors);
staffNotOnNightShift = new Set(data.staffNotOnNightShift);
staffOnLeave = data.staffOnLeave;
staffLanguages = data.staffLanguages;
genderDistribution = data.genderDistribution;
staffPairRestrictions = data.staffPairRestrictions;
pregnantStaff = data.pregnantStaff;
cycleStartDate = new Date(data.cycleStartDate);
cycleEndDate = new Date(data.cycleEndDate);
previousGenerations = data.previousGenerations;

// Update UI
initializeDepartments();
initializeShifts();
populateDepartmentSelect();
updateStaffList();
updateSupervisorSelect();
updateScheduleTable();
updatePreviousGenerations();

showTooltip('Data imported successfully');
};
reader.readAsText(file);
};
input.click();
}




// Implement PiP-like feature for schedule table
function showScheduleModal() {
const modal = document.getElementById('scheduleModal');
const modalContent = document.getElementById('modalScheduleContainer');
modalContent.innerHTML = document.getElementById('scheduleTable').outerHTML;
modal.style.display = 'block';

// Close modal when clicking on <span> (x)
modal.querySelector('.close').onclick = function() {
modal.style.display = 'none';
}

// Close modal when clicking outside of it
window.onclick = function(event) {
if (event.target == modal) {
modal.style.display = 'none';
}
}
}

// Search and replace feature
function searchAndReplace() {
const searchTerm = document.getElementById('searchInput').value;
const replaceTerm = document.getElementById('replaceInput').value;
const table = document.getElementById('modalScheduleContainer').querySelector('table');
const cells = table.getElementsByTagName('td');

for (let i = 0; i < cells.length; i++) {
if (cells[i].textContent.includes(searchTerm)) {
cells[i].textContent = cells[i].textContent.replace(searchTerm, replaceTerm);
}
}

// Update the main schedule table
document.getElementById('scheduleTable').outerHTML = table.outerHTML;
updateScheduleFromTable();
}



// Update schedule array from table
function updateScheduleFromTable() {
const table = document.getElementById('scheduleTable');
const rows = table.getElementsByTagName('tr');
schedule = [];

for (let i = 1; i < rows.length; i++) {
// Start from 1 to skip header
const cells = rows[i].getElementsByTagName('td');
if (cells.length >= 4) {
const date = new Date(cells[0].textContent.split('-').reverse().join('-'));
const department = cells[2].textContent;

for (let j = 3; j < cells.length; j++) {
const shift = shifts[j - 3].name;
const staff = cells[j].textContent.split(',').map(s => s.trim()).filter(s => s);
if (staff.length > 0) {
schedule.push({
date,
department,
staff,
shift
});
}
}
}
}
saveToFirebase();
}

function zoomTable(zoomLevel) {
const table = document.querySelector('#modalScheduleContainer table');
table.style.transform = `scale(${zoomLevel / 100})`;
table.style.transformOrigin = 'top left';
document.getElementById('zoomValue').textContent = zoomLevel + '%';
}

// Get dates between two dates
function getDatesBetween(startDate, endDate) {
const dates = [];
let currentDate = new Date(startDate);
while (currentDate <= endDate) {
dates.push(formatDate(currentDate));
currentDate.setDate(currentDate.getDate() + 1);
}
return dates;
}

// Use default staff data
function useDefaultStaff() {
const defaultStaffData = `Abiodun,F,n;Adams,M,s;Adeleke,M,n;Adelodun,M,n;Adenike,F,s;Alimat,F,n;Basirat,F,n;Bolaji,M,s;Celestina,F,n;Dara,F,s;David,M,s;Esther,F,n;Etim,M,n;Gabriel,M,s;Gideon,M,n;Godwin,M,s;James,M,n;Jerry,M,n;Joshua,M,n;Kamilah,F,s;Kemi,F,n;Marho,F,n;Marvellous,F,n;Michael,M,n;Miracle,F,n;Olayemi,F,s;Opeyemi,M,s;Osato,F,n;Samuel,M,n;Solomon,M,s;Sophia,F,s;Stephen A.,M,s;Stephen E.,M,s;Tobi,F,s;Tosin,M,n;Wisdom,M,s;Yetunde,F,s;Zainab,F,n`;
staff = {};
const defaultDept = 'Transaction Monitoring';
staff[defaultDept] = [];
defaultStaffData.split(';').forEach(staffInfo => {
const [name, gender, role] = staffInfo.split(',');
const s = {
name,
gender,
role,
preferences: shifts.map(shift => ({
name: shift.name, days: 0
})),
leaveDays: [],
weekendsOff: 0,
nightShifts: 0,
pregnantUntil: null,
languages: [],
maxConsecutiveNightShifts: 3
};
staff[defaultDept].push(s);
if (role === 's') {
supervisors.add(name);
weekdaySupervisors.add(name);
}
});
updateStaffList();
updateSupervisorSelect();
saveToFirebase();
}

// Update staff list
function updateStaffList() {
const staffList = document.getElementById('staffList');
staffList.innerHTML = '';
Object.entries(staff).forEach(([dept, staffMembers]) => {
staffMembers.forEach((s, index) => {
const card = document.createElement('div');
card.className = 'staff-card';
card.innerHTML = `
<h3 class="${supervisors.has(s.name) ? 'supervisor': ''}">${s.name}</h3>
<p>Department: ${dept}</p>
<p>Gender: ${s.gender}</p>
<p>Role: ${s.role === 's' ? 'Supervisor': 'Normal'}</p>
<p>Preferences: ${s.preferences.map(p => `${p.name}: ${p.days} days`).join(', ')}</p>
<button onclick="editStaffPreferences('${dept}', ${index})">Edit Preferences</button>
<button onclick="deleteStaff('${dept}', ${index})">Delete</button>
<button onclick="resetStaff('${dept}', ${index})">Reset</button>
`;
staffList.appendChild(card);
});
});
}

// Edit staff preferences
function editStaffPreferences(dept, index) {
currentEditingStaff = {
dept, index
};
const s = staff[dept][index];
const overlay = document.getElementById('preferencesOverlay');
const content = document.getElementById('preferencesContent');
content.innerHTML = '';
s.preferences.forEach(pref => {
const prefContainer = document.createElement('div');
prefContainer.className = 'preference-container';
prefContainer.innerHTML = `
<label>${pref.name}: <span id="${pref.name}-value">${pref.days} days</span></label>
<input type="number" min="0" max="31" value="${pref.days}" class="preference-input" id="${pref.name}-input">
`;
content.appendChild(prefContainer);
const input = prefContainer.querySelector('.preference-input');
const valueSpan = prefContainer.querySelector(`#${pref.name}-value`);
input.oninput = function() {
valueSpan.textContent = this.value + ' days';
}
});
overlay.style.display = 'block';
}

// Save preferences
function savePreferences() {
const {
dept, index
} = currentEditingStaff;
const s = staff[dept][index];
s.preferences.forEach(pref => {
const input = document.getElementById(`${pref.name}-input`);
pref.days = parseInt(input.value);
});
updateStaffList();
closeOverlay('preferencesOverlay');
saveToFirebase();
}

// Delete staff
function deleteStaff(dept, index) {
if (confirm('Are you sure you want to delete this staff member?')) {
const deletedStaff = staff[dept].splice(index, 1)[0];
supervisors.delete(deletedStaff.name);
weekdaySupervisors.delete(deletedStaff.name);
weekendSupervisors.delete(deletedStaff.name);
staffNotOnNightShift.delete(deletedStaff.name);
updateStaffList();
updateSupervisorSelect();
saveToFirebase();
}
}

// Reset staff
function resetStaff(dept, index) {
if (confirm('Are you sure you want to reset this staff member\'s stats?')) {
const s = staff[dept][index];
s.workDays = 0;
s.nightShifts = 0;
s.weekendsWorked = 0;
updateStaffList();
saveToFirebase();
}
}

// Update supervisor select
function updateSupervisorSelect() {
const supervisorSelect = document.getElementById('supervisorSelect');
supervisorSelect.innerHTML = '';
Object.values(staff).flat().forEach(s => {
const option = document.createElement('div');
option.className = `supervisor-option ${supervisors.has(s.name) ? 'selected': ''}`;
option.textContent = s.name;
option.onclick = () => toggleSupervisor(s.name);
supervisorSelect.appendChild(option);
});
}

// Toggle supervisor
function toggleSupervisor(name) {
if (supervisors.has(name)) {
supervisors.delete(name);
weekdaySupervisors.delete(name);
weekendSupervisors.delete(name);
} else {
supervisors.add(name);
const isWeekendSupervisor = confirm('Should this supervisor be assigned to weekends primarily?');
if (isWeekendSupervisor) {
weekendSupervisors.add(name);
} else {
weekdaySupervisors.add(name);
}
}
updateSupervisorSelect();
updateStaffList();
saveToFirebase();
}

// Set supervisors
function setSupervisors() {
updateStaffList();
saveToFirebase();
}

// Set cycle duration
function setCycleDuration() {
const duration = parseInt(document.getElementById('cycleDuration').value);
cycleStartDate = new Date();
cycleEndDate = new Date(cycleStartDate);
cycleEndDate.setDate(cycleEndDate.getDate() + (duration * 7));
document.getElementById('cycleStartDate').value = formatDateForInput(cycleStartDate);
document.getElementById('cycleEndDate').value = formatDateForInput(cycleEndDate);
saveToFirebase();
}

// Generate schedule
function generateSchedule() {
if (Object.keys(staff).length === 0 || Object.values(staff).flat().length === 0) {
showFancyAlert("Please add staff members before generating the schedule.");
return;
}

schedule = [];
resetStaffStats();

const totalDays = Math.round((cycleEndDate - cycleStartDate) / (1000 * 60 * 60 * 24)) + 1;

for (let d = 0; d < totalDays; d++) {
const currentDate = new Date(cycleStartDate);
currentDate.setDate(cycleStartDate.getDate() + d);
const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;

departments.forEach(dept => {
if (staff[dept.name]) {
shifts.forEach(shift => {
const availableStaff = staff[dept.name].filter(s => canAssignStaff(s, currentDate, shift, isWeekend));
const selectedStaff = selectStaffForShift(availableStaff, shift, isWeekend, shift.minStaff);
schedule.push({
date: new Date(currentDate),
department: dept.name,
staff: selectedStaff.map(s => s.name),
shift: shift.name
});
selectedStaff.forEach(s => updateStaffStats(s, shift, isWeekend));
});
}
});
}

balanceSchedule();
updateScheduleTable();
savePreviousGeneration();
saveToFirebase();
showTooltip('Schedule generated successfully');
}

// Reset staff stats
function resetStaffStats() {
Object.values(staff).flat().forEach(s => {
s.workDays = 0;
s.nightShifts = 0;
s.weekendsWorked = 0;
s.consecutiveNightShifts = 0;
});
}

// Can assign staff
function canAssignStaff(staffMember, date, shift, isWeekend) {
const dateStr = formatDate(date);

// Check if staff is on leave
if (staffMember.leaveDays && staffMember.leaveDays.includes(dateStr)) return false;

// Check if staff is pregnant and cannot work night shifts
if (staffMember.pregnantUntil && date <= staffMember.pregnantUntil && shift.name === 'Night') return false;

// Some staff should not work night shifts
if (staffNotOnNightShift.has(staffMember.name) && shift.name === 'Night') return false;

// Check if staff has reached max consecutive night shifts
if (shift.name === 'Night' && staffMember.consecutiveNightShifts >= staffMember.maxConsecutiveNightShifts) return false;

// Check if staff has already worked today
const workedToday = schedule.some(entry =>
formatDate(entry.date) === dateStr &&
entry.staff.includes(staffMember.name)
);
if (workedToday) return false;

// Check if staff has days off
if (staffMember.daysOff && staffMember.daysOff.includes(dateStr)) return false;

// Check if staff has already worked maximum days in the week
const weekNumber = getWeekNumber(date);
const daysWorkedThisWeek = getDaysWorkedInWeek(staffMember, weekNumber);
if (daysWorkedThisWeek >= 5) return false;

// Avoid two people working together if in restrictions
for (let pair of staffPairRestrictions) {
if ((pair[0] === staffMember.name || pair[1] === staffMember.name)) {
const otherName = pair[0] === staffMember.name ? pair[1]: pair[0];
const otherAssigned = schedule.some(entry =>
formatDate(entry.date) === dateStr &&
entry.shift === shift.name &&
entry.staff.includes(otherName)
);
if (otherAssigned) return false;
}
}

return true;
}

// Get days worked in a week
function getDaysWorkedInWeek(staffMember, weekNumber) {
return schedule.filter(entry =>
getWeekNumber(entry.date) === weekNumber &&
entry.staff.includes(staffMember.name)
).length;
}

// Select staff for shift
function selectStaffForShift(availableStaff, shift, isWeekend, minStaff) {
let selectedStaff = [];

// Ensure there is a supervisor
const supervisorsAvailable = availableStaff.filter(s => supervisors.has(s.name));
if (supervisorsAvailable.length > 0) {
const supervisor = supervisorsAvailable[Math.floor(Math.random() * supervisorsAvailable.length)];
selectedStaff.push(supervisor);
availableStaff = availableStaff.filter(s => s.name !== supervisor.name);
}

// Fill the remaining slots
const remaining = minStaff - selectedStaff.length;
if (remaining > 0) {
const shuffled = availableStaff.sort(() => 0.5 - Math.random());
selectedStaff = selectedStaff.concat(shuffled.slice(0, remaining));
}

return selectedStaff;
}

// Update staff stats
function updateStaffStats(staffMember, shift, isWeekend) {
staffMember.workDays++;
if (shift.name === 'Night') {
staffMember.nightShifts++;
staffMember.consecutiveNightShifts++;
} else {
staffMember.consecutiveNightShifts = 0;
}
if (isWeekend) staffMember.weekendsWorked++;
}

// Balance Schedule
function balanceSchedule() {
const staffWorkload = {};

// Count the workload for each staff member
schedule.forEach(entry => {
entry.staff.forEach(staffName => {
if (!staffWorkload[staffName]) {
staffWorkload[staffName] = {
total: 0,
shifts: {}
};
}
staffWorkload[staffName].total++;
if (!staffWorkload[staffName].shifts[entry.shift]) {
staffWorkload[staffName].shifts[entry.shift] = 0;
}
staffWorkload[staffName].shifts[entry.shift]++;
});
});

// Find staff with too many or too few shifts
const averageWorkload = Object.values(staffWorkload).reduce((sum,
staff) => sum + staff.total, 0) / Object.keys(staffWorkload).length;
const overworkedStaff = Object.entries(staffWorkload).filter(([name,
workload]) => workload.total > averageWorkload * 1.2);
const underworkedStaff = Object.entries(staffWorkload).filter(([name,
workload]) => workload.total < averageWorkload * 0.8);

// Attempt to balance the schedule
overworkedStaff.forEach(([overworkedName,
overworkload]) => {
underworkedStaff.forEach(([underworkedName, underworkload]) => {
schedule.forEach(entry => {
if (entry.staff.includes(overworkedName) && !entry.staff.includes(underworkedName)) {
const index = entry.staff.indexOf(overworkedName);
entry.staff[index] = underworkedName;
staffWorkload[overworkedName].total--;
staffWorkload[underworkedName].total++;
if (staffWorkload[overworkedName].total <= averageWorkload * 1.1) {
return;
}
}
});
});
});

updateScheduleTable();
}

// Update schedule table
function updateScheduleTable() {
const table = document.getElementById('scheduleTable');
table.innerHTML = '';

// Add month title
const monthRow = table.insertRow();
const monthCell = monthRow.insertCell();
monthCell.colSpan = shifts.length + 3; // Date, Day, Department, Shifts
monthCell.style.textAlign = 'center';
monthCell.style.fontSize = '18px';
monthCell.textContent = `${cycleStartDate.toLocaleString('default', {
month: 'long'
})} - ${cycleEndDate.toLocaleString('default', {
month: 'long'
})} ${cycleEndDate.getFullYear()} Schedule`;

// Add table header
const headerRow = table.insertRow();
headerRow.innerHTML = `
<th>Date</th>
<th>Day</th>
<th>Department</th>
${shifts.map(s => `<th>${s.name}</th>`).join('')}
`;

// Add expand icon
const expandIcon = document.createElement('i');
expandIcon.className = 'fas fa-expand expand-icon';
expandIcon.onclick = showScheduleModal;
table.parentElement.insertBefore(expandIcon, table);

let currentWeek = null;
const groupedSchedule = groupScheduleByDateAndDepartment();

Object.entries(groupedSchedule).forEach(([dateKey, departments]) => {
const date = new Date(dateKey);

// Add week separator if needed
if (!currentWeek || getWeekNumber(date) !== getWeekNumber(currentWeek)) {
currentWeek = date;
let weekRow = table.insertRow();
let weekCell = weekRow.insertCell();
weekCell.colSpan = shifts.length + 3;
weekCell.className = 'week-separator';
weekCell.textContent = `Week ${getWeekNumber(date)}: ${getWeekRange(date)}`;
}

Object.entries(departments).forEach(([dept, shiftsData]) => {
let row = table.insertRow();
row.innerHTML = `
<td>${formatDate(date)}</td>
<td>${getDayName(date)}</td>
<td>${dept}</td>
${shifts.map(s => `
<td class="shift-cell" data-shift="${s.name}"
contenteditable="true"
oninput="updateScheduleStaff('${formatDate(date)}', '${dept}', '${s.name}', this)">
${formatStaffList(shiftsData[s.name] || [])}
</td>
`).join('')}
`;
});
});

addTotalsRow(table);
}

// Add totals row
function addTotalsRow(table) {
const totalsRow = table.insertRow();
totalsRow.className = 'totals-row';
const cells = shifts.length + 3;
for (let i = 0; i < cells; i++) {
const cell = totalsRow.insertCell();
if (i === 0) {
cell.textContent = 'Totals';
} else if (i > 2) {
const shiftName = shifts[i - 3].name;
const total = calculateShiftTotal(shiftName);
cell.textContent = total;
}
}
}

// Calculate shift total
function calculateShiftTotal(shiftName) {
return schedule.reduce((total, entry) => {
if (entry.shift === shiftName) {
return total + entry.staff.length;
}
return total;
},
0);
}

// Sort table
function sortTable(n) {
const table = document.getElementById('scheduleTable');
let switching = true;
let dir = 'asc';
let switchcount = 0;
while (switching) {
switching = false;
const rows = table.rows;
for (let i = 1; i < (rows.length - 1); i++) {
let shouldSwitch = false;
const x = rows[i].getElementsByTagName('TD')[n];
const y = rows[i + 1].getElementsByTagName('TD')[n];
if (dir === 'asc') {
if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
shouldSwitch = true;
break;
}
} else if (dir === 'desc') {
if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
shouldSwitch = true;
break;
}
}
}
if (shouldSwitch) {
rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
switching = true;
switchcount++;
} else {
if (switchcount === 0 && dir === 'asc') {
dir = 'desc';
switching = true;
}
}
}
}

// Select row
function selectRow(row) {
row.classList.toggle('selected');
}

// Highlight search results
function highlightSearchResults(searchTerm) {
const table = document.getElementById('scheduleTable');
const rows = table.getElementsByTagName('tr');
for (let i = 0; i < rows.length; i++) {
const cells = rows[i].getElementsByTagName('td');
for (let j = 0; j < cells.length; j++) {
const cellText = cells[j].innerText;
if (cellText.toLowerCase().includes(searchTerm.toLowerCase())) {
cells[j].innerHTML = cellText.replace(new RegExp(searchTerm, 'gi'), match => `<mark>${match}</mark>`);
}
}
}
}

// Group schedule by date and department
function groupScheduleByDateAndDepartment() {
return schedule.reduce((acc, entry) => {
const dateKey = formatDate(entry.date);
if (!acc[dateKey]) acc[dateKey] = {};
if (!acc[dateKey][entry.department]) acc[dateKey][entry.department] = {};
if (!acc[dateKey][entry.department][entry.shift]) acc[dateKey][entry.department][entry.shift] = [];
acc[dateKey][entry.department][entry.shift] = acc[dateKey][entry.department][entry.shift].concat(entry.staff);
return acc;
},
{});
}

// Format staff list
function formatStaffList(staffList) {
return staffList.map(name => {
const isSupervisor = supervisors.has(name);
return `<span class="staff-name ${isSupervisor ? 'supervisor': ''}" title="${name}">${name}</span>`;
}).join(', ');
}

// Get week range
function getWeekRange(date) {
let start = new Date(date);
start.setDate(start.getDate() - start.getDay() + 1); // Start from Monday
let end = new Date(start);
end.setDate(end.getDate() + 6);
return `${formatDate(start)} to ${formatDate(end)}`;
}

// Get week number
function getWeekNumber(date) {
const firstDayOfYear = new Date(date.getFullYear(),
0,
1);
const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
}

// Get day name
function getDayName(date) {
const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
return days[date.getDay()];
}

// Format date
function formatDate(date) {
if (!(date instanceof Date) || isNaN(date)) {
return 'Invalid Date';
}
return `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;
}

// Update schedule staff
function updateScheduleStaff(date, department, shift, element) {
const staffNames = element.textContent.split(',').map(name => name.trim()).filter(name => name);
schedule = schedule.filter(e => !(
formatDate(e.date) === date &&
e.department === department &&
e.shift === shift
));
if (staffNames.length > 0) {
schedule.push({
date: new Date(date.split('-').reverse().join('-')),
department,
staff: staffNames,
shift
});
}
saveToFirebase();

// Update progress bar
const shiftConfig = shifts.find(s => s.name === shift);
const minStaff = shiftConfig ? shiftConfig.minStaff: 1;
const staffRatio = staffNames.length / minStaff;
const progressBar = element.querySelector('.progress-bar');
if (!progressBar) {
const newProgressBar = document.createElement('div');
newProgressBar.className = 'progress-bar';
newProgressBar.innerHTML = `<div class="progress" style="width: ${staffRatio * 100}%;"></div>`;
element.appendChild(newProgressBar);
} else {
progressBar.querySelector('.progress').style.width = `${staffRatio * 100}%`;
}

// Change color based on staff ratio
const progressElement = progressBar ? progressBar.querySelector('.progress'): newProgressBar.querySelector('.progress');
if (staffRatio < 1) {
progressElement.style.backgroundColor = 'red';
} else if (staffRatio > 1) {
progressElement.style.backgroundColor = 'yellow';
} else {
progressElement.style.backgroundColor = 'green';
}
}

// Modified search function
function searchSchedule() {
const searchTerm = document.getElementById('searchInput').value.toLowerCase();
const tables = [
document.getElementById('scheduleTable'),
document.getElementById('modalScheduleContainer').querySelector('table')
];

tables.forEach(table => {
const rows = table.getElementsByTagName('tr');
for (let i = 1; i < rows.length; i++) {
const row = rows[i];
const cells = row.getElementsByTagName('td');
let found = false;

for (let j = 0; j < cells.length; j++) {
const cellText = cells[j].textContent.toLowerCase();
if (cellText.includes(searchTerm)) {
found = true;
break;
}
}

if (found) {
row.style.display = '';
highlightSearchTerm(row, searchTerm);
} else {
row.style.display = 'none';
}
}
});
}

function highlightSearchTerm(row, term) {
const cells = row.getElementsByTagName('td');
for (let i = 0; i < cells.length; i++) {
const cellText = cells[i].textContent;
cells[i].innerHTML = cellText.replace(new RegExp(term, 'gi'), match => `<mark>${match}</mark>`);
}
}
// Improved search functionality
let currentSearchIndex = -1;
let searchResults = [];

function findNext() {
const searchTerm = document.getElementById('searchInput').value.toLowerCase();
if (searchTerm === '') return;

const tables = [
document.getElementById('scheduleTable'),
document.getElementById('modalScheduleContainer').querySelector('table')
];

// Clear previous highlights
tables.forEach(table => {
const cells = table.getElementsByTagName('td');
for (let cell of cells) {
cell.classList.remove('highlight-cell');
}
});

if (searchResults.length === 0 || currentSearchIndex === -1) {
// Perform new search
searchResults = tables.flatMap(table =>
Array.from(table.getElementsByTagName('td')).filter(cell =>
cell.textContent.toLowerCase().includes(searchTerm)
)
);
currentSearchIndex = 0;
} else {
currentSearchIndex = (currentSearchIndex + 1) % searchResults.length;
}

if (searchResults.length > 0) {
const cell = searchResults[currentSearchIndex];
cell.classList.add('highlight-cell');
cell.scrollIntoView({
behavior: 'smooth', block: 'center'
});
updateSearchResults();
} else {
updateSearchResults('No results found');
}
}

// Modified findAll function

function findAll() {
const searchTerm = document.getElementById('searchInput').value.toLowerCase();
if (searchTerm === '') return;

const tables = [
document.getElementById('scheduleTable'),
document.getElementById('modalScheduleContainer').querySelector('table')
];

const resultsContainer = document.getElementById('findAllResults');
resultsContainer.innerHTML = '';

const uniqueResults = new Set();

tables.forEach(table => {
const cells = table.getElementsByTagName('td');
for (let cell of cells) {
if (cell.textContent.toLowerCase().includes(searchTerm)) {
const row = cell.closest('tr');
const date = row.cells[0].textContent;
const dept = row.cells[2].textContent;
const shift = row.cells[cell.cellIndex].textContent;
const resultKey = `${date}-${dept}-${shift}`;

if (!uniqueResults.has(resultKey)) {
uniqueResults.add(resultKey);
cell.classList.add('highlight-cell');

const resultItem = document.createElement('div');
resultItem.textContent = `${date} - ${dept} - ${shift}`;
resultItem.onclick = () => {
cell.scrollIntoView({
behavior: 'smooth', block: 'center'
});
};
resultsContainer.appendChild(resultItem);
}
}
}
});

if (uniqueResults.size > 0) {
resultsContainer.style.display = 'block';
updateSearchResults(`${uniqueResults.size} unique results found`);
} else {
resultsContainer.style.display = 'none';
updateSearchResults('No results found');
}
}

// New function to toggle chat bar
function toggleChatBar() {
const chatBar = document.getElementById('chatBar');
chatBar.classList.toggle('open');
}


// New function to send a message
function sendMessage() {
const input = document.getElementById('chatInput');
const message = input.value.trim();
if (message) {
const chatMessages = document.getElementById('chatMessages');
const messageElement = document.createElement('div');
messageElement.textContent = message;
chatMessages.appendChild(messageElement);
input.value = '';
chatMessages.scrollTop = chatMessages.scrollHeight;
}
}



function updateSearchResults(message) {
const resultsSpans = document.querySelectorAll('#searchResults');
resultsSpans.forEach(span => {
span.textContent = message || `Result ${currentSearchIndex + 1} of ${searchResults.length}`;
});
}
// New functions for About and Share
// Update the showAboutInfo and closeAboutOverlay functions
function showAboutInfo() {
document.getElementById('aboutOverlay').classList.add('active');
}

function closeAboutOverlay() {
document.getElementById('aboutOverlay').classList.remove('active');
document.getElementById('settingsModal').style.display = 'none';
}

function shareSchedule() {
// Implement sharing functionality here
showFancyAlert('Sharing functionality to be implemented');
}

// Update the showAddDepartmentOverlay and showAddShiftOverlay functions
function showAddDepartmentOverlay() {
document.getElementById('addDepartmentOverlay').style.display = 'block';
}

function showAddShiftOverlay() {
document.getElementById('addShiftOverlay').style.display = 'block';
}

// Save previous generation
function savePreviousGeneration() {
const generationSnapshot = JSON.parse(JSON.stringify(schedule));
previousGenerations.unshift(generationSnapshot);
if (previousGenerations.length > 5) {
previousGenerations.pop();
}
updatePreviousGenerations();
}

// Update previous generations
function updatePreviousGenerations() {
const container = document.getElementById('previousGenerations');
container.innerHTML = '';
previousGenerations.forEach((gen, index) => {
const item = document.createElement('div');
item.className = 'generation-item';
item.innerHTML = `Generation ${index + 1}`;
const trashIcon = document.createElement('i');
trashIcon.className = 'fas fa-trash trash-icon';
trashIcon.onclick = (e) => {
e.stopPropagation();
deletePreviousGeneration(index);
};
item.appendChild(trashIcon);
item.onclick = () => loadPreviousGeneration(index);
container.appendChild(item);
});
}

// Delete previous generation
function deletePreviousGeneration(index) {
previousGenerations.splice(index, 1);
updatePreviousGenerations();
saveToFirebase();
}

// Load previous generation
function loadPreviousGeneration(index) {
schedule = JSON.parse(JSON.stringify(previousGenerations[index]));
updateScheduleTable();
saveToFirebase();
}

// Reset all staff
function resetAllStaff() {
if (confirm('Are you sure you want to reset all staff schedules?')) {
Object.values(staff).flat().forEach(staffMember => {
staffMember.workDays = 0;
staffMember.nightShifts = 0;
staffMember.weekendsWorked = 0;
});

schedule = [];
updateScheduleTable();
saveToFirebase();
}
}

// Save to Firebase
function saveToFirebase() {
if (!currentUser) {
console.error('No user logged in');
return;
}
const data = {
departments,
shifts,
staff,
schedule,
supervisors: Array.from(supervisors),
weekdaySupervisors: Array.from(weekdaySupervisors),
weekendSupervisors: Array.from(weekendSupervisors),
staffNotOnNightShift: Array.from(staffNotOnNightShift),
staffOnLeave,
staffLanguages,
genderDistribution,
staffPairRestrictions,
pregnantStaff,
cycleStartDate: cycleStartDate.toISOString(),
cycleEndDate: cycleEndDate.toISOString(),
previousGenerations
};
firebase.database().ref('schedules/' + currentUser.uid).set(data)
.then(() => console.log('Data saved successfully'))
.catch((error) => console.error('Error saving data:', error));
showTooltip('Data saved to Firebase');
}

// Load from Firebase
function loadFromFirebase() {
if (!currentUser) {
console.error('No user logged in');
return;
}
firebase.database().ref('schedules/' + currentUser.uid).once('value')
.then((snapshot) => {
const data = snapshot.val();
if (data) {
departments = data.departments;
shifts = data.shifts;
staff = data.staff;
schedule = data.schedule;
supervisors = new Set(data.supervisors);
weekdaySupervisors = new Set(data.weekdaySupervisors);
weekendSupervisors = new Set(data.weekendSupervisors);
staffNotOnNightShift = new Set(data.staffNotOnNightShift);
staffOnLeave = data.staffOnLeave || {};
staffLanguages = data.staffLanguages || {};
genderDistribution = data.genderDistribution || {};
staffPairRestrictions = data.staffPairRestrictions || [];
pregnantStaff = data.pregnantStaff || {};
cycleStartDate = new Date(data.cycleStartDate);
cycleEndDate = new Date(data.cycleEndDate);
previousGenerations = data.previousGenerations || [];

initializeDepartments();
initializeShifts();
populateDepartmentSelect();
updateStaffList();
updateSupervisorSelect();
updateScheduleTable();
updatePreviousGenerations();

document.getElementById('cycleStartDate').value = formatDateForInput(cycleStartDate);
document.getElementById('cycleEndDate').value = formatDateForInput(cycleEndDate);

console.log('Data loaded successfully');
} else {
console.log('No data found');
}
})
.catch((error) => console.error('Error loading data:', error));
showTooltip('Data loaded from Firebase');
}

// Export Excel
function exportExcel() {
const wb = XLSX.utils.book_new();
const ws_data = [
['Date', 'Day', 'Department', ...shifts.map(s => `${s.name} (${s.minStaff})`)]
];

const groupedSchedule = schedule.reduce((acc, entry) => {
const key = `${formatDate(entry.date)}-${entry.department}`;
if (!acc[key]) acc[key] = {
date: entry.date,
department: entry.department,
shifts: {}
};
if (!acc[key].shifts[entry.shift]) acc[key].shifts[entry.shift] = [];
acc[key].shifts[entry.shift] = acc[key].shifts[entry.shift].concat(entry.staff);
return acc;
},
{});

Object.values(groupedSchedule).forEach(entry => {
const dayName = getDayName(entry.date);
const row = [
formatDate(entry.date),
dayName,
entry.department,
...shifts.map(s => entry.shifts[s.name] ? entry.shifts[s.name].join(', '): '')
];
ws_data.push(row);
});

const ws = XLSX.utils.aoa_to_sheet(ws_data);
XLSX.utils.book_append_sheet(wb,
ws,
"Schedule");
XLSX.writeFile(wb,
"ISOD_Schedule.xlsx");
}

// Import Excel
function importExcel() {
const file = document.getElementById('excelFile').files[0];
if (!file) {
showFancyAlert("Please select an Excel file to import.");
return;
}
const reader = new FileReader();
reader.onload = function(e) {
const data = new Uint8Array(e.target.result);
const workbook = XLSX.read(data, {
type: 'array'
});
const sheetName = workbook.SheetNames[0];
const worksheet = workbook.Sheets[sheetName];
const jsonData = XLSX.utils.sheet_to_json(worksheet, {
header: 1
});

schedule = [];
supervisors.clear();
weekdaySupervisors.clear();

// Reset staff based on departments
Object.keys(staff).forEach(dept => {
staff[dept] = [];
});

// Process schedule data
for (let i = 1; i < jsonData.length; i++) {
const row = jsonData[i];
if (row && row.length >= 4) {
const dateStr = row[0];
const dayName = row[1];
const dept = row[2];
const dateParts = dateStr.split('-');
const date = new Date(`${dateParts[1]}-${dateParts[0]}-${dateParts[2]}`);
shifts.forEach((shift, index) => {
const staffNames = row[3 + index] ? row[3 + index].split(',').map(s => s.trim()): [];
staffNames.forEach(name => {
if (name) {
if (!staff[dept].some(s => s.name.toLowerCase() === name.toLowerCase())) {
// Add new staff if not exists
staff[dept].push({
name,
preferences: shifts.map(s => ({
name: s.name, days: 0
})),
gender: '',
role: 'n',
leaveDays: [],
weekendsOff: 0,
nightShifts: 0,
pregnantUntil: null,
languages: [],
maxConsecutiveNightShifts: 3
});
}
// Assign role based on existing supervisor list
const staffMember = staff[dept].find(s => s.name.toLowerCase() === name.toLowerCase());
if (supervisors.has(staffMember.name)) {
staffMember.role = 's';
weekdaySupervisors.add(staffMember.name);
}
schedule.push({
date,
department: dept,
staff: [name],
shift: shift.name
});
}
});
});
}
}

updateStaffList();
updateSupervisorSelect();
updateScheduleTable();
closeOverlay('importOverlay');
saveToFirebase();
};
reader.readAsArrayBuffer(file);
}

// Capture table image
function captureTableImage() {
html2canvas(document.getElementById('scheduleTable')).then(canvas => {
const link = document.createElement('a');
link.download = 'schedule_table.png';
link.href = canvas.toDataURL();
link.click();
});
}

// Generate PDF
function generatePDF() {
const element = document.getElementById('scheduleTable');
html2pdf()
.from(element)
.save('schedule.pdf');
}

// Batch update
function batchUpdate() {
const field = document.getElementById('batchUpdateField').value;
const value = document.getElementById('batchUpdateValue').value;
const selectedRows = Array.from(document.querySelectorAll('#scheduleTable tr.selected'));

if (selectedRows.length === 0) {
showFancyAlert("Please select rows to update.");
return;
}

selectedRows.forEach(row => {
const date = row.cells[0].textContent;
const department = row.cells[2].textContent;

schedule.forEach(entry => {
if (formatDate(entry.date) === date && entry.department === department) {
if (field === 'shift') {
entry.shift = value;
} else if (field === 'department') {
entry.department = value;
}
}
});
});

updateScheduleTable();
saveToFirebase();
document.getElementById('batchUpdateMessage').textContent = `Updated ${selectedRows.length} rows`;
}

function showTab(tabName) {
const tabs = document.getElementsByClassName('tab-content');
for (let tab of tabs) {
tab.style.display = 'none';
}
document.getElementById(tabName + 'Tab').style.display = 'block';

const buttons = document.getElementsByClassName('tab-button');
for (let button of buttons) {
button.classList.remove('active');
}
event.target.classList.add('active');

if (tabName === 'stats') {
generateStats();
}
}


// Modified generateStats function
function generateStats() {
const statsTab = document.getElementById('statsTab');
statsTab.innerHTML = '<h2>Schedule Statistics</h2>';

const iframe = document.createElement('iframe');
iframe.className = 'stats-iframe';
statsTab.appendChild(iframe);

const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
iframeDoc.body.innerHTML = `
<table class="stats-table">
<thead>
<tr>
<th>Name</th>
<th>Weekend Offs</th>
<th>Morning</th>
<th>Mid-Morning</th>
<th>Afternoon</th>
<th>Night</th>
<th>Action</th>
</tr>
</thead>
<tbody id="statsTableBody"></tbody>
</table>
`;

const staffStats = calculateStaffStats();
const tableBody = iframeDoc.getElementById('statsTableBody');

for (const [staffName, stats] of Object.entries(staffStats)) {
const row = iframeDoc.createElement('tr');
row.innerHTML = `
<td>${staffName}</td>
<td>${stats.weekendOffs}</td>
<td>${stats.morningShifts}</td>
<td>${stats.midMorningShifts}</td>
<td>${stats.afternoonShifts}</td>
<td>${stats.nightShifts}</td>
<td><button class="refix-button" onclick="parent.refixStaff('${staffName}')">Refix</button></td>
`;
tableBody.appendChild(row);
}

// Apply styles to the iframe content
const style = iframeDoc.createElement('style');
style.textContent = `
body { font-family: Arial, sans-serif; font-size: 12px; }
.stats-table { width: 100%; border-collapse: collapse; }
.stats-table th, .stats-table td { border: 1px solid #ddd; padding: 5px; text-align: center; }
.stats-table tr:nth-child(even) { background-color: #f2f2f2; }
.refix-button { background-color: #4CAF50; color: white; border: none; padding: 2px 5px; cursor: pointer; font-size: 10px; }
`;
iframeDoc.head.appendChild(style);
}

// New function to refix individual staff schedule
function refixStaff(staffName) {
// Implement the logic to refix the schedule for the specific staff member
console.log(`Refixing schedule for ${staffName}`);
// You can add your refixing logic here
showFancyAlert(`Schedule refixed for ${staffName}`);
generateStats(); // Regenerate stats after refixing
}

// Modified calculateStaffStats function
function calculateStaffStats() {
const staffStats = {};

schedule.forEach(entry => {
const date = new Date(entry.date);
const isWeekend = date.getDay() === 0 || date.getDay() === 6;

entry.staff.forEach(staffName => {
if (!staffStats[staffName]) {
staffStats[staffName] = {
weekendOffs: 0,
morningShifts: 0,
midMorningShifts: 0,
afternoonShifts: 0,
nightShifts: 0
};
}

if (isWeekend && !entry.staff.includes(staffName)) {
staffStats[staffName].weekendOffs++;
}

switch (entry.shift) {
case 'Morning':
staffStats[staffName].morningShifts++;
break;
case 'Mid-Morning':
staffStats[staffName].midMorningShifts++;
break;
case 'Afternoon':
staffStats[staffName].afternoonShifts++;
break;
case 'Night':
staffStats[staffName].nightShifts++;
break;
}
});
});

return staffStats;
}


function fixSchedule() {
// Implement schedule fixing logic here
// This could involve reassigning staff to their preferred shifts
// and ensuring each staff member works their required number of days
showFancyAlert('Schedule fixing functionality to be implemented');
}


// Show feedback form
function showFeedbackForm() {
document.getElementById('feedbackContainer').style.display = 'block';
}

// Close feedback form
function closeFeedbackForm() {
document.getElementById('feedbackContainer').style.display = 'none';
}

// Submit feedback
function submitFeedback() {
const feedback = document.getElementById('feedbackText').value;
if (feedback.trim() === '') {
showFancyAlert('Please enter your feedback before submitting.');
return;
}
// Here you would typically send the feedback to a server
console.log('Feedback submitted:', feedback);
showFancyAlert('Thank you for your feedback!');
closeFeedbackForm();
}

function toggleChatVisibility() {
    const chatContent = document.getElementById('chatContent');
    chatContent.style.display = chatContent.style.display === 'none' ? 'block' : 'none';
}

// Replace showFancyAlert() calls with this function
function showWarning(message) {
const warningContainer = document.getElementById('warningContainer');
const warningElement = document.createElement('div');
warningElement.className = 'warning';
warningElement.textContent = message;
warningContainer.appendChild(warningElement);

// Remove the warning after 5 seconds
setTimeout(() => {
warningContainer.removeChild(warningElement);
}, 5000);
}

// Start tutorial
function startTutorial() {
const tour = new Shepherd.Tour({
defaultStepOptions: {
cancelIcon: {
enabled: true
},
classes: 'shepherd-theme-arrows'
}
});

tour.addStep({
id: 'welcome',
text: 'Welcome to the ISOD Staff Scheduling System! Let\'s take a quick tour.',
buttons: [{
text: 'Next',
action: tour.next
}]
});

tour.addStep({
id: 'departments',
text: 'Here you can manage departments and shifts.',
attachTo: {
element: '.department-shift-container',
on: 'bottom'
},
buttons: [{
text: 'Back',
action: tour.back
},
{
text: 'Next',
action: tour.next
}]
});

tour.addStep({
id: 'staff',
text: 'Add and manage staff members here.',
attachTo: {
element: '#staffList',
on: 'top'
},
buttons: [{
text: 'Back',
action: tour.back
},
{
text: 'Next',
action: tour.next
}]
});

tour.addStep({
id: 'schedule',
text: 'Generate and view the schedule in this section.',
attachTo: {
element: '.schedule-container',
on: 'top'
},
buttons: [{
text: 'Back',
action: tour.back
},
{
text: 'Finish',
action: tour.complete
}]
});

tour.start();
}

// Add this to your JavaScript
const greetings = [
"Have a great day!",
"Smile and shine!",
"Make today amazing!",
"Embrace the day's potential!",
"Spread positivity today!"
];

function updateGreeting() {
const dateElement = document.getElementById('currentDate');
const messageElement = document.getElementById('greetingMessage');
const now = new Date();

dateElement.textContent = now.toLocaleDateString('en-US', {
month: 'short', day: 'numeric'
});
messageElement.textContent = greetings[Math.floor(Math.random() * greetings.length)];
}

function toggleGreeting() {
const carousel = document.querySelector('.greeting-carousel');
carousel.style.display = carousel.style.display === 'none' ? 'flex': 'none';
}

// Call this function to initialize the greeting
updateGreeting();

// Update the greeting every day
setInterval(updateGreeting, 24 * 60 * 60 * 1000);

// Add event listener to the toggle button
document.querySelector('.greeting-toggle').addEventListener('click',
toggleGreeting);

// Initialize the application when the page loads
window.onload = function() {
// Check if the user is already logged in
firebase.auth().onAuthStateChanged(function(user) {
if (user) {
// User is signed in, show main content
document.getElementById('mainContent').style.display = 'block';
document.getElementById('loginForm').style.display = 'none';
initializeApp();
} else {
// No user is signed in, show login form
document.getElementById('mainContent').style.display = 'none';
document.getElementById('loginForm').style.display = 'block';
document.getElementById('loginModal').style.display
= 'block';
}
});
};

const adImages = [
"https://pfst.cf2.poecdn.net/base/image/0dc9069000123086cea600dd48bb1e9c59766d8d873109a5eb96ed96553a2349?w=1024&h=768&pmaid=168860672",
"https://pfst.cf2.poecdn.net/base/image/bae8681671aba1845ac587399689943d567687de1c4df4317384bfedb6e1c53b?w=1024&h=768&pmaid=168863441",
"https://pfst.cf2.poecdn.net/base/image/485b98d01ef23589bb782e148f9f084e0601d8d2880fc17deda75cf593f25fc5?w=1024&h=768&pmaid=168882048",
"https://pfst.cf2.poecdn.net/base/image/6a40a073a53e45474602419238321bc5276afcfc330eab1216a9c75bcc95d1f9?w=1024&h=768&pmaid=168890364",
"https://pfst.cf2.poecdn.net/base/image/bf65121a4356296cc3b921a827627b873ebd46de6e7ad1b2d7ead78832fb3731?w=1024&h=768&pmaid=168898041"
];

let currentAdIndex = 0;

function initAdCarousel() {
const adContainer = document.querySelector('.ad-container');
adImages.forEach((src, index) => {
const img = document.createElement('img');
img.src = src;
img.style.display = index === 0 ? 'block': 'none';
adContainer.appendChild(img);
});

setInterval(nextAd,
5000); // Change ad every 5 seconds
}

function nextAd() {
const adContainer = document.querySelector('.ad-container');
const ads = adContainer.querySelectorAll('img');
ads[currentAdIndex].style.display = 'none';
currentAdIndex = (currentAdIndex + 1) % ads.length;
ads[currentAdIndex].style.display = 'block';
}

document.querySelector('.ad-button').addEventListener('click', () => {
// Add your ad click functionality here
showFancyAlert('Ad clicked!');
});

initAdCarousel();

// Add dark mode toggle to hamburger menu
function addDarkModeToggle() {
const dropdownContent = document.querySelector('.dropdown-content');
const darkModeLink = document.createElement('a');
darkModeLink.href = '#';
darkModeLink.innerHTML = '<i class="fas fa-moon"></i> Toggle Dark Mode';
darkModeLink.onclick = toggleDarkMode;
dropdownContent.appendChild(darkModeLink);
}

// Call this function after the page loads
window.addEventListener('load', addDarkModeToggle);


// New UI feature: Dark mode toggle
// Modify toggleDarkMode function
// Modify the existing toggleDarkMode function
function toggleDarkMode() {
document.body.classList.toggle('dark-mode');
const isDarkMode = document.body.classList.contains('dark-mode');
localStorage.setItem('darkMode',
isDarkMode);

// Update checkbox in settings
document.getElementById('darkModeToggle').checked = isDarkMode;

showTooltip(isDarkMode ? 'Dark mode enabled': 'Dark mode disabled');
}

// Check for saved dark mode preference
// Initialize dark mode
if (localStorage.getItem('darkMode') === 'true') {
document.body.classList.add('dark-mode');
}

// Add dark mode toggle button to the UI
/*const darkModeButton = document.createElement('button');
darkModeButton.textContent = 'Toggle Dark Mode';
darkModeButton.onclick = toggleDarkMode;
document.body.appendChild(darkModeButton);*/

// Make sure to call these functions to initialize new features
document.addEventListener('DOMContentLoaded',
function() {
/*
            // Add chat toggle button to the header
            const header = document.querySelector('.header');
            const chatToggle = document.createElement('button');
            chatToggle.innerHTML = '<i class="fas fa-comments"></i>';
            chatToggle.onclick = toggleChatBar;
            header.appendChild(chatToggle);*/

initAdCarousel();
updateGreeting();
setInterval(updateGreeting, 24 * 60 * 60 *
1000); // Update greeting daily

// Initialize other features...
});

   const greetingAdCarousel = document.getElementById('greetingAdCarousel');
        const carouselItems = [];

        function initGreetingAdCarousel() {
            adImages.forEach((src, index) => {
                const item = document.createElement('div');
                item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                item.innerHTML = `
                    <img src="${src}" class="carousel-image" alt="Greeting ${index + 1}">
                    <div class="greeting-overlay">
                        <div class="greeting-date" id="greetingDate${index}"></div>
                        <div class="greeting-message">${greetings[index]}</div>
                    </div>
                `;
                greetingAdCarousel.appendChild(item);
                carouselItems.push(item);
            });

            const dots = document.createElement('div');
            dots.className = 'carousel-dots';
            adImages.forEach((_, index) => {
                const dot = document.createElement('div');
                dot.className = `dot ${index === 0 ? 'active' : ''}`;
                dot.onclick = () => goToSlide(index);
                dots.appendChild(dot);
            });
            greetingAdCarousel.appendChild(dots);

            updateGreetingDates();
            setInterval(nextSlide, 5000);
        }

        function updateGreetingDates() {
            const now = new Date();
            carouselItems.forEach((item, index) => {
                const dateElement = item.querySelector(`#greetingDate${index}`);
                dateElement.textContent = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
        }

        let currentSlide = 0;

        function nextSlide() {
            goToSlide((currentSlide + 1) % carouselItems.length);
        }

        function goToSlide(n) {
            carouselItems[currentSlide].classList.remove('active');
            document.querySelectorAll('.dot')[currentSlide].classList.remove('active');
            currentSlide = n;
            carouselItems[currentSlide].classList.add('active');
            document.querySelectorAll('.dot')[currentSlide].classList.add('active');
        }

        function toggleForums() {
            document.getElementById('forumsPanel').classList.toggle('open');
        }

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('open');
        }

        function sendMessage() {
            const input = document.getElementById('forumsInput');
            const message = input.value.trim();
            if (message) {
                const messagesContainer = document.getElementById('forumsMessages');
                const messageElement = document.createElement('div');
                messageElement.textContent = message;
                messagesContainer.appendChild(messageElement);
                input.value = '';
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
         // Check if user is a Centaur
        function checkIfCentaur(user) {
            firebase.database().ref('centaurs/' + user.uid).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        user.isCentaur = true;
                        showFancyAlert('Welcome, Centaur!');
                        addCentaurBadge();
                    }
                });
        }

        // Add Centaur badge to the UI
        function addCentaurBadge() {
            const badge = document.createElement('span');
            badge.className = 'centaur-badge';
            badge.textContent = 'Centaur';
            document.querySelector('.header').appendChild(badge);
        }

        // Chat system functions
        function toggleChatSystem() {
            const chatSystem = document.getElementById('chatSystem');
            chatSystem.style.display = chatSystem.style.display === 'none' ? 'flex' : 'none';
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageElement = document.createElement('div');
                messageElement.textContent = message;
                messagesContainer.appendChild(messageElement);
                input.value = '';
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // If the user is a Centaur and the message starts with "/push", treat it as a push notification
                if (currentUser.isCentaur && message.startsWith('/push')) {
                    sendPushNotification(message.slice(6));
                }
            }
        }

        // Send push notification (for Centaurs)
        function sendPushNotification(message) {
            // In a real-world scenario, you'd send this to a server to handle push notifications
            // For this example, we'll just show it as a fancy alert
            showFancyAlert('Push Notification Sent: ' + message);
        }

        // Fancy Alert function
        function showFancyAlert(message) {
            const alertBox = document.getElementById('fancyAlert');
            alertBox.textContent = message;
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 3000);
        }


        function startVoiceInput() {
            // Implement voice input functionality here
            showFancyAlert('Voice input feature to be implemented');
        }

        // Initialize the greeting-ad carousel when the page loads
        window.addEventListener('load', initGreetingAdCarousel);


</script>
</body>
</html>
